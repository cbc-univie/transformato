<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>transformato.state &mdash; transformato  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=31edadca" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=8209df7b" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=bbec6902"></script>
        <script src="../../_static/documentation_options.js?v=8ce96065"></script>
        <script src="../../_static/doctools.js?v=92e14aea"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/logo_transformato.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../whatistransformato.html">Theoretical background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../System_Setup.html">System Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Additional_Settings.html">Additional Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Running_Simulation.html">Running Simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Analysis.html">Trajectory Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">transformato</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">transformato.state</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for transformato.state</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">parmed</span> <span class="k">as</span> <span class="nn">pm</span>

<span class="kn">import</span> <span class="nn">transformato</span>
<span class="kn">from</span> <span class="nn">transformato.charmm_factory</span> <span class="kn">import</span> <span class="n">CharmmFactory</span>
<span class="kn">from</span> <span class="nn">transformato.mutate</span> <span class="kn">import</span> <span class="n">Mutation</span>
<span class="kn">from</span> <span class="nn">transformato.restraints</span> <span class="kn">import</span> <span class="n">write_restraints_yaml</span>
<span class="kn">from</span> <span class="nn">transformato.utils</span> <span class="kn">import</span> <span class="n">get_toppar_dir</span><span class="p">,</span> <span class="n">psf_correction</span><span class="p">,</span> <span class="n">check_switching_function</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="IntermediateStateFactory">
<a class="viewcode-back" href="../../autosummary/transformato.state.html#transformato.state.IntermediateStateFactory">[docs]</a>
<span class="k">class</span> <span class="nc">IntermediateStateFactory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="IntermediateStateFactory.__init__">
<a class="viewcode-back" href="../../autosummary/transformato.state.html#transformato.state.IntermediateStateFactory.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">system</span><span class="p">:</span> <span class="n">transformato</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">SystemStructure</span><span class="p">,</span>
        <span class="n">configuration</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">multiple_runs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the intermediate directories with for the provided systems with the provided mutations.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system : transformato.system</span>
<span class="sd">            definition of the two states for a given system (either waterbox and vacuum or waterbox and complex)</span>
<span class="sd">        mutation_list : list</span>
<span class="sd">            list of mutations defined by the transformato.ProposeMutationRoute object</span>
<span class="sd">        configuration : dict</span>
<span class="sd">            configuration dictionary</span>
<span class="sd">        multiple_runs : bool or int</span>
<span class="sd">            defines how many runs should be performed per intst state, if not used it is 0 (=False) else give an integer number</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;system_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span> <span class="o">=</span> <span class="n">configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_base_dir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vdw_switch</span><span class="p">:</span> <span class="nb">str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charmm_factory</span> <span class="o">=</span> <span class="n">CharmmFactory</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiple_runs</span> <span class="o">=</span> <span class="n">multiple_runs</span></div>


    <span class="k">def</span> <span class="nf">endstate_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Will create script for endstate correction&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">/../endstate_correction&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Folder for endstate correction exist already&quot;</span><span class="p">)</span>

        <span class="c1"># copy submit script to the newly created folder</span>
        <span class="n">submit_switching_script_source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;bin_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/slurm_switching.sh&quot;</span>
        <span class="p">)</span>
        <span class="n">submit_switchting_script_target</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">/../endstate_correction/slurm_switching.sh&quot;</span>
        <span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">submit_switching_script_source</span><span class="p">,</span> <span class="n">submit_switchting_script_target</span><span class="p">)</span>

        <span class="c1"># modify the perform_correction file from transformato bin and save it in the endstate_correcition folder</span>
        <span class="n">endstate_correction_script_source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;bin_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/perform_correction.py&quot;</span>
        <span class="p">)</span>
        <span class="n">endstate_correction_script_target</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">/../endstate_correction/perform_correction.py&quot;</span>
        <span class="p">)</span>
        <span class="n">fin</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">endstate_correction_script_source</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span>
        <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">endstate_correction_script_target</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;NAMEofSYSTEM&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s2">&quot;NAMEofSYSTEM&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;structure1&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;TLC&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s2">&quot;TLC&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;structure1&quot;</span><span class="p">][</span><span class="s2">&quot;tlc&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">fin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="IntermediateStateFactory._write_amber_files">
<a class="viewcode-back" href="../../autosummary/transformato.state.html#transformato.state.IntermediateStateFactory._write_amber_files">[docs]</a>
    <span class="k">def</span> <span class="nf">_write_amber_files</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">amber</span><span class="o">.</span><span class="n">AmberParm</span><span class="p">,</span> <span class="n">output_file_base</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tlc</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a parm7 and rst7 file for each intermediate step, including information about the dummy atoms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;waterbox&quot;</span><span class="p">:</span>
            <span class="n">psf</span><span class="o">.</span><span class="n">write_parm</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file_base</span><span class="si">}</span><span class="s2">/lig_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.parm7&quot;</span><span class="p">)</span>
            <span class="n">psf</span><span class="o">.</span><span class="n">write_rst7</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file_base</span><span class="si">}</span><span class="s2">/lig_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.rst7&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">:</span>
            <span class="n">psf</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">tlc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">write_parm</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file_base</span><span class="si">}</span><span class="s2">/lig_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.parm7&quot;</span><span class="p">)</span>
            <span class="n">psf</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">tlc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">write_rst7</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file_base</span><span class="si">}</span><span class="s2">/lig_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.rst7&quot;</span><span class="p">)</span>
            <span class="c1">### This is only necessary, because we create the parm7 and rst7 by slicing the corresponding waterbox</span>
            <span class="c1">### In this case there is one flag left which tells openmm when reading in the parm7 file, that there is</span>
            <span class="c1">### a box (PBC). For that reason we have to manually set this flag to False (0).</span>
            <span class="n">lines_left</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file_base</span><span class="si">}</span><span class="s2">/lig_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.parm7&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file_base</span><span class="si">}</span><span class="s2">/lig_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">_temp.parm7&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">tempFile</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%F</span><span class="s2">LAG POINTERS&quot;</span><span class="p">):</span>
                            <span class="n">lines_left</span> <span class="o">=</span> <span class="mi">6</span>
                        <span class="k">if</span> <span class="n">lines_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">lines_left</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">lines_left</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">newLine</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="mi">63</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">64</span><span class="p">:]</span>
                            <span class="k">assert</span> <span class="p">(</span>
                                <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>
                            <span class="p">)</span>  <span class="c1"># in this position it is usually 1 indicating a box, if we change it to 0, openmm thinks there is no box (see: https://ambermd.org/FileFormats.php#topo.cntrl)</span>
                            <span class="n">tempFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newLine</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tempFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tempFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">tempFile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Environment </span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2"> not supported&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntermediateStateFactory.write_state">
<a class="viewcode-back" href="../../autosummary/transformato.state.html#transformato.state.IntermediateStateFactory.write_state">[docs]</a>
    <span class="k">def</span> <span class="nf">write_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mutation_conf</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
        <span class="n">lambda_value_electrostatic</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">lambda_value_vdw</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">common_core_transformation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        write_state Defines everything that is written to the intermediate state directories</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mutation_conf : List</span>
<span class="sd">            [description]</span>
<span class="sd">        lambda_value_electrostatic : float, optional</span>
<span class="sd">            [description], by default 1.0</span>
<span class="sd">        lambda_value_vdw : float, optional</span>
<span class="sd">            [description], by default 1.0</span>
<span class="sd">        common_core_transformation : float, optional</span>
<span class="sd">            [description], by default 1.0</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;#########################################&quot;</span><span class="p">)</span>
        <span class="n">output_file_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_intermediate_state_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_step</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing to </span><span class="si">{</span><span class="n">output_file_base</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">envs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mutation_type</span> <span class="ow">in</span> <span class="n">mutation_conf</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">common_core_transformation</span> <span class="o">&lt;</span> <span class="mf">1.0</span>
                <span class="p">):</span>  <span class="c1"># NOTE: THis is inconsistent -- the mutatino_type is the actual mutation in this case</span>
                    <span class="c1"># This happens only for one ligand and starts the process of changing cc1 into cc2</span>
                    <span class="n">mutation_type</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span>
                        <span class="n">psf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">psfs</span><span class="p">[</span><span class="n">env</span><span class="p">],</span>
                        <span class="n">lambda_value</span><span class="o">=</span><span class="n">common_core_transformation</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># mutation_type.print_details()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lambda electrostatics: </span><span class="si">{</span><span class="n">lambda_value_electrostatic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lambda vdw: </span><span class="si">{</span><span class="n">lambda_value_vdw</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">mutator</span> <span class="o">=</span> <span class="n">Mutation</span><span class="p">(</span>
                        <span class="n">atoms_to_be_mutated</span><span class="o">=</span><span class="n">mutation_type</span><span class="o">.</span><span class="n">atoms_to_be_mutated</span><span class="p">,</span>
                        <span class="n">dummy_region</span><span class="o">=</span><span class="n">mutation_type</span><span class="o">.</span><span class="n">dummy_region</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span>
                        <span class="n">psf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">psfs</span><span class="p">[</span><span class="n">env</span><span class="p">],</span>
                        <span class="n">lambda_value_electrostatic</span><span class="o">=</span><span class="n">lambda_value_electrostatic</span><span class="p">,</span>
                        <span class="n">lambda_value_vdw</span><span class="o">=</span><span class="n">lambda_value_vdw</span><span class="p">,</span>
                        <span class="n">vdw_atom_idx</span><span class="o">=</span><span class="n">mutation_type</span><span class="o">.</span><span class="n">vdw_atom_idx</span><span class="p">,</span>
                        <span class="n">steric_mutation_to_default</span><span class="o">=</span><span class="n">mutation_type</span><span class="o">.</span><span class="n">steric_mutation_to_default</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">ff</span> <span class="o">==</span> <span class="s2">&quot;amber&quot;</span><span class="p">:</span>
                <span class="c1"># needed for each environment</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_amber_files</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">psfs</span><span class="p">[</span><span class="n">env</span><span class="p">],</span> <span class="n">output_file_base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="p">,</span> <span class="n">env</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">ff</span> <span class="o">==</span> <span class="s2">&quot;charmm&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_psf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">psfs</span><span class="p">[</span><span class="n">env</span><span class="p">],</span> <span class="n">output_file_base</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">ff</span> <span class="o">==</span> <span class="s2">&quot;charmm&quot;</span><span class="p">:</span>
            <span class="c1"># needed only once per intermediate state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_rtf_file</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">psfs</span><span class="p">[</span><span class="n">env</span><span class="p">],</span> <span class="n">output_file_base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_prm_file</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">psfs</span><span class="p">[</span><span class="n">env</span><span class="p">],</span> <span class="n">output_file_base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_toppar_str</span><span class="p">(</span><span class="n">output_file_base</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_copy_files</span><span class="p">(</span><span class="n">output_file_base</span><span class="p">)</span>

        <span class="c1"># Create run folder for dcd output for each intst state</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_runs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multiple_runs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file_base</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">multiple_runs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_runs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file_base</span><span class="si">}</span><span class="s2">/run_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_file_base</span><span class="p">)</span>

        <span class="c1"># Used for restraints:</span>
        <span class="k">if</span> <span class="s2">&quot;restraints&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Found restraints in configuration file - writing restraints.yaml&quot;</span>
            <span class="p">)</span>
            <span class="n">write_restraints_yaml</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file_base</span><span class="si">}</span><span class="s2">/restraints.yaml&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">+=</span> <span class="mi">1</span></div>


    <span class="k">def</span> <span class="nf">_get_simulations_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">prms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">]:</span>
            <span class="n">prms</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">prms</span>

<div class="viewcode-block" id="IntermediateStateFactory._write_workload_preamble">
<a class="viewcode-back" href="../../autosummary/transformato.state.html#transformato.state.IntermediateStateFactory._write_workload_preamble">[docs]</a>
    <span class="k">def</span> <span class="nf">_write_workload_preamble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepends the preamble of the selected workload manager in the file specified by filepath</span>

<span class="sd">        The preamble is the *-preamble.sh file found in transformato/bin</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath (str): Path to the file (usually _script_target)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">workloadmanager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;workload-manager&quot;</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;bin_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">workloadmanager</span><span class="si">}</span><span class="s2">-preamble.sh&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">preamblefile</span><span class="p">:</span>
            <span class="n">preamble</span> <span class="o">=</span> <span class="n">preamblefile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">script_to_prepend_to</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">script_to_prepend_to</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">script_to_prepend_to</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">script_to_prepend_to</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">preamble</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntermediateStateFactory._copy_charmm_files">
<a class="viewcode-back" href="../../autosummary/transformato.state.html#transformato.state.IntermediateStateFactory._copy_charmm_files">[docs]</a>
    <span class="k">def</span> <span class="nf">_copy_charmm_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intermediate_state_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _copy_charmm_files Copy CHARMM specific files in running directories</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        intermediate_state_file_path : [type]</span>
<span class="sd">            [description]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">basedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">charmm_gui_base</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;free-energy-type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rsfe&quot;</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;free-energy-type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;asfe&quot;</span>
        <span class="p">):</span>
            <span class="c1"># copy simulation bash script</span>
            <span class="n">charmm_simulation_submit_script_source</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;bin_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/simulation-rsfe_charmm.sh&quot;</span>
            <span class="p">)</span>
            <span class="n">charmm_simulation_submit_script_target</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/simulation_charmm.sh&quot;</span>
            <span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span>
                <span class="n">charmm_simulation_submit_script_source</span><span class="p">,</span>
                <span class="n">charmm_simulation_submit_script_target</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">envs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;waterbox&quot;</span><span class="p">:</span>
                    <span class="c1"># write charmm production scripte</span>
                    <span class="n">charmm_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charmm_factory</span><span class="o">.</span><span class="n">generate_CHARMM_production_files</span><span class="p">(</span>
                        <span class="n">env</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/charmm_run_waterbox.inp&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span>
                    <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">charmm_input</span><span class="p">)</span>

                    <span class="c1"># write charmm postproduction script</span>
                    <span class="n">charmm_input</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">charmm_factory</span><span class="o">.</span><span class="n">generate_CHARMM_postprocessing_files</span><span class="p">(</span>
                            <span class="n">env</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/charmm_evaluate_energy_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.inp&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;w+&quot;</span><span class="p">,</span>
                    <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">charmm_input</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">:</span>  <span class="c1"># vacuum</span>
                    <span class="c1"># write charmm production scripte</span>
                    <span class="n">charmm_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charmm_factory</span><span class="o">.</span><span class="n">generate_CHARMM_production_files</span><span class="p">(</span>
                        <span class="n">env</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/charmm_run_vacuum.inp&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span>
                    <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">charmm_input</span><span class="p">)</span>
                    <span class="c1"># write charmm postproduction script</span>
                    <span class="n">charmm_input</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">charmm_factory</span><span class="o">.</span><span class="n">generate_CHARMM_postprocessing_files</span><span class="p">(</span>
                            <span class="n">env</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/charmm_evaluate_energy_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.inp&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;w+&quot;</span><span class="p">,</span>
                    <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">charmm_input</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;free-energy-type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rbfe&quot;</span><span class="p">:</span>
            <span class="c1"># copy simulation bash script</span>
            <span class="n">charmm_simulation_submit_script_source</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;bin_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/simulation-rbfe_charmm.sh&quot;</span>
            <span class="p">)</span>
            <span class="n">charmm_simulation_submit_script_target</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/simulation_charmm.sh&quot;</span>
            <span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span>
                <span class="n">charmm_simulation_submit_script_source</span><span class="p">,</span>
                <span class="n">charmm_simulation_submit_script_target</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">envs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;waterbox&quot;</span> <span class="ow">or</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;complex&quot;</span><span class="p">:</span>
                    <span class="c1"># write charmm production scripte</span>
                    <span class="n">charmm_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charmm_factory</span><span class="o">.</span><span class="n">generate_CHARMM_production_files</span><span class="p">(</span>
                        <span class="n">env</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/charmm_run_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.inp&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span>
                    <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">charmm_input</span><span class="p">)</span>

                    <span class="c1"># write charmm postproduction script</span>
                    <span class="n">charmm_input</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">charmm_factory</span><span class="o">.</span><span class="n">generate_CHARMM_postprocessing_files</span><span class="p">(</span>
                            <span class="n">env</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/charmm_evaluate_energy_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.inp&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;w+&quot;</span><span class="p">,</span>
                    <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">charmm_input</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Prepend workload manager instructions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_workload_preamble</span><span class="p">(</span><span class="n">charmm_simulation_submit_script_target</span><span class="p">)</span>

        <span class="c1"># copy diverse set of helper files for CHARMM</span>
        <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">envs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">env</span> <span class="o">!=</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">:</span>
                <span class="n">FILES</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;crystal_image.str&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;step3_pbcsetup.str&quot;</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">FILES</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">charmm_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basedir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">charmm_target</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/charmm_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">charmm_source</span><span class="p">,</span> <span class="n">charmm_target</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find file: </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">raise</span>

            <span class="c1"># copy rst files</span>
            <span class="n">rst_file_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basedir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">structure</span><span class="p">][</span><span class="n">env</span><span class="p">][</span><span class="s1">&#39;rst_file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.rst&quot;</span>
            <span class="n">rst_file_target</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/lig_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.rst&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">rst_file_source</span><span class="p">,</span> <span class="n">rst_file_target</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No restart file found for </span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2"> -- starting simulation from crd file.&quot;</span>
                <span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_modify_submit_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shFile</span><span class="p">):</span>
        <span class="c1"># submit script is modified to loop over all runs depending on the number defined in the consecutive</span>
        <span class="c1"># runs</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We will manipulate the submit script for use with multiple runs&quot;</span><span class="p">)</span>

        <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shFile</span><span class="si">}</span><span class="s2">.tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shFile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;istep=lig_in_&quot;</span><span class="p">):</span>
                    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;for i in {1..&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">multiple_runs</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;};</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;do </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;python openmm&quot;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{istep}</span><span class="s2">.dcd&quot;</span><span class="p">,</span> <span class="s2">&quot;run_$</span><span class="si">{i}</span><span class="s2">/$</span><span class="si">{istep}</span><span class="s2">.dcd&quot;</span><span class="p">)</span>
                    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;run_$</span><span class="si">{i}</span><span class="s2">/&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;done </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fout</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">shFile</span><span class="p">)</span>

<div class="viewcode-block" id="IntermediateStateFactory._copy_omm_files">
<a class="viewcode-back" href="../../autosummary/transformato.state.html#transformato.state.IntermediateStateFactory._copy_omm_files">[docs]</a>
    <span class="k">def</span> <span class="nf">_copy_omm_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intermediate_state_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _copy_omm_files Copyies the files needed for the production runs with openMM in the intst* directories</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        intermediate_state_file_path : str</span>
<span class="sd">            [description]</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            [description]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">charmm_gui_base</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;free-energy-type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rsfe&quot;</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;free-energy-type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;asfe&quot;</span>
        <span class="p">):</span>
            <span class="c1"># parse omm simulation paramter</span>
            <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">envs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;waterbox&quot;</span><span class="p">:</span>
                    <span class="n">omm_simulation_parameter_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basedir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">/openmm/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">structure</span><span class="p">][</span><span class="n">env</span><span class="p">][</span><span class="s1">&#39;simulation_parameter&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">omm_simulation_parameter_target</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">structure</span><span class="p">][</span><span class="n">env</span><span class="p">][</span><span class="s1">&#39;intermediate-filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite_simulation_script_parameters</span><span class="p">(</span>
                        <span class="n">omm_simulation_parameter_source</span><span class="p">,</span> <span class="n">omm_simulation_parameter_target</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># vacuum</span>
                    <span class="n">used_env</span> <span class="o">=</span> <span class="s2">&quot;waterbox&quot;</span>
                    <span class="n">omm_simulation_parameter_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basedir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">used_env</span><span class="si">}</span><span class="s2">/openmm/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">structure</span><span class="p">][</span><span class="n">used_env</span><span class="p">][</span><span class="s1">&#39;simulation_parameter&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">omm_simulation_parameter_target</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">structure</span><span class="p">][</span><span class="n">env</span><span class="p">][</span><span class="s1">&#39;intermediate-filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite_simulation_script_parameters</span><span class="p">(</span>
                        <span class="n">omm_simulation_parameter_source</span><span class="p">,</span> <span class="n">omm_simulation_parameter_target</span>
                    <span class="p">)</span>

            <span class="c1"># copy simulation bash script</span>
            <span class="n">omm_simulation_submit_script_source</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;bin_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/simulation-rsfe.sh&quot;</span>
            <span class="p">)</span>
            <span class="n">omm_simulation_submit_script_target</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/simulation.sh&quot;</span>
            <span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span>
                <span class="n">omm_simulation_submit_script_source</span><span class="p">,</span> <span class="n">omm_simulation_submit_script_target</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;free-energy-type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rbfe&quot;</span><span class="p">:</span>
            <span class="c1"># parse omm simulation paramter</span>
            <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">envs</span><span class="p">:</span>
                <span class="n">omm_simulation_parameter_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basedir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">/openmm/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">structure</span><span class="p">][</span><span class="n">env</span><span class="p">][</span><span class="s1">&#39;simulation_parameter&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">omm_simulation_parameter_target</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">structure</span><span class="p">][</span><span class="n">env</span><span class="p">][</span><span class="s1">&#39;intermediate-filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite_simulation_script_parameters</span><span class="p">(</span>
                    <span class="n">omm_simulation_parameter_source</span><span class="p">,</span> <span class="n">omm_simulation_parameter_target</span>
                <span class="p">)</span>

            <span class="c1"># copy simulation bash script</span>
            <span class="n">omm_simulation_submit_script_source</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;bin_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/simulation-rbfe.sh&quot;</span>
            <span class="p">)</span>
            <span class="n">omm_simulation_submit_script_target</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/simulation.sh&quot;</span>
            <span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span>
                <span class="n">omm_simulation_submit_script_source</span><span class="p">,</span> <span class="n">omm_simulation_submit_script_target</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only solvation/binding free energies implemented&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_runs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_modify_submit_script</span><span class="p">(</span><span class="n">omm_simulation_submit_script_target</span><span class="p">)</span>

        <span class="c1"># Prepend workload manager instructions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_workload_preamble</span><span class="p">(</span><span class="n">omm_simulation_submit_script_target</span><span class="p">)</span>

        <span class="c1"># copy rst files</span>
        <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">envs</span><span class="p">:</span>
            <span class="n">rst_file_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basedir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">/openmm/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">structure</span><span class="p">][</span><span class="n">env</span><span class="p">][</span><span class="s1">&#39;rst_file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.rst&quot;</span>
            <span class="n">rst_file_target</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/lig_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.rst&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">rst_file_source</span><span class="p">,</span> <span class="n">rst_file_target</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No restart file found for </span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2"> -- starting simulation from crd file.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># copy diverse set of helper functions for openMM</span>
        <span class="n">FILES</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;omm_readinputs.py&quot;</span><span class="p">,</span>
            <span class="s2">&quot;omm_readparams.py&quot;</span><span class="p">,</span>
            <span class="s2">&quot;omm_vfswitch.py&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">FILES</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">omm_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basedir</span><span class="si">}</span><span class="s2">/waterbox/openmm/</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">omm_target</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">omm_source</span><span class="p">,</span> <span class="n">omm_target</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find file: </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># copy omm simulation script</span>
        <span class="n">omm_simulation_script_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;bin_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/openmm_run.py&quot;</span>
        <span class="n">omm_simulation_script_target</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/openmm_run.py&quot;</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">omm_simulation_script_source</span><span class="p">,</span> <span class="n">omm_simulation_script_target</span><span class="p">)</span>
        <span class="c1"># add serialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_hmr</span><span class="p">(</span><span class="n">omm_simulation_script_target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_change_platform</span><span class="p">(</span><span class="n">omm_simulation_script_target</span><span class="p">)</span>
        <span class="n">check_switching_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vdw_switch</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntermediateStateFactory._check_hmr">
<a class="viewcode-back" href="../../autosummary/transformato.state.html#transformato.state.IntermediateStateFactory._check_hmr">[docs]</a>
    <span class="k">def</span> <span class="nf">_check_hmr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="s2">&quot;add hmr if requested in config file&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HMR&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">_tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">g</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                        <span class="k">if</span> <span class="s2">&quot;system = psf.createSystem&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Adding HMR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="s2">&quot;nboptions[&#39;hydrogenMass&#39;] = 1.5 *atom_mass_units</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">_tmp&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_change_platform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="c1"># changin input script</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">_tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># counting lines</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;GPU&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Preparing for CUDA&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="s2">&quot;# Set platform&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;platform = Platform.getPlatformByName(&#39;CUDA&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;prop = dict(CudaPrecision=&#39;mixed&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="s2">&quot;# Set platform&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;platform = Platform.getPlatformByName(&#39;CPU&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;prop = dict()</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">_tmp&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_copy_ligand_specific_top_and_par</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">basedir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">intermediate_state_file_path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
        <span class="c1"># copy ligand rtf file</span>
        <span class="n">ligand_rtf</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basedir</span><span class="si">}</span><span class="s2">/waterbox/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_g.rtf&quot;</span>
        <span class="n">toppar_target</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_g.rtf&quot;</span>
        <span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">ligand_rtf</span><span class="p">,</span> <span class="n">toppar_target</span><span class="p">)</span>

        <span class="c1"># copy ligand prm file</span>
        <span class="n">ligand_prm</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basedir</span><span class="si">}</span><span class="s2">/waterbox/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.prm&quot;</span>
        <span class="n">toppar_target</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.prm&quot;</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">ligand_prm</span><span class="p">,</span> <span class="n">toppar_target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_copy_ligand_specific_str</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">basedir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">intermediate_state_file_path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
        <span class="c1"># copy ligand rtf file</span>
        <span class="n">ligand_rtf</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basedir</span><span class="si">}</span><span class="s2">/waterbox/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.str&quot;</span>
        <span class="n">toppar_target</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.str&quot;</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">ligand_rtf</span><span class="p">,</span> <span class="n">toppar_target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_copy_crd_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intermediate_state_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">charmm_gui_base</span>
        <span class="c1"># copy crd files</span>
        <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">envs</span><span class="p">:</span>
            <span class="n">crd_file_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basedir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">/openmm/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">structure</span><span class="p">][</span><span class="n">env</span><span class="p">][</span><span class="s1">&#39;crd_file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.crd&quot;</span>
            <span class="n">crd_file_target</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/lig_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.crd&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">crd_file_source</span><span class="p">,</span> <span class="n">crd_file_target</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No crd file found for </span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2"> -- using parmed system structure to create crd file.&quot;</span>
                <span class="p">)</span>
                <span class="n">crd_file_target</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate_state_file_path</span><span class="si">}</span><span class="s2">/lig_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.crd&quot;</span>
                <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmCrdFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">psfs</span><span class="p">[</span><span class="n">env</span><span class="p">],</span> <span class="n">crd_file_target</span><span class="p">)</span>

<div class="viewcode-block" id="IntermediateStateFactory._copy_files">
<a class="viewcode-back" href="../../autosummary/transformato.state.html#transformato.state.IntermediateStateFactory._copy_files">[docs]</a>
    <span class="k">def</span> <span class="nf">_copy_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intermediate_state_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy the files from the original CHARMM-GUI output folder in the intermediate directories.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">basedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">charmm_gui_base</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_copy_ligand_specific_top_and_par</span><span class="p">(</span>
                <span class="n">basedir</span><span class="p">,</span> <span class="n">intermediate_state_file_path</span>
            <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_copy_ligand_specific_str</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">intermediate_state_file_path</span><span class="p">)</span>

        <span class="c1"># copy crd file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_copy_crd_file</span><span class="p">((</span><span class="n">intermediate_state_file_path</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># copy openMM and charmm specific scripts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copy_omm_files</span><span class="p">(</span><span class="n">intermediate_state_file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copy_charmm_files</span><span class="p">(</span><span class="n">intermediate_state_file_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntermediateStateFactory._overwrite_simulation_script_parameters">
<a class="viewcode-back" href="../../autosummary/transformato.state.html#transformato.state.IntermediateStateFactory._overwrite_simulation_script_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">_overwrite_simulation_script_parameters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">omm_simulation_parameter_source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">omm_simulation_parameter_target</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _overwrite_simulation_script_parameters changes parameters that are defined in omm_simulation_parameter_source</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        omm_simulation_parameter_source : str</span>
<span class="sd">            key:value pair file that defines parameters to overwrite</span>
<span class="sd">        omm_simulation_parameter_target : str</span>
<span class="sd">            new parameter file for simulation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">copy</span>

        <span class="n">overwrite_parameters</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_simulations_parameters</span><span class="p">())</span>

        <span class="k">if</span> <span class="s2">&quot;vdw&quot;</span> <span class="ow">in</span> <span class="n">overwrite_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">overwrite_parameters</span><span class="p">[</span><span class="s2">&quot;vdw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;force-switch&quot;</span><span class="p">,</span>
                <span class="s2">&quot;no-switch&quot;</span><span class="p">,</span>
                <span class="s2">&quot;switch&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;switch: </span><span class="si">{</span><span class="n">overwrite_parameters</span><span class="p">[</span><span class="s1">&#39;vdw&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not implemented.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vdw_switch</span> <span class="o">=</span> <span class="n">overwrite_parameters</span><span class="p">[</span><span class="s2">&quot;vdw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vdw_switch</span> <span class="o">=</span> <span class="s2">&quot;force-switch&quot;</span>  <span class="c1"># default for now</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Setting switching function to vfswitch&quot;</span><span class="p">)</span>

        <span class="n">input_simulation_parameter</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">omm_simulation_parameter_source</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">output_simulation_parameter</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span>
            <span class="n">omm_simulation_parameter_target</span> <span class="o">+</span> <span class="s2">&quot;.inp&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span>
        <span class="p">)</span>

        <span class="n">common_keywords</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;nstep&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nstdcd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nstout&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cons&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mini_nstep&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># test that common keywords are in yaml files</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">elem</span> <span class="ow">in</span> <span class="n">overwrite_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">common_keywords</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">common_keywords</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">overwrite_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">elem</span> <span class="o">==</span> <span class="s2">&quot;cons&quot;</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;###################&quot;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">elem</span><span class="si">}</span><span class="s2"> is not set in config yaml. This is very likely a mistake!&quot;</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;###################&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;###################&quot;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">elem</span><span class="si">}</span><span class="s2"> is not set in config yaml. Was this a mistake?&quot;</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;###################&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">input_simulation_parameter</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="n">t1</span><span class="p">,</span> <span class="n">t2_comment</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)]</span>
                    <span class="n">t2</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t2_comment</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)]</span>
                    <span class="n">comment</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">t1</span> <span class="ow">in</span> <span class="n">overwrite_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">t2</span> <span class="o">=</span> <span class="n">overwrite_parameters</span><span class="p">[</span><span class="n">t1</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">overwrite_parameters</span><span class="p">[</span><span class="n">t1</span><span class="p">]</span>  <span class="c1"># remove from dict</span>
                    <span class="k">if</span> <span class="n">t1</span> <span class="o">==</span> <span class="s2">&quot;vdw&quot;</span><span class="p">:</span>
                        <span class="n">t2</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
                    <span class="n">output_simulation_parameter</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t1</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">t2</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> # </span><span class="si">{</span><span class="n">comment</span><span class="si">:</span><span class="s2">&lt;30</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output_simulation_parameter</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The original inp </span><span class="si">{</span><span class="n">input_simulation_parameter</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> file  contains a line without a comment &quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>

        <span class="c1"># set parameters that have no equivalent in the pregenerated parameter file</span>
        <span class="k">for</span> <span class="n">t1</span> <span class="ow">in</span> <span class="n">overwrite_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">overwrite_parameters</span><span class="p">[</span><span class="n">t1</span><span class="p">]</span>
            <span class="n">output_simulation_parameter</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t1</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">t2</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> # some new options</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">input_simulation_parameter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">output_simulation_parameter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="IntermediateStateFactory._write_rtf_file">
<a class="viewcode-back" href="../../autosummary/transformato.state.html#transformato.state.IntermediateStateFactory._write_rtf_file">[docs]</a>
    <span class="k">def</span> <span class="nf">_write_rtf_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">output_file_base</span><span class="p">,</span> <span class="n">tlc</span>
    <span class="p">):</span>  <span class="c1"># NOTE: this needs some refactoring!</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the dummy atom parameter rtf.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">header_rtf</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;* Dummy atom parameters </span>
<span class="s2">* generated by transformato</span>
<span class="s2">*</span>
<span class="s2">36  1</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="n">rtf_file_handler</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file_base</span> <span class="o">+</span> <span class="s2">&quot;/dummy_atom_definitions.rtf&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">rtf_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header_rtf</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">psf</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">tlc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="s2">&quot;initial_type&quot;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;- Setting dummy parameters ...&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  + Atom-Name: </span><span class="si">{</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  + Atom-Type: </span><span class="si">{</span><span class="n">atom</span><span class="o">.</span><span class="n">initial_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  + Atom Dummy Type: </span><span class="si">{</span><span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">rtf_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:6}</span><span class="s2"> </span><span class="si">{:6}</span><span class="s2"> </span><span class="si">{:6}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;MASS&quot;</span><span class="p">,</span> <span class="s2">&quot;-1&quot;</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># TODO: check the  rtf_file_handler.write vs</span>

        <span class="n">rtf_file_handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_write_prm_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">output_file_base</span><span class="p">,</span> <span class="n">tlc</span><span class="p">):</span>
        <span class="n">header_prm</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;* Parameters generated by analogy by</span>
<span class="s2">* CHARMM General Force Field (CGenFF) program version 1.0.0</span>
<span class="s2">*</span>
<span class="s2">! Automatically obtained dummy parameters </span>
<span class="s2">! from transformato</span>
<span class="s2">&quot;&quot;&quot;</span>

        <span class="n">prm_file_handler</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file_base</span><span class="si">}</span><span class="s2">/dummy_parameters.prm&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header_prm</span><span class="p">)</span>
        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ATOMS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">already_seen</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">tlc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="c1"># writing atom parameters</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">view</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="s2">&quot;initial_type&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="p">])</span> <span class="ow">in</span> <span class="n">already_seen</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">already_seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="p">]))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;- Setting dummy parameters ...&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  + Atom-Name: </span><span class="si">{</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  + Atom-Type: </span><span class="si">{</span><span class="n">atom</span><span class="o">.</span><span class="n">initial_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  + Atom Dummy Type: </span><span class="si">{</span><span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:6}</span><span class="s2"> </span><span class="si">{:6}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="s2">&quot;MASS&quot;</span><span class="p">,</span> <span class="s2">&quot;-1&quot;</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">mass</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1">##############################################################################</span>
        <span class="c1"># write bond parameters - again there are two ways to use this:</span>
        <span class="c1"># - keeping bonded terms between real/dummy and dummy atoms intact</span>
        <span class="c1"># - changing bonded parameters between real atoms - this again needs dummy atoms</span>

        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;BONDS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">already_seen</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">view</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="s2">&quot;initial_type&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="p">[</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">([</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">])</span> <span class="ow">in</span> <span class="n">already_seen</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">already_seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">]))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot; &gt;&gt; Setting dummy bond parameters for: </span><span class="si">{}</span><span class="s2"> - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                            <span class="n">bond</span><span class="o">.</span><span class="n">mod_type</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
                            <span class="n">bond</span><span class="o">.</span><span class="n">mod_type</span><span class="o">.</span><span class="n">req</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                            <span class="n">bond</span><span class="o">.</span><span class="n">mod_type</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
                            <span class="n">bond</span><span class="o">.</span><span class="n">mod_type</span><span class="o">.</span><span class="n">req</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">),</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">),</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="c1">#################################################################</span>
        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ANGLES</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">already_seen</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">view</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
            <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">atom3</span> <span class="o">=</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="s2">&quot;initial_type&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="p">[</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">atom3</span><span class="p">]):</span>
                <span class="k">if</span> <span class="p">[</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">]</span> <span class="ow">in</span> <span class="n">already_seen</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="p">[</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">already_seen</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">])</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;############################################&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Printing angle atoms which at least one dummy atom.&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot; &gt;&gt; Setting dummy angle parameters for: </span><span class="si">{</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                            <span class="n">angle</span><span class="o">.</span><span class="n">mod_type</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
                            <span class="n">angle</span><span class="o">.</span><span class="n">mod_type</span><span class="o">.</span><span class="n">theteq</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                            <span class="n">angle</span><span class="o">.</span><span class="n">mod_type</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
                            <span class="n">angle</span><span class="o">.</span><span class="n">mod_type</span><span class="o">.</span><span class="n">theteq</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                            <span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
                            <span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">theteq</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                            <span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
                            <span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">theteq</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="c1">#################################################################</span>
        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;DIHEDRALS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">already_seen</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="n">view</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
            <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">atom3</span><span class="p">,</span> <span class="n">atom4</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">dihedral</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span>
                <span class="n">dihedral</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span>
                <span class="n">dihedral</span><span class="o">.</span><span class="n">atom3</span><span class="p">,</span>
                <span class="n">dihedral</span><span class="o">.</span><span class="n">atom4</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="s2">&quot;initial_type&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="p">[</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">atom3</span><span class="p">,</span> <span class="n">atom4</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="p">[</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom4</span><span class="o">.</span><span class="n">type</span><span class="p">]</span> <span class="ow">in</span> <span class="n">already_seen</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">already_seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom4</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
                    <span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot; &gt;&gt; Setting dummy dihedral parameters for: </span><span class="si">{</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">atom4</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">dihedral_type</span> <span class="ow">in</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">mod_type</span><span class="p">:</span>
                        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:6.5f}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">atom4</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                                <span class="n">dihedral_type</span><span class="o">.</span><span class="n">phi_k</span><span class="p">,</span>
                                <span class="n">dihedral_type</span><span class="o">.</span><span class="n">per</span><span class="p">,</span>
                                <span class="n">dihedral_type</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">dihedral_type</span> <span class="ow">in</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:6.5f}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">atom4</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                                <span class="n">dihedral_type</span><span class="o">.</span><span class="n">phi_k</span><span class="p">,</span>
                                <span class="n">dihedral_type</span><span class="o">.</span><span class="n">per</span><span class="p">,</span>
                                <span class="n">dihedral_type</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

        <span class="c1">#################################################################</span>
        <span class="c1"># get all unique improper and parameters</span>
        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;IMPROPERS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">impr</span> <span class="ow">in</span> <span class="n">view</span><span class="o">.</span><span class="n">impropers</span><span class="p">:</span>
            <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">atom3</span><span class="p">,</span> <span class="n">atom4</span> <span class="o">=</span> <span class="n">impr</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">impr</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="n">impr</span><span class="o">.</span><span class="n">atom3</span><span class="p">,</span> <span class="n">impr</span><span class="o">.</span><span class="n">atom4</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="s2">&quot;initial_type&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="p">[</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">atom3</span><span class="p">,</span> <span class="n">atom4</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="c1"># print(&#39;&gt;&gt; Setting dummy improper parameters for: {}-{}-{}-{}&#39;.format(str(atom1.type),str(atom2.type),str(atom3.type),str(atom4.type)))</span>
                <span class="c1"># carefull with this solution - &gt; central atom has to be set in the beginning</span>
                <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">atom4</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                        <span class="n">impr</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">psi_k</span><span class="p">,</span>
                        <span class="n">impr</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">psi_eq</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1">#################################################################</span>
        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;NONBONDED nbxmod  5 atom cdiel fshift vatom vdistance vfswitch -</span>
<span class="sd">cutnb 14.0 ctofnb 12.0 ctonnb 10.0 eps 1.0 e14fac 1.0 wmin 1.5&quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">view</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="s2">&quot;initial_type&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:6}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">mod_type</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">mod_type</span><span class="o">.</span><span class="n">rmin</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{:7}</span><span class="s2"> </span><span class="si">{:6}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="s2"> </span><span class="si">{:9.5f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">rmin</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;END&quot;</span><span class="p">)</span>
        <span class="n">prm_file_handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="IntermediateStateFactory._init_base_dir">
<a class="viewcode-back" href="../../autosummary/transformato.state.html#transformato.state.IntermediateStateFactory._init_base_dir">[docs]</a>
    <span class="k">def</span> <span class="nf">_init_base_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the base directory in which all intermediate states are located</span>
<span class="sd">        and create the central toppar dir.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># copy central toppar folder</span>

        <span class="n">basedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">charmm_gui_base</span>
        <span class="n">toppar_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basedir</span><span class="si">}</span><span class="s2">/waterbox/toppar&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">toppar_source</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">toppar_dir</span> <span class="o">=</span> <span class="n">get_toppar_dir</span><span class="p">()</span>
            <span class="n">toppar_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">toppar_dir</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;will use the toppar version available within the Transformato package&quot;</span>
            <span class="p">)</span>

        <span class="n">toppar_target</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;system_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/toppar&quot;</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">toppar_source</span><span class="p">,</span> <span class="n">toppar_target</span><span class="p">,</span> <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_write_toppar_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file_base</span><span class="p">):</span>
        <span class="n">toppar_format</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">../../toppar/top_all36_prot.rtf</span>
<span class="s2">../../toppar/par_all36m_prot.prm</span>
<span class="s2">../../toppar/top_all36_na.rtf</span>
<span class="s2">../../toppar/par_all36_na.prm</span>
<span class="s2">../../toppar/top_all36_carb.rtf</span>
<span class="s2">../../toppar/par_all36_carb.prm</span>
<span class="s2">../../toppar/top_all36_lipid.rtf</span>
<span class="s2">../../toppar/par_all36_lipid.prm</span>
<span class="s2">../../toppar/top_all36_cgenff.rtf</span>
<span class="s2">../../toppar/par_all36_cgenff.prm</span>
<span class="s2">../../toppar/toppar_water_ions.str</span>
<span class="s2">../../toppar/toppar_dum_noble_gases.str</span>
<span class="s2">../../toppar/toppar_all36_prot_c36m_d_aminoacids.str</span>
<span class="s2">../../toppar/toppar_all36_prot_fluoro_alkanes.str</span>
<span class="s2">../../toppar/toppar_all36_prot_heme.str</span>
<span class="s2">../../toppar/toppar_all36_prot_na_combined.str</span>
<span class="s2">../../toppar/toppar_all36_prot_retinol.str</span>
<span class="s2">../../toppar/toppar_all36_na_nad_ppi.str</span>
<span class="s2">../../toppar/toppar_all36_lipid_bacterial.str</span>
<span class="s2">../../toppar/toppar_all36_lipid_cardiolipin.str</span>
<span class="s2">../../toppar/toppar_all36_lipid_cholesterol.str</span>
<span class="s2">../../toppar/toppar_all36_lipid_inositol.str</span>
<span class="s2">../../toppar/toppar_all36_lipid_lps.str</span>
<span class="s2">../../toppar/toppar_all36_lipid_miscellaneous.str</span>
<span class="s2">../../toppar/toppar_all36_lipid_model.str</span>
<span class="s2">../../toppar/toppar_all36_lipid_prot.str</span>
<span class="s2">../../toppar/toppar_all36_lipid_sphingo.str</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">charmm_gui_base</span><span class="si">}</span><span class="s2">/waterbox/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_g.rtf&quot;</span>
        <span class="p">):</span>
            <span class="n">toppar_format</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_g.rtf</span>
<span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.prm</span>
<span class="s2">dummy_atom_definitions.rtf</span>
<span class="s2">dummy_parameters.prm</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">toppar_format</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.str</span>
<span class="s2">dummy_atom_definitions.rtf</span>
<span class="s2">dummy_parameters.prm</span>
<span class="s2">&quot;&quot;&quot;</span>

        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file_base</span><span class="si">}</span><span class="s2">/toppar.str&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">toppar_format</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># write charmm_toppar.str</span>
        <span class="n">charmm_toppar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charmm_factory</span><span class="o">.</span><span class="n">build_reduced_toppar</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">charmm_gui_base</span>
        <span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file_base</span><span class="si">}</span><span class="s2">/charmm_toppar.str&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">charmm_toppar</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="IntermediateStateFactory._write_psf">
<a class="viewcode-back" href="../../autosummary/transformato.state.html#transformato.state.IntermediateStateFactory._write_psf">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_write_psf</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">output_file_base</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes the new psf and pdb file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file_base</span><span class="si">}</span><span class="s2">/lig_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.psf&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">psf</span><span class="o">.</span><span class="n">write_psf</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">string_object</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">psf</span><span class="o">.</span><span class="n">write_psf</span><span class="p">(</span><span class="n">string_object</span><span class="p">)</span>
        <span class="c1"># read in psf and correct some aspects of the file not suitable for CHARMM</span>
        <span class="n">corrected_psf</span> <span class="o">=</span> <span class="n">psf_correction</span><span class="p">(</span><span class="n">string_object</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file_base</span><span class="si">}</span><span class="s2">/lig_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">_corr.psf&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">corrected_psf</span><span class="p">)</span>
        <span class="c1"># write pdb</span>
        <span class="n">psf</span><span class="o">.</span><span class="n">write_pdb</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file_base</span><span class="si">}</span><span class="s2">/lig_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.pdb&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntermediateStateFactory._init_intermediate_state_dir">
<a class="viewcode-back" href="../../autosummary/transformato.state.html#transformato.state.IntermediateStateFactory._init_intermediate_state_dir">[docs]</a>
    <span class="k">def</span> <span class="nf">_init_intermediate_state_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nr</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the intermediate state directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_file_base</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">/intst</span><span class="si">{</span><span class="n">nr</span><span class="si">}</span><span class="s2">/&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; - Created directory: - </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_file_base</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_file_base</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; - Writing in - </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_file_base</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_file_base</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Marcus Wieder, Johannes Karwounopoulos, Stefan Boresch. Project structure based on the Computational Molecular Science Python Cookiecutter version 1.1.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>