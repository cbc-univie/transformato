<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>transformato.restraints &mdash; transformato  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/logo_transformato.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../whatistransformato.html">Theoretical background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../System_Setup.html">System Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Additional_Settings.html">Additional Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Running_Simulation.html">Running Simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Analysis.html">Trajectory Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">transformato</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">transformato.restraints</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for transformato.restraints</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Manages restraints and the forces created from them.</span>

<span class="sd">Basic function:</span>
<span class="sd">-------------------</span>

<span class="sd">From the &#39;restraints&#39; section in the config.yaml, the intermediate state factory creates an appropriate restraints.yaml in the</span>
<span class="sd">intermediate state directories.</span>

<span class="sd">When the simulation is run, openMM_run.py checks for the existence of these restraints.yaml. If it finds one, a number of Restraint() instances commensurate</span>
<span class="sd">to the number of desired restraints is created. These each create an appropriate openMM force as defined by their parameters. That force ist then applied to the openMM simulation.</span>

<span class="sd">Usage:</span>
<span class="sd">--------</span>

<span class="sd">Unless you directly want to modify functionality, you should not need to call here directly.</span>
<span class="sd">Define your restraints in the config.yaml.</span>

<span class="sd">.. hint::</span>
<span class="sd">    For further usage instructions, see the &#39;System Setup&#39; section of the main documentation.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">MDAnalysis</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="c1"># Load necessary openmm facilities</span>
<span class="kn">from</span> <span class="nn">openmm</span> <span class="kn">import</span> <span class="n">CustomCentroidBondForce</span>
<span class="kn">from</span> <span class="nn">openmm.unit</span> <span class="kn">import</span> <span class="n">angstrom</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="c1"># logger.setLevel(logging.DEBUG)</span>


<div class="viewcode-block" id="Restraint"><a class="viewcode-back" href="../../autosummary/transformato.restraints.html#transformato.restraints.Restraint">[docs]</a><span class="k">class</span> <span class="nc">Restraint</span><span class="p">:</span>
<div class="viewcode-block" id="Restraint.__init__"><a class="viewcode-back" href="../../autosummary/transformato.restraints.html#transformato.restraints.Restraint.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selligand</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">selprotein</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">topology</span><span class="p">:</span> <span class="n">MDAnalysis</span><span class="o">.</span><span class="n">Universe</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">shape</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;harmonic&quot;</span><span class="p">,</span>
        <span class="n">wellsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Class representing a restraint to apply to the system.</span>

<span class="sd">        Intermediary step - openMM force objects are generated directly from this class and applied to the system.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AttributeError: If the potential shape requested is not implemented.</span>

<span class="sd">        Args:</span>
<span class="sd">            selligand,selprotein (MDAnalysis selection string): MDAnalysis selection strings</span>
<span class="sd">            k: the force (=spring) constant applied to the potential energy formula. See the &#39;System Setup&#39; section for details.</span>
<span class="sd">            topology: the MDAnalysis universe used to generate restraint geometries</span>
<span class="sd">            shape: one of &#39;harmonic&#39;, &#39;flatbottom&#39;, &#39;flatbottom-oneside-sharp&#39; or &#39;flatbottom-twoside&#39;. Defines the shape of the harmonic energy potential.</span>
<span class="sd">            wellsize: Defines the well-size in a two-sided flat-bottom potential. Defaults to 0.05 nanometers.</span>
<span class="sd">            kwargs: Catcher for additional restraint_args</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;harmonic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;flatbottom&quot;</span><span class="p">,</span>
            <span class="s2">&quot;flatbottom-oneside-sharp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;flatbottom-oneside&quot;</span><span class="p">,</span>
            <span class="s2">&quot;flatbottom-twoside&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid potential shape specified for restraint: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span> <span class="o">=</span> <span class="n">topology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="n">selligand</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="n">selprotein</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">force_constant</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wellsize</span> <span class="o">=</span> <span class="n">wellsize</span> <span class="o">*</span> <span class="n">angstrom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span></div>

<div class="viewcode-block" id="Restraint.createForce"><a class="viewcode-back" href="../../autosummary/transformato.restraints.html#transformato.restraints.Restraint.createForce">[docs]</a>    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">common_core_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Actually creates the force, after dismissing all idxs not in the common core from the molecule.</span>

<span class="sd">        Args:</span>
<span class="sd">            common_core_names (array[str]):  - Array with strings of the common core names. Usually provided by the restraint.yaml file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            openMM.CustomCentroidBondForce: An openMM force object representing the restraint bond.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Only done for g1, as it is the ligand group - theres no common core for the protein</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Before CC check: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">g1</span><span class="o">.</span><span class="n">names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">g1_in_cc</span> <span class="o">=</span> <span class="n">MDAnalysis</span><span class="o">.</span><span class="n">AtomGroup</span><span class="p">([],</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">g1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">common_core_names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">g1_in_cc</span> <span class="o">+=</span> <span class="n">atom</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After CC check: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">g1_in_cc</span><span class="o">.</span><span class="n">names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">common_core_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">g1_in_cc</span><span class="p">]</span>

        <span class="c1"># convert MDAnalysis syntax into openMM usable idxs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g1_openmm</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">g1_in_cc</span><span class="o">.</span><span class="n">ix</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g2_openmm</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">g2</span><span class="o">.</span><span class="n">ix</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;G1 openMM ix: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">g1_openmm</span><span class="si">}</span><span class="se">\n</span><span class="s2">G2 openMM ix: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">g2_openmm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">g1pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g1_in_cc</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g2pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g2</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initial_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g1pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">g2pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="s2">&quot;r0&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">):</span>  <span class="c1"># default value - equilibrium distance is the initial distance. Otherwise, overriden with the r0 specified</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_distance</span> <span class="o">*</span> <span class="n">angstrom</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;r0&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">angstrom</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="s2">&quot;harmonic&quot;</span><span class="p">:</span>
            <span class="c1"># create force with harmonic potential</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">CustomCentroidBondForce</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;0.5*k*(distance(g1,g2)-r0)^2&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addPerBondParameter</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addPerBondParameter</span><span class="p">(</span><span class="s2">&quot;r0&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g1_openmm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g2_openmm</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addBond</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">force_constant</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r0</span><span class="p">])</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Restraint force (centroid/bonded, shape is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, initial distance: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_distance</span><span class="si">}</span><span class="s2">, k=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">force_constant</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;flatbottom&quot;</span><span class="p">,</span> <span class="s2">&quot;flatbottom-oneside&quot;</span><span class="p">]:</span>
            <span class="c1"># create force with flat-bottom potential identical to the one used in openmmtools</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;creating flatbottom-1side-soft&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">CustomCentroidBondForce</span><span class="p">(</span>
                <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;step(distance(g1,g2)-r0) * (k/2)*(distance(g1,g2)-r0)^2&quot;</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_add_flatbottom_parameters</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="s2">&quot;flatbottom-oneside-sharp&quot;</span><span class="p">:</span>
            <span class="c1"># create force with flat-bottom potential</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;creating flatbottom-1side-sharp&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">CustomCentroidBondForce</span><span class="p">(</span>
                <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;step(distance(g1,g2)-r0) * (k/2)*(distance(g1,g2))^2&quot;</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_add_flatbottom_parameters</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="s2">&quot;flatbottom-twoside&quot;</span><span class="p">:</span>
            <span class="c1"># create force with flat-bottom potential</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;creating flatbottom-2side-sharp&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">CustomCentroidBondForce</span><span class="p">(</span>
                <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;step(abs(distance(g1,g2)-r0)-w)*k*(distance(g1,g2)-r0)^2&quot;</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_add_flatbottom_parameters</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot create potential of shape </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Group 1 (COM: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">g1pos</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">g1_in_cc</span><span class="o">.</span><span class="n">names</span><span class="p">]</span><span class="si">}</span>
<span class="s2">        Group 2 (COM: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">g2pos</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">g2</span><span class="o">.</span><span class="n">names</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span>  <span class="c1"># delete the enormous no longer needed universe asap</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span></div>

    <span class="k">def</span> <span class="nf">get_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span>

<div class="viewcode-block" id="Restraint._add_flatbottom_parameters"><a class="viewcode-back" href="../../autosummary/transformato.restraints.html#transformato.restraints.Restraint._add_flatbottom_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">_add_flatbottom_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Takes care of the initial setup of an openMM CustomCentroidBondForce with a flatbottom shape</span>

<span class="sd">        Args:</span>
<span class="sd">            force: An openMM CustomCentroidBondForce object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addPerBondParameter</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addPerBondParameter</span><span class="p">(</span><span class="s2">&quot;r0&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g1_openmm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g2_openmm</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;twoside&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
        <span class="p">):</span>  <span class="c1"># two - sided flatbottoms gain an additional parameter for the wellsize</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addPerBondParameter</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addBond</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">force_constant</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wellsize</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addBond</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">force_constant</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r0</span><span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Restraint force (centroid/bonded), shape is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, Parameters: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">getBondParameters</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Restraint.applyForce"><a class="viewcode-back" href="../../autosummary/transformato.restraints.html#transformato.restraints.Restraint.applyForce">[docs]</a>    <span class="k">def</span> <span class="nf">applyForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies the force to the openMM system</span>

<span class="sd">        Args:</span>
<span class="sd">            system (openMM.system): The openMM system to which to apply the Force</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">get3DDistance</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes two 3d positions as array and calculates the distance between them</span>

<span class="sd">    Args:</span>
<span class="sd">        pos1,pos2 (3D-Array): The positions of which to calculate the distances</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: The distance between the two positions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">pos1</span> <span class="o">-</span> <span class="n">pos2</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">distance</span>


<span class="k">def</span> <span class="nf">generate_simple_selection</span><span class="p">(</span><span class="n">configuration</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes the common core and selects surrounding carbon-alphas</span>

<span class="sd">    This ensures that the initial simple restraints on both sides is identical</span>

<span class="sd">    Args:</span>
<span class="sd">        configuration (dict): the read-in restraints.yaml</span>


<span class="sd">    Returns:</span>
<span class="sd">        str: An MDAnalysis selection string, representing the carbon-alphas surrounding the cores.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tlc</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;structure&quot;</span><span class="p">][</span><span class="s2">&quot;tlc&quot;</span><span class="p">]</span>
    <span class="n">ccs</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;structure&quot;</span><span class="p">][</span><span class="s2">&quot;ccs&quot;</span><span class="p">]</span>
    <span class="n">cc_names_selection</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># limit ligand group to common core by way of selection string</span>

    <span class="k">for</span> <span class="n">ccname</span> <span class="ow">in</span> <span class="n">ccs</span><span class="p">:</span>
        <span class="n">cc_names_selection</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;name </span><span class="si">{</span><span class="n">ccname</span><span class="si">}</span><span class="s2"> or &quot;</span>
    <span class="n">cc_names_selection</span> <span class="o">=</span> <span class="n">cc_names_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

    <span class="n">selstr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(sphlayer 5 15 (</span><span class="si">{</span><span class="n">cc_names_selection</span><span class="si">}</span><span class="s2">)) and name CA and protein&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Common core selection string: </span><span class="si">{</span><span class="n">selstr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">selstr</span>


<span class="k">def</span> <span class="nf">generate_extremities</span><span class="p">(</span>
    <span class="n">configuration</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span> <span class="n">n_extremities</span><span class="p">,</span> <span class="n">sphinner</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sphouter</span><span class="o">=</span><span class="mi">5</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes the common core and generates n extremities at the furthest point</span>

<span class="sd">        Returns a selection string of the extremities with a sphlayer (see MDAnalysis docs) selecting type C from sphinner to sphouter.</span>
<span class="sd">        The algorithm works as follows:</span>

<span class="sd">        (**All of these operations only operate on carbons in the common core**)</span>


<span class="sd">        1. Take the furthest C from the center of Mass.</span>

<span class="sd">        2. Take the furthest C from that C.</span>

<span class="sd">        3. Until len(extremity_cores)==n_extremities:</span>

<span class="sd">            Pick the C where the sum distance from all previous cores is greatest.</span>

<span class="sd">            Add it to the extremity_cores.</span>

<span class="sd">        4. Generate selection strings for all extremity cores and return.</span>

<span class="sd">    Args:</span>
<span class="sd">        configuration (dict): the read-in restraints.yaml</span>
<span class="sd">        topology (MDAnalysis.Universe): MDAnalysis.Universe object used to generate ligand geometries</span>
<span class="sd">        n_extremities (int): how many extremities to generate. Cannot exceed number of carbons in the ligand</span>
<span class="sd">        sphinner (float): Distance to start of the sphlayer, default 0</span>
<span class="sd">        sphouter (float): Distance to end of the sphlayer, default 5</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If an invalid amount of extremities is specified.</span>

<span class="sd">    Returns:</span>
<span class="sd">        [selection_strings,extremity_cores]: A nested array of MDAnalysis selection strings representing the selected extremities and its vicinity as defined by sphlayer and an array of the found extremity cores</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ligand_topology</span> <span class="o">=</span> <span class="n">topology</span>
    <span class="n">tlc</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;structure&quot;</span><span class="p">][</span><span class="s2">&quot;tlc&quot;</span><span class="p">]</span>
    <span class="n">ccs</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;structure&quot;</span><span class="p">][</span><span class="s2">&quot;ccs&quot;</span><span class="p">]</span>
    <span class="n">cc_names_selection</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># limit ligand group to common core by way of selection string</span>

    <span class="k">for</span> <span class="n">ccname</span> <span class="ow">in</span> <span class="n">ccs</span><span class="p">:</span>
        <span class="n">cc_names_selection</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;name </span><span class="si">{</span><span class="n">ccname</span><span class="si">}</span><span class="s2"> or &quot;</span>
    <span class="n">cc_names_selection</span> <span class="o">=</span> <span class="n">cc_names_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Common core selection string: </span><span class="si">{</span><span class="n">cc_names_selection</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ligand_group</span> <span class="o">=</span> <span class="n">ligand_topology</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;resname </span><span class="si">{</span><span class="n">tlc</span><span class="si">}</span><span class="s2"> and type C and (</span><span class="si">{</span><span class="n">cc_names_selection</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>

    <span class="n">ligand_com</span> <span class="o">=</span> <span class="n">ligand_group</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">()</span>
    <span class="n">carbon_distances</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_extremities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Impossible value for generation of extremities: </span><span class="si">{</span><span class="n">n_extremities</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_extremities</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligand_group</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Impossible to generate extremity restraints: too many restraints demanded (</span><span class="si">{</span><span class="n">n_extremities</span><span class="si">}</span><span class="s2">) vs. carbons in common core </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ligand_group</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Algorithm to find extremities:</span>
    <span class="c1"># Takes center of mass of common core. Finds furthest C from that</span>
    <span class="c1"># For n=2: finds furthest C from the previous C</span>
    <span class="c1"># For n=3: finds C, where the sum of distances to the previous furthest C is highest</span>
    <span class="c1"># For n=n: finds C, where the sum of distances of all previously found C is highest</span>

    <span class="n">extremity_cores</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># array containing the centers of extremity</span>
    <span class="c1"># Find the furthest C in the common core as starting point</span>
    <span class="k">for</span> <span class="n">carbon</span> <span class="ow">in</span> <span class="n">ligand_group</span><span class="p">:</span>
        <span class="n">distance_from_com</span> <span class="o">=</span> <span class="n">get3DDistance</span><span class="p">(</span><span class="n">ligand_com</span><span class="p">,</span> <span class="n">carbon</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="n">carbon_distances</span><span class="p">[</span><span class="n">carbon</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_from_com</span>

    <span class="c1"># Remove furthest C from group and add it to the extremity core</span>

    <span class="n">cs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">carbon_distances</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">carbon_distances</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">furthest_carbon</span> <span class="o">=</span> <span class="n">ligand_group</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;name </span><span class="si">{</span><span class="n">cs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ligand_group</span> <span class="o">=</span> <span class="n">ligand_group</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;not name </span><span class="si">{</span><span class="n">furthest_carbon</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">extremity_cores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">furthest_carbon</span><span class="p">)</span>

    <span class="c1"># For all other extremities - iterate over core distances, repeat process</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_extremities</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Doing Extremity number </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">total_distances</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">carbon</span> <span class="ow">in</span> <span class="n">ligand_group</span><span class="p">:</span>
            <span class="n">total_distances</span><span class="p">[</span><span class="n">carbon</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">core</span> <span class="ow">in</span> <span class="n">extremity_cores</span><span class="p">:</span>
                <span class="c1"># Calculates the sum distance to all established cores</span>
                <span class="n">total_distances</span><span class="p">[</span><span class="n">carbon</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="n">get3DDistance</span><span class="p">(</span>
                    <span class="n">core</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">carbon</span><span class="o">.</span><span class="n">position</span>
                <span class="p">)</span>

        <span class="c1"># sort carbons by distances, get one with furthest distance, add to extremity_cores, remove it from ligand_group</span>

        <span class="n">cs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">total_distances</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">total_distances</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">resulting_carbon</span> <span class="o">=</span> <span class="n">ligand_group</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;name </span><span class="si">{</span><span class="n">cs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ligand_group</span> <span class="o">=</span> <span class="n">ligand_group</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;not name </span><span class="si">{</span><span class="n">resulting_carbon</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">extremity_cores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resulting_carbon</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Cores found for extremity_cores: </span><span class="si">{</span><span class="p">[</span><span class="n">carbon</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">carbon</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">extremity_cores</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Create selection strings to return</span>
    <span class="n">selection_strings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">core</span> <span class="ow">in</span> <span class="n">extremity_cores</span><span class="p">:</span>
        <span class="n">selection_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;name </span><span class="si">{</span><span class="n">core</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> or ((sphlayer </span><span class="si">{</span><span class="n">sphinner</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sphouter</span><span class="si">}</span><span class="s2"> name </span><span class="si">{</span><span class="n">core</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> and resname </span><span class="si">{</span><span class="n">tlc</span><span class="si">}</span><span class="s2">) and type C)&quot;</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created extremities with selections: </span><span class="si">{</span><span class="n">selection_strings</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">selection_strings</span><span class="p">,</span> <span class="n">extremity_cores</span>


<span class="k">def</span> <span class="nf">create_restraints_from_config</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="n">pdbpath</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes the restraints.yaml config and returns the specified restraints.</span>

<span class="sd">    This is the function that should be invoked by openmm_run.py.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (dict): the loaded yaml config (as returned by yaml.safe_load() or similar</span>

<span class="sd">    Returns:</span>
<span class="sd">        array: An array of Restraint instances</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">universe</span> <span class="o">=</span> <span class="n">MDAnalysis</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span><span class="n">pdbpath</span><span class="p">)</span>

    <span class="n">tlc</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;structure&quot;</span><span class="p">][</span><span class="s2">&quot;tlc&quot;</span><span class="p">]</span>

    <span class="n">restraints</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># parse config arguments and pass to restraint generation:</span>
    <span class="n">restraint_command_string</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;restraints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">restraint_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;simple&quot;</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">restraint_command_string</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;k=&quot;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="n">kval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">restraint_args</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kval</span> <span class="o">*</span> <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;intst&quot;</span><span class="p">][</span><span class="s2">&quot;scaling&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;extremities=&quot;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="n">restraint_args</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;extremities&quot;</span>
            <span class="n">restraint_args</span><span class="p">[</span><span class="s2">&quot;n_extremities&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s2">&quot;shape=&quot;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="n">restraint_args</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">elif</span> <span class="s2">&quot;wellsize=&quot;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="n">restraint_args</span><span class="p">[</span><span class="s2">&quot;wellsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="s2">&quot;auto&quot;</span> <span class="ow">in</span> <span class="n">restraint_command_string</span> <span class="ow">and</span> <span class="n">restraint_args</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;simple&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;generating simple selection&quot;</span><span class="p">)</span>
        <span class="n">selstr</span> <span class="o">=</span> <span class="n">generate_simple_selection</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
        <span class="n">restraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Restraint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;resname </span><span class="si">{</span><span class="n">tlc</span><span class="si">}</span><span class="s2"> and type C&quot;</span><span class="p">,</span> <span class="n">selstr</span><span class="p">,</span> <span class="n">universe</span><span class="p">,</span> <span class="o">**</span><span class="n">restraint_args</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="s2">&quot;auto&quot;</span> <span class="ow">in</span> <span class="n">restraint_command_string</span> <span class="ow">and</span> <span class="n">restraint_args</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;extremities&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;generating extremity selections&quot;</span><span class="p">)</span>
        <span class="n">selection_strings</span><span class="p">,</span> <span class="n">extremity_cores</span> <span class="o">=</span> <span class="n">generate_extremities</span><span class="p">(</span>
            <span class="n">configuration</span><span class="p">,</span> <span class="n">universe</span><span class="p">,</span> <span class="n">restraint_args</span><span class="p">[</span><span class="s2">&quot;n_extremities&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">selection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selection_strings</span><span class="p">):</span>
            <span class="n">restraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Restraint</span><span class="p">(</span>
                    <span class="n">selection</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;(sphlayer 3 10 (</span><span class="si">{</span><span class="n">selection</span><span class="si">}</span><span class="s2">)) and name CA&quot;</span><span class="p">,</span>
                    <span class="n">universe</span><span class="p">,</span>
                    <span class="n">ex_core</span><span class="o">=</span><span class="n">extremity_cores</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="o">**</span><span class="n">restraint_args</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># At this point only automatic ex-restraints exist, so no need to filter restraints</span>
        <span class="n">ex_cores</span> <span class="o">=</span> <span class="p">[</span><span class="n">restraint</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ex_core&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">restraint</span> <span class="ow">in</span> <span class="n">restraints</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="mi">15</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Available cores for assignment: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ex_cores</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">assign_atom</span><span class="p">(</span><span class="n">atom</span><span class="p">:</span> <span class="n">MDAnalysis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">Atom</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Inner function to assign an atom involved in multiple restraint ligand groups to a single one.</span>

<span class="sd">            The restraint with the geometrically closest core will be chosen and the atom deleted from all others.</span>


<span class="sd">            Args:</span>
<span class="sd">            atom: The duplicate atom to reassign.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="c1"># Sort cores by distance to duplicate atom</span>
            <span class="k">for</span> <span class="n">core</span> <span class="ow">in</span> <span class="n">ex_cores</span><span class="p">:</span>
                <span class="n">distances</span><span class="p">[</span><span class="n">core</span><span class="p">]</span> <span class="o">=</span> <span class="n">get3DDistance</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

                <span class="n">sorted_distances</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">distances</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sorted Distances: </span><span class="si">{</span><span class="n">sorted_distances</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># get closest core. Remove duplicate atom from g1 in all restraints that do not have the closest core as core</span>
            <span class="n">closest</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sorted_distances</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">restraint</span> <span class="ow">in</span> <span class="n">restraints</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">restraint</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ex_core&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ix</span> <span class="o">!=</span> <span class="n">closest</span><span class="o">.</span><span class="n">ix</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing </span><span class="si">{</span><span class="n">atom</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">restraint</span><span class="o">.</span><span class="n">g1</span> <span class="o">=</span> <span class="n">restraint</span><span class="o">.</span><span class="n">g1</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>

        <span class="c1"># Check for duplicates in the ligand group g1</span>
        <span class="n">all_restraint_atoms</span> <span class="o">=</span> <span class="n">restraints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">g1</span>
        <span class="k">for</span> <span class="n">restraint</span> <span class="ow">in</span> <span class="n">restraints</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">all_restraint_atoms</span> <span class="o">+=</span> <span class="n">restraint</span><span class="o">.</span><span class="n">g1</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;All restraint atoms: </span><span class="si">{</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">atom</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">all_restraint_atoms</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">duplicate_restraint_atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">atom</span>
                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">all_restraint_atoms</span>
                <span class="k">if</span> <span class="n">all_restraint_atoms</span><span class="o">.</span><span class="n">ix</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">ix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># uniquify via set</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Duplicate restraint atoms: </span><span class="si">{</span><span class="n">duplicate_restraint_atoms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Remove duplicate atoms</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">duplicate_restraint_atoms</span><span class="p">:</span>
            <span class="n">assign_atom</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;manual&quot;</span> <span class="ow">in</span> <span class="n">restraint_command_string</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;generating manual selections&quot;</span><span class="p">)</span>
        <span class="n">manual_restraint_list</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;manualrestraints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Manual restraints defined: </span><span class="si">{</span><span class="n">manual_restraint_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">manual_restraint_list</span><span class="p">:</span>
            <span class="n">restraint</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;manualrestraints&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
            <span class="n">restraint_kw</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">restraint</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">restraint_kw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">restraint</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keywords for </span><span class="si">{</span><span class="n">restraint</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">restraint_kw</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">restraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Restraint</span><span class="p">(</span>
                    <span class="n">restraint</span><span class="p">[</span><span class="s2">&quot;group1&quot;</span><span class="p">],</span> <span class="n">restraint</span><span class="p">[</span><span class="s2">&quot;group2&quot;</span><span class="p">],</span> <span class="n">universe</span><span class="p">,</span> <span class="o">**</span><span class="n">restraint_kw</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">restraints</span>


<span class="k">def</span> <span class="nf">write_restraints_yaml</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">current_step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes the full config as read in in utils.py, the information for the intstate and writes the restraints.yaml.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: the path to write to (e.g. ./combinedstructure/structure/intst2/restraints.yaml</span>
<span class="sd">        system: the system object from state.py</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">transformato.mutate</span> <span class="kn">import</span> <span class="n">cc_names_struc1</span><span class="p">,</span> <span class="n">cc_names_struc2</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">cc_names_struc1</span><span class="p">)</span>
    <span class="n">restraints_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;intst&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;structure&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;tlc&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">system</span><span class="o">.</span><span class="n">tlc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}},</span>
        <span class="s2">&quot;simulation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;restraints&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;simulation&#39;</span><span class="p">][</span><span class="s1">&#39;restraints&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="s2">&quot;scaling&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;restraints&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">current_step</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lambda_value_scaling</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">current_step</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">lambda_value_scaling</span> <span class="o">=</span> <span class="mf">0.25</span>
        <span class="k">elif</span> <span class="n">current_step</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">lambda_value_scaling</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">elif</span> <span class="n">current_step</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">lambda_value_scaling</span> <span class="o">=</span> <span class="mf">0.75</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lambda_value_scaling</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lambda_value_scaling</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">restraints_dict</span><span class="p">[</span><span class="s2">&quot;intst&quot;</span><span class="p">][</span><span class="s2">&quot;scaling&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lambda_value_scaling</span>
    <span class="k">if</span> <span class="s2">&quot;manual&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;restraints&quot;</span><span class="p">]:</span>
        <span class="n">restraints_dict</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;manualrestraints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span>
            <span class="s2">&quot;manualrestraints&quot;</span>
        <span class="p">]</span>
    <span class="k">if</span> <span class="n">system</span><span class="o">.</span><span class="n">structure</span> <span class="o">==</span> <span class="s2">&quot;structure1&quot;</span><span class="p">:</span>
        <span class="n">restraints_dict</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;structure&quot;</span><span class="p">][</span><span class="s2">&quot;ccs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc_names_struc1</span>
    <span class="k">elif</span> <span class="n">system</span><span class="o">.</span><span class="n">structure</span> <span class="o">==</span> <span class="s2">&quot;structure2&quot;</span><span class="p">:</span>
        <span class="n">restraints_dict</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;structure&quot;</span><span class="p">][</span><span class="s2">&quot;ccs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc_names_struc2</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">restraints_dict</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">resyaml</span><span class="p">:</span>
        <span class="n">resyaml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">resyaml</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Marcus Wieder, Johannes Karwounopoulos, Stefan Boresch. Project structure based on the Computational Molecular Science Python Cookiecutter version 1.1.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>