* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v3.5 on Aug, 12. 2021. JOBID=2875961067
* SOLVATE PROTEIN IN WATER BOX
*

DIMENS CHSIZE 5000000 MAXRES 3000000

! Read topology and parameter files
stream toppar.str

! Read PSF and Coordinates
open read unit 10 card name step1_pdbreader.psf
read psf  unit 10 card

open read unit 10 card name step1_pdbreader.crd
read coor unit 10 card

!Reorient Solute (should be here)
coor orient 
coor stat sele all end
!Read Water in
stream step2.1_waterbox.str

open read card unit 30 name step2.1_waterbox.crd
read coor card unit 30 append
close unit 30

!
! Add ions?
!

stream step2.2_ions.str

read psf  card name step2.2_ions.psf append
read coor card name step2.2_ions.crd append

!
! Remove water molecules close to or overlapped with 
! biomolecule, crystal water, and generated ions
!

define TOTO sele .not. hydrogen .and. .not. segid SOLV end
if ?nsel .gt. 0 then
    define target sele .byres. ( ( type OH2 .and. segid SOLV ) .and. ( TOTO .around. 2.8 ) ) end
    if ?nsel .gt. 0 delete atom sele target end
    set filltube = no
    if @filltube .eq. yes goto skipdelw
    if @?imtube .eq. 1 then
        if @imtube .eq. yes then
            if pbc .eq. x then
                scalar wmain = y
                scalar wmain POW2r
                scalar wmain store 1
                scalar wmain = z
                scalar wmain POW2r
                scalar wmain +store 1
                scalar wmain recall 1
                scalar wmain sqrt
                define target select .byres. ( ( type OH2 .and. segid SOLV ) .and. ( prop wmain .lt. @rtube ) ) end
                if ?nsel .gt. 0 delete atom select target end
            endif

            if pbc .eq. y then
                scalar wmain = x
                scalar wmain POW2r
                scalar wmain store 1
                scalar wmain = z
                scalar wmain POW2r
                scalar wmain +store 1
                scalar wmain recall 1
                scalar wmain sqrt
                define target select .byres. ( ( type OH2 .and. segid SOLV ) .and. ( prop wmain .lt. @rtube ) ) end
                if ?nsel .gt. 0 delete atom select target end
            endif

            if pbc .eq. z then
               scalar wmain = x
               scalar wmain POW2r
               scalar wmain store 1
               scalar wmain = y
               scalar wmain POW2r
               scalar wmain +store 1
               scalar wmain recall 1
               scalar wmain sqrt
               define target select .byres. ( ( type OH2 .and. segid SOLV ) .and. ( prop wmain .lt. @rtube ) ) end
               if ?nsel .gt. 0 delete atom select target end
            endif
      endif
   endif
   label skipdelw
   join SOLV renumber
endif
coor stat sele type OH2 .and. segid SOLV end
set nwater ?nsel

!
! Write coordinates and information of solvated system
!

open write unit 10 card name step2_solvator.psf
write psf  unit 10 card

open write card unit 10 name step2_solvator.pdb
write coor pdb  unit 10 

open write unit 10 card name step2_solvator.crd
write coor unit 10 card

open write unit 90 card name step2_solvator.str
write title unit 90
** assembly settings
**
* read sequence TIP3 @nwater
* generate SOLV setup noangle nodihedral
* set npostot = @npostot
* set nnegtot = @nnegtot
* set niontot = @niontot
* stream step2.2_ions.str
*

stop
