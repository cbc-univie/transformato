<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>transformato.analysis &mdash; transformato  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/logo_transformato.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../System_Setup.html">System Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Running_Simulation.html">Running Simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Analysis.html">Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">transformato</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>transformato.analysis</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for transformato.analysis</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">starmap</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">MDAnalysis</span>
<span class="kn">import</span> <span class="nn">mdtraj</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">pymbar</span> <span class="kn">import</span> <span class="n">mbar</span>
<span class="kn">from</span> <span class="nn">simtk</span> <span class="kn">import</span> <span class="n">unit</span>
<span class="kn">from</span> <span class="nn">simtk.openmm</span> <span class="kn">import</span> <span class="n">Platform</span><span class="p">,</span> <span class="n">XmlSerializer</span><span class="p">,</span> <span class="n">vec3</span>
<span class="kn">from</span> <span class="nn">simtk.openmm.app</span> <span class="kn">import</span> <span class="n">CharmmPsfFile</span><span class="p">,</span> <span class="n">Simulation</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">transformato.constants</span> <span class="kn">import</span> <span class="n">temperature</span>
<span class="kn">from</span> <span class="nn">transformato.utils</span> <span class="kn">import</span> <span class="n">get_structure_name</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="return_reduced_potential"><a class="viewcode-back" href="../../api.html#transformato.analysis.return_reduced_potential">[docs]</a><span class="k">def</span> <span class="nf">return_reduced_potential</span><span class="p">(</span>
    <span class="n">potential_energy</span><span class="p">:</span> <span class="n">unit</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span>
    <span class="n">volume</span><span class="p">:</span> <span class="n">unit</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n">unit</span><span class="o">.</span><span class="n">Quantity</span> <span class="o">=</span> <span class="n">temperature</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Retrieve the reduced potential for a given context.</span>
<span class="sd">    The reduced potential is defined as in Ref. [1]</span>
<span class="sd">    u = \beta [U(x) + p V(x)]</span>
<span class="sd">    where the thermodynamic parameters are</span>
<span class="sd">    \beta = 1/(kB T) is the inverse temperature</span>
<span class="sd">    p is the pressure</span>
<span class="sd">    x the atomic positions</span>
<span class="sd">    U(x) is the potential energy</span>
<span class="sd">    V(x) is the instantaneous box volume</span>
<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] Shirts MR and Chodera JD. Statistically optimal analysis of</span>
<span class="sd">    equilibrium states. J Chem Phys 129:124105, 2008.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    potential_energy : simtk.unit of float</span>
<span class="sd">    context</span>
<span class="sd">    ensamble: NVT or NPT</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span> <span class="o">==</span> <span class="n">unit</span><span class="o">.</span><span class="n">Quantity</span>
    <span class="n">pressure</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">atmosphere</span>  <span class="c1"># atm</span>
    <span class="n">kB</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">BOLTZMANN_CONSTANT_kB</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">AVOGADRO_CONSTANT_NA</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">kB</span> <span class="o">*</span> <span class="n">temperature</span><span class="p">)</span>
    <span class="c1"># potential_energy += pressure * volume</span>
    <span class="k">return</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">potential_energy</span></div>


<div class="viewcode-block" id="FreeEnergyCalculator"><a class="viewcode-back" href="../../api.html#transformato.analysis.FreeEnergyCalculator">[docs]</a><span class="k">class</span> <span class="nc">FreeEnergyCalculator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FreeEnergyCalculator [summary]</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    object : [type]</span>
<span class="sd">        [description]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">structure_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span> <span class="o">=</span> <span class="n">configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure_name</span> <span class="o">=</span> <span class="n">structure_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="p">()</span>
        <span class="c1"># decide if the name of the system corresponds to structure1 or structure2</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">get_structure_name</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="n">structure_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;free-energy-type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rsfe&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">envs</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;vacuum&quot;</span><span class="p">,</span> <span class="s2">&quot;waterbox&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mbar_results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;waterbox&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="k">elif</span> <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;free-energy-type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rbfe&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">envs</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;complex&quot;</span><span class="p">,</span> <span class="s2">&quot;waterbox&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mbar_results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;waterbox&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;complex&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Either binding or solvation free energy.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;system_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">structure_name</span><span class="si">}</span><span class="s2">/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbar_results</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;waterbox&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;complex&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nr_of_states</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_k</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thinning</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_results_to_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;system_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/results/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traj_files</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<div class="viewcode-block" id="FreeEnergyCalculator.load_trajs"><a class="viewcode-back" href="../../api.html#transformato.analysis.FreeEnergyCalculator.load_trajs">[docs]</a>    <span class="k">def</span> <span class="nf">load_trajs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nr_of_max_snapshots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load trajectories, thin trajs and merge themn.</span>
<span class="sd">        Also calculate N_k for mbar.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">nr_of_max_snapshots</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nr_of_max_snapshots</span> <span class="o">=</span> <span class="n">nr_of_max_snapshots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unitcell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_of_states</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_trajs</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_generate_openMM_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lambda_state</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Simulation</span><span class="p">:</span>
        <span class="c1"># read in necessary files</span>
        <span class="n">conf_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">][</span><span class="n">env</span><span class="p">]</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/intst</span><span class="si">{</span><span class="n">lambda_state</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">conf_sub</span><span class="p">[</span><span class="s1">&#39;intermediate-filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_system.xml&quot;</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">XmlSerializer</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/intst</span><span class="si">{</span><span class="n">lambda_state</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">conf_sub</span><span class="p">[</span><span class="s1">&#39;intermediate-filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_integrator.xml&quot;</span>
        <span class="n">integrator</span> <span class="o">=</span> <span class="n">XmlSerializer</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">psf_file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/intst</span><span class="si">{</span><span class="n">lambda_state</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">conf_sub</span><span class="p">[</span><span class="s1">&#39;intermediate-filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.psf&quot;</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="n">CharmmPsfFile</span><span class="p">(</span><span class="n">psf_file_path</span><span class="p">)</span>

        <span class="c1"># generate simulations object and set states</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;GPU&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">platform</span> <span class="o">=</span> <span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span>
                <span class="s2">&quot;CUDA&quot;</span>
            <span class="p">)</span>  <span class="c1"># NOTE: FIXME: this needs to be set dynamically</span>
            <span class="n">platformProperties</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;CudaPrecision&quot;</span><span class="p">:</span> <span class="s2">&quot;mixed&quot;</span><span class="p">}</span>

            <span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span>
                <span class="n">psf</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">platform</span><span class="p">,</span> <span class="n">platformProperties</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">platform</span> <span class="o">=</span> <span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span>
                <span class="s2">&quot;CPU&quot;</span>
            <span class="p">)</span>  <span class="c1"># NOTE: FIXME: this needs to be set dynamically</span>
            <span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">psf</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>

        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setState</span><span class="p">(</span>
            <span class="n">XmlSerializer</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span>
                <span class="nb">open</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/intst</span><span class="si">{</span><span class="n">lambda_state</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">conf_sub</span><span class="p">[</span><span class="s1">&#39;intermediate-filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.rst&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;r&quot;</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">simulation</span>

    <span class="k">def</span> <span class="nf">_thinning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">any_list</span><span class="p">):</span>
        <span class="n">lenght</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">any_list</span><span class="p">))</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lenght</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">any_list</span> <span class="o">=</span> <span class="n">any_list</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span>  <span class="c1"># remove the first 25% confs</span>
        <span class="n">new_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">any_list</span><span class="p">))</span>
        <span class="n">further_thinning</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">new_length</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_of_max_snapshots</span><span class="p">),</span> <span class="mi">1</span>
        <span class="p">)</span>  <span class="c1"># thinning</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">any_list</span><span class="p">[::</span><span class="n">further_thinning</span><span class="p">][:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_of_max_snapshots</span><span class="p">],</span>
            <span class="n">start</span><span class="p">,</span>
            <span class="n">further_thinning</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_merge_trajs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load trajectories, thin trajs and merge themn.</span>
<span class="sd">        Also calculate N_k for mbar.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#############</span>
        <span class="c1"># set all file paths for potential</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="si">}</span><span class="s2"> does not exist. Aborting.&quot;</span><span class="p">)</span>

        <span class="n">nr_of_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluating </span><span class="si">{</span><span class="n">nr_of_states</span><span class="si">}</span><span class="s2"> states.&quot;</span><span class="p">)</span>
        <span class="n">snapshots</span><span class="p">,</span> <span class="n">unitcell</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="n">N_k</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">stride</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">:</span>
            <span class="n">confs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">unitcell_</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">conf_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">][</span><span class="n">env</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">lambda_state</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nr_of_states</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="n">dcd_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/intst</span><span class="si">{</span><span class="n">lambda_state</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">conf_sub</span><span class="p">[</span><span class="s1">&#39;intermediate-filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.dcd&quot;</span>
                <span class="n">psf_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/intst</span><span class="si">{</span><span class="n">lambda_state</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">conf_sub</span><span class="p">[</span><span class="s1">&#39;intermediate-filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.psf&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dcd_path</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dcd_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

                <span class="n">traj</span> <span class="o">=</span> <span class="n">mdtraj</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dcd_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># read trajs, determin offset, start ,stride and unitcell lengths</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">xyz</span><span class="p">,</span> <span class="n">unitcell_lengths</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">xyz</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stride</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thinning</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">traj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                    <span class="n">xyz</span><span class="p">,</span> <span class="n">unitcell_lengths</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">)</span>
                    <span class="n">xyz</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_of_max_snapshots</span><span class="p">]</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Len: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span><span class="si">}</span><span class="s2">, Start: </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">, Stride: </span><span class="si">{</span><span class="n">stride</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># check that we have enough samples</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Below 10 conformations per lambda (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span><span class="si">}</span><span class="s2">) -- decrease the thinning factor (currently: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">thinning</span><span class="si">}</span><span class="s2">).&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># thin unitcell_lengths</span>
                <span class="c1"># make sure that we can work with vacuum environments</span>
                <span class="k">if</span> <span class="n">env</span> <span class="o">!=</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">:</span>
                    <span class="n">unitcell_lengths</span> <span class="o">=</span> <span class="n">unitcell_lengths</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_of_max_snapshots</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">unitcell_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">))</span>

                <span class="n">confs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">xyz</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
                <span class="n">unitcell_</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">unitcell_lengths</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dcd_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nr of snapshots: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">N_k</span><span class="p">[</span><span class="n">env</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">traj_files</span><span class="p">[</span><span class="n">env</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dcd_path</span><span class="p">,</span> <span class="n">psf_path</span><span class="p">))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combined nr of snapshots: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">snapshots</span><span class="p">[</span><span class="n">env</span><span class="p">]</span> <span class="o">=</span> <span class="n">confs</span>
            <span class="n">unitcell</span><span class="p">[</span><span class="n">env</span><span class="p">]</span> <span class="o">=</span> <span class="n">unitcell_</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">unitcell_</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">N_k</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">snapshots</span><span class="p">,</span> <span class="n">unitcell</span><span class="p">,</span> <span class="n">nr_of_states</span><span class="p">,</span> <span class="n">N_k</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_energy_at_ts</span><span class="p">(</span>
        <span class="n">simulation</span><span class="p">:</span> <span class="n">Simulation</span><span class="p">,</span> <span class="n">configuration</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unitcell_lengths</span><span class="p">:</span> <span class="nb">list</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the potential energy with the correct periodic boundary conditions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">env</span> <span class="o">!=</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">:</span>
            <span class="n">bxl_x</span> <span class="o">=</span> <span class="n">unitcell_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span>
            <span class="n">bxl_y</span> <span class="o">=</span> <span class="n">unitcell_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span>
            <span class="n">bxl_z</span> <span class="o">=</span> <span class="n">unitcell_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span>

            <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span>
                <span class="n">vec3</span><span class="o">.</span><span class="n">Vec3</span><span class="p">(</span><span class="n">bxl_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">vec3</span><span class="o">.</span><span class="n">Vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bxl_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">vec3</span><span class="o">.</span><span class="n">Vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bxl_z</span><span class="p">)</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_V_for_ts</span><span class="p">(</span><span class="n">unitcell_lengths</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ts</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">:</span>
            <span class="n">volumn</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># extract the box size at the given ts</span>
            <span class="n">bxl_x</span> <span class="o">=</span> <span class="n">unitcell_lengths</span><span class="p">[</span><span class="n">ts</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span>
            <span class="n">bxl_y</span> <span class="o">=</span> <span class="n">unitcell_lengths</span><span class="p">[</span><span class="n">ts</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span>
            <span class="n">bxl_z</span> <span class="o">=</span> <span class="n">unitcell_lengths</span><span class="p">[</span><span class="n">ts</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span>

            <span class="n">volumn</span> <span class="o">=</span> <span class="n">bxl_x</span> <span class="o">*</span> <span class="n">bxl_y</span> <span class="o">*</span> <span class="n">bxl_z</span>
        <span class="k">return</span> <span class="n">volumn</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_parse_CHARMM_energy_output</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">math</span>

        <span class="n">pot_energies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/ener_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.log&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">999999.0</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">or</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">999999.0</span><span class="p">)</span>

                <span class="n">v</span> <span class="o">*=</span> <span class="n">unit</span><span class="o">.</span><span class="n">kilocalorie_per_mole</span>
                <span class="n">pot_energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pot_energies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span>
        <span class="k">return</span> <span class="n">pot_energies</span>

    <span class="k">def</span> <span class="nf">calculate_dG_using_mbar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u_kn</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">N_k</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;#######################################&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Pairwise Free Energy Estimate&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;#######################################&quot;</span><span class="p">)</span>
        <span class="n">u_kn_</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">u_kn</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">u_kn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">nr_of_snapshots</span> <span class="o">=</span> <span class="n">N_k</span><span class="p">[</span><span class="n">env</span><span class="p">][</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">N_k</span><span class="p">[</span><span class="n">env</span><span class="p">][</span><span class="n">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">u_kn_</span> <span class="o">=</span> <span class="n">u_kn</span><span class="p">[</span><span class="n">d</span> <span class="p">:</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">:,</span> <span class="n">start</span> <span class="p">:</span> <span class="n">start</span> <span class="o">+</span> <span class="n">nr_of_snapshots</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mbar</span><span class="o">.</span><span class="n">MBAR</span><span class="p">(</span><span class="n">u_kn_</span><span class="p">,</span> <span class="n">N_k</span><span class="p">[</span><span class="n">env</span><span class="p">][</span><span class="n">d</span> <span class="p">:</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">getFreeEnergyDifferences</span><span class="p">(</span><span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s2">&quot;Delta_f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">getFreeEnergyDifferences</span><span class="p">(</span><span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s2">&quot;dDelta_f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

            <span class="n">start</span> <span class="o">+=</span> <span class="n">N_k</span><span class="p">[</span><span class="n">env</span><span class="p">][</span><span class="n">d</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;#######################################&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mbar</span><span class="o">.</span><span class="n">MBAR</span><span class="p">(</span><span class="n">u_kn</span><span class="p">,</span> <span class="n">N_k</span><span class="p">[</span><span class="n">env</span><span class="p">],</span> <span class="n">initialize</span><span class="o">=</span><span class="s2">&quot;BAR&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_evaluate_traj_with_CHARMM</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">volumn_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">charmm_exe</span> <span class="o">=</span> <span class="s2">&quot;charmm&quot;</span>
        <span class="n">script_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;waterbox&quot;</span> <span class="ow">or</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;complex&quot;</span><span class="p">:</span>
            <span class="n">script_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;charmm_evaluate_energy_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.inp&quot;</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumn_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">:</span>
            <span class="n">script_name</span> <span class="o">=</span> <span class="s2">&quot;charmm_evaluate_energy_in_</span><span class="si">{env}</span><span class="s2">.inp&quot;</span>

        <span class="n">top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">][</span><span class="n">env</span><span class="p">][</span><span class="s2">&quot;intermediate-filename&quot;</span><span class="p">]</span>

        <span class="n">exe</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;bash&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;bin_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/charmm_eval_energy.sh&quot;</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">top</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">script_name</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">charmm_exe</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;latin1&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># path=$1     # path in which the simulation will start</span>
        <span class="c1"># top=$2      # top file to use</span>
        <span class="c1"># script=$3   # which script is called</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/eval_charmm_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Capture stdout&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">exe</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Capture stderr&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">exe</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

        <span class="n">pot_energies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_CHARMM_energy_output</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of entries in pot_energies list: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pot_energies</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of entries in pot_energies list: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volumn_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env</span> <span class="o">!=</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pot_energies</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumn_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">volumn_list</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumn_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pot_energies</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">return_reduced_potential</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="n">V</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">V</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pot_energies</span><span class="p">,</span> <span class="n">volumn_list</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">return_reduced_potential</span><span class="p">(</span>
                    <span class="n">e</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">pot_energies</span>
            <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_evaluate_e_on_all_snapshots_CHARMM</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">snapshots</span><span class="p">:</span> <span class="n">mdtraj</span><span class="o">.</span><span class="n">Trajectory</span><span class="p">,</span> <span class="n">lambda_state</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;waterbox&quot;</span> <span class="ow">or</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;complex&quot;</span><span class="p">:</span>
            <span class="n">unitcell_lengths</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span>
                    <span class="n">snapshots</span><span class="o">.</span><span class="n">unitcell_lengths</span><span class="p">[</span><span class="n">ts</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">snapshots</span><span class="o">.</span><span class="n">unitcell_lengths</span><span class="p">[</span><span class="n">ts</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">snapshots</span><span class="o">.</span><span class="n">unitcell_lengths</span><span class="p">[</span><span class="n">ts</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snapshots</span><span class="p">))</span>
            <span class="p">]</span>

            <span class="n">volumn_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_V_for_ts</span><span class="p">(</span><span class="n">unitcell_lengths</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snapshots</span><span class="o">.</span><span class="n">n_frames</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="k">elif</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">:</span>
            <span class="n">volumn_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_traj_with_CHARMM</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/intst</span><span class="si">{</span><span class="n">lambda_state</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="n">volumn_list</span><span class="o">=</span><span class="n">volumn_list</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_evaluate_e_on_all_snapshots_openMM</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">xyz_array</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">unitcell_lengths</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">lambda_state</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;call for single processor run&quot;&quot;&quot;</span>

        <span class="n">simulation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_openMM_system</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">lambda_state</span><span class="o">=</span><span class="n">lambda_state</span><span class="p">)</span>
        <span class="c1"># reference shared memory trajectory</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_e_with_openMM</span><span class="p">(</span>
            <span class="n">xyz_array</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">unitcell_lengths</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_evaluate_e_with_openMM</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">xyz_array</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">simulation</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">unitcell_lengths</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This function will be called from the mutliprocessing AND the single processor computational route&quot;&quot;&quot;</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">volumn_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_V_for_ts</span><span class="p">(</span><span class="n">unitcell_lengths</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_array</span><span class="p">))</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">:</span>
            <span class="n">unitcell_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz_array</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_array</span><span class="p">))):</span>
            <span class="c1"># calculate the potential energy</span>
            <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energy_at_ts</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span> <span class="n">xyz_array</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span> <span class="n">env</span><span class="p">,</span> <span class="n">unitcell_lengths</span><span class="p">[</span><span class="n">ts</span><span class="p">])</span>
            <span class="c1"># obtain the reduced potential (for NpT)</span>
            <span class="n">red_e</span> <span class="o">=</span> <span class="n">return_reduced_potential</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">volumn_list</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span> <span class="n">temperature</span><span class="p">)</span>
            <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">red_e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">energies</span>

    <span class="k">def</span> <span class="nf">energy_at_lambda</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">lambda_state</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nr_of_max_snapshots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">in_memory</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>

        <span class="n">gc</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysing lambda state </span><span class="si">{</span><span class="n">lambda_state</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nr_of_states</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">conf_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">][</span><span class="n">env</span><span class="p">]</span>
        <span class="n">simulation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_openMM_system</span><span class="p">(</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">lambda_state</span><span class="o">=</span><span class="n">lambda_state</span>
        <span class="p">)</span>  <span class="c1"># Simulation context for openMM</span>
        <span class="c1"># we iterate over all available lambda_states for each simulation contex (different psf file)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_k</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">lambda_state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_of_states</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>

            <span class="n">dcd_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/intst</span><span class="si">{</span><span class="n">lambda_state</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">conf_sub</span><span class="p">[</span><span class="s1">&#39;intermediate-filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.dcd&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dcd_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dcd_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

            <span class="n">traj</span> <span class="o">=</span> <span class="n">MDAnalysis</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/intst</span><span class="si">{</span><span class="n">lambda_state</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">conf_sub</span><span class="p">[</span><span class="s1">&#39;intermediate-filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.psf&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dcd_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">in_memory</span><span class="o">=</span><span class="n">in_memory</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># simple thinning of the Trajectory</span>
            <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.25</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">trajectory</span><span class="p">))</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">nr_of_max_snapshots</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N_k</span><span class="p">[</span><span class="n">env</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">trajectory</span><span class="p">[</span><span class="n">start</span><span class="p">::</span><span class="n">skip</span><span class="p">]))</span>
            <span class="c1"># trajectory = self._thinning_traj(traj.trajectory)</span>
            <span class="c1"># self.N_k[env].append(len(trajectory))</span>

            <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">trajectory</span><span class="p">[</span><span class="n">start</span><span class="p">::</span><span class="n">skip</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">env</span> <span class="o">!=</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">:</span>
                    <span class="n">bxl_x</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span>
                    <span class="n">bxl_y</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span>
                    <span class="n">bxl_z</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span>

                    <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span>
                        <span class="n">vec3</span><span class="o">.</span><span class="n">Vec3</span><span class="p">(</span><span class="n">bxl_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">vec3</span><span class="o">.</span><span class="n">Vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bxl_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">vec3</span><span class="o">.</span><span class="n">Vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bxl_z</span><span class="p">)</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bxl_x</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">bxl_y</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">bxl_z</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">((</span><span class="n">ts</span><span class="o">.</span><span class="n">positions</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span>

                <span class="n">red_e</span> <span class="o">=</span> <span class="n">return_reduced_potential</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">red_e</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status before collection: </span><span class="si">{</span><span class="n">gc</span><span class="o">.</span><span class="n">get_count</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;are we following traj: </span><span class="si">{</span><span class="n">gc</span><span class="o">.</span><span class="n">is_tracked</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">traj</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>  <span class="c1"># only important when using in_memory = True for GPU support</span>
            <span class="c1"># gc.disable()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status after collection: </span><span class="si">{</span><span class="n">gc</span><span class="o">.</span><span class="n">get_count</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">energies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_k</span>

    <span class="k">def</span> <span class="nf">_analyse_results_using_mda</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">save_results</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">engine</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">num_proc</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">nr_of_max_snapshots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">in_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluating with </span><span class="si">{</span><span class="n">engine</span><span class="si">}</span><span class="s2">, using </span><span class="si">{</span><span class="n">num_proc</span><span class="si">}</span><span class="s2"> CPUs&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nr_of_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">engine</span> <span class="o">==</span> <span class="s2">&quot;openMM&quot;</span><span class="p">:</span>
            <span class="c1"># for multiprocessing</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;fork&quot;</span><span class="p">)</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_proc</span><span class="p">)</span>
            <span class="c1"># for each lambda step all trajectories are read in for each intst state</span>

            <span class="n">r</span><span class="p">,</span> <span class="n">N_k</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="o">*</span><span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">energy_at_lambda</span><span class="p">,</span>
                    <span class="nb">zip</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">lambda_state</span>
                            <span class="k">for</span> <span class="n">lambda_state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_of_states</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="p">],</span>
                        <span class="n">repeat</span><span class="p">(</span><span class="n">env</span><span class="p">),</span>
                        <span class="n">repeat</span><span class="p">(</span><span class="n">nr_of_max_snapshots</span><span class="p">),</span>
                        <span class="n">repeat</span><span class="p">(</span><span class="n">in_memory</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">u_kn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">r_i</span> <span class="k">for</span> <span class="n">r_i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>  <span class="c1"># not sure if needed!</span>
            <span class="n">N_k</span> <span class="o">=</span> <span class="n">N_k</span><span class="p">[</span>
                <span class="mi">0</span>
            <span class="p">]</span>  <span class="c1"># necessary because python seems to forget about self.N_k declared in the energy_of_lambda function</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Currently only openMM is supported for the use with MDAnalysis, not </span><span class="si">{</span><span class="n">engine</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">save_results</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">save_results_to_path</span><span class="si">}</span><span class="s2">/mbar_data_for_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">structure_name</span><span class="si">}</span><span class="s2">_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.pickle&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving results: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;u_kn&quot;</span><span class="p">:</span> <span class="n">u_kn</span><span class="p">,</span> <span class="s2">&quot;N_k&quot;</span><span class="p">:</span> <span class="n">N_k</span><span class="p">}</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;wb+&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_dG_using_mbar</span><span class="p">(</span><span class="n">u_kn</span><span class="p">,</span> <span class="n">N_k</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_analyse_results_using_mdtraj</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">snapshots</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">unitcell</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">save_results</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">engine</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluating with </span><span class="si">{</span><span class="n">engine</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">engine</span> <span class="o">==</span> <span class="s2">&quot;openMM&quot;</span><span class="p">:</span>
            <span class="n">lambda_states</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">lambda_state</span> <span class="k">for</span> <span class="n">lambda_state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_of_states</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">xyz_array</span> <span class="o">=</span> <span class="n">snapshots</span>

            <span class="c1"># Decide if we want to use the multiprocessing library</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">starmap</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_e_on_all_snapshots_openMM</span><span class="p">,</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">xyz_array</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span> <span class="n">lambda_states</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">env</span><span class="p">)),</span>
            <span class="p">)</span>

            <span class="n">u_kn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">r_i</span> <span class="k">for</span> <span class="n">r_i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">engine</span> <span class="o">==</span> <span class="s2">&quot;CHARMM&quot;</span><span class="p">:</span>
            <span class="n">confs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># write out traj in self.base_path</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">dcd</span><span class="p">,</span> <span class="n">psf</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj_files</span><span class="p">[</span><span class="n">env</span><span class="p">]:</span>
                <span class="n">traj</span> <span class="o">=</span> <span class="n">mdtraj</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dcd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">top</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">psf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># return and append thinned trajs</span>
                <span class="n">traj</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thinning</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span>
                <span class="n">confs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span>

            <span class="n">joined_trajs</span> <span class="o">=</span> <span class="n">mdtraj</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">confs</span><span class="p">,</span> <span class="n">check_topology</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">joined_trajs</span><span class="o">.</span><span class="n">save_dcd</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/traj.dcd&quot;</span><span class="p">)</span>
            <span class="n">u_kn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_e_on_all_snapshots_CHARMM</span><span class="p">(</span>
                        <span class="n">joined_trajs</span><span class="p">,</span> <span class="n">lambda_state</span><span class="p">,</span> <span class="n">env</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">lambda_state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_of_states</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># remove merged traj</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/traj.dcd&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Either openMM or CHARMM engine, not </span><span class="si">{</span><span class="n">engine</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_results</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">save_results_to_path</span><span class="si">}</span><span class="s2">/mbar_data_for_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">structure_name</span><span class="si">}</span><span class="s2">_in_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.pickle&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving results: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;u_kn&quot;</span><span class="p">:</span> <span class="n">u_kn</span><span class="p">,</span> <span class="s2">&quot;N_k&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_k</span><span class="p">}</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;wb+&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_dG_using_mbar</span><span class="p">(</span><span class="n">u_kn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_k</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

<div class="viewcode-block" id="FreeEnergyCalculator.calculate_dG_to_common_core"><a class="viewcode-back" href="../../api.html#transformato.analysis.FreeEnergyCalculator.calculate_dG_to_common_core">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_dG_to_common_core</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">save_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">engine</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;openMM&quot;</span><span class="p">,</span>
        <span class="n">analyze_traj_with</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mdtraj&quot;</span><span class="p">,</span>
        <span class="n">num_proc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">in_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">nr_of_max_snapshots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate mbar results using either the python package mdtraj</span>
<span class="sd">        or MDAnalysis or load save results from a serialized mbar results.</span>
<span class="sd">        MDTraj creates one big trajectory which is analysed with different psf.</span>
<span class="sd">        Can lead to high overload of memory but is very fast!</span>
<span class="sd">        In defult setup only ~3GB of RAM are allocated. Trjaectories can also</span>
<span class="sd">        be loaded into memory by setting in_memory = True that can be useful when</span>
<span class="sd">        analysing many snapshots per trajectory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">analyze_traj_with</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mda&quot;</span><span class="p">,</span> <span class="s2">&quot;mdtraj&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">save_results</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;system_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/results/&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving results in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">save_results_to_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating results for </span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">analyze_traj_with</span> <span class="o">==</span> <span class="s2">&quot;mda&quot;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">nr_of_max_snapshots</span> <span class="o">&gt;</span> <span class="mi">10</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mbar_results</span><span class="p">[</span><span class="n">env</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyse_results_using_mda</span><span class="p">(</span>
                    <span class="n">env</span><span class="p">,</span>
                    <span class="n">save_results</span><span class="p">,</span>
                    <span class="n">engine</span><span class="p">,</span>
                    <span class="n">num_proc</span><span class="p">,</span>
                    <span class="n">nr_of_max_snapshots</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">analyze_traj_with</span> <span class="o">==</span> <span class="s2">&quot;mdtraj&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mbar_results</span><span class="p">[</span><span class="n">env</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyse_results_using_mdtraj</span><span class="p">(</span>
                    <span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">env</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">unitcell</span><span class="p">[</span><span class="n">env</span><span class="p">],</span> <span class="n">save_results</span><span class="p">,</span> <span class="n">engine</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Either mda or mdtray&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">load_waterbox_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbar_results</span><span class="p">[</span><span class="s2">&quot;waterbox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_mbar_results</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_complex_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbar_results</span><span class="p">[</span><span class="s2">&quot;complex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_mbar_results</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_vacuum_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbar_results</span><span class="p">[</span><span class="s2">&quot;vacuum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_mbar_results</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_load_mbar_results</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mbar</span><span class="o">.</span><span class="n">MBAR</span><span class="p">(</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;u_kn&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;N_k&quot;</span><span class="p">],</span> <span class="n">initialize</span><span class="o">=</span><span class="s2">&quot;BAR&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

<div class="viewcode-block" id="FreeEnergyCalculator.free_energy_differences"><a class="viewcode-back" href="../../api.html#transformato.analysis.FreeEnergyCalculator.free_energy_differences">[docs]</a>    <span class="k">def</span> <span class="nf">free_energy_differences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="s2">&quot;vacuum&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;matrix of free energy differences&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbar_results</span><span class="p">[</span><span class="n">env</span><span class="p">]</span><span class="o">.</span><span class="n">getFreeEnergyDifferences</span><span class="p">(</span><span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span>
                <span class="s2">&quot;Delta_f&quot;</span>
            <span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Free energy difference not obtained for : </span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="FreeEnergyCalculator.free_energy_overlap"><a class="viewcode-back" href="../../api.html#transformato.analysis.FreeEnergyCalculator.free_energy_overlap">[docs]</a>    <span class="k">def</span> <span class="nf">free_energy_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="s2">&quot;vacuum&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;overlap of lambda states&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbar_results</span><span class="p">[</span><span class="n">env</span><span class="p">]</span><span class="o">.</span><span class="n">computeOverlap</span><span class="p">(</span><span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s2">&quot;matrix&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Free energy overlap not obtained for : </span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="FreeEnergyCalculator.free_energy_difference_uncertainties"><a class="viewcode-back" href="../../api.html#transformato.analysis.FreeEnergyCalculator.free_energy_difference_uncertainties">[docs]</a>    <span class="k">def</span> <span class="nf">free_energy_difference_uncertainties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="s2">&quot;vacuum&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;matrix of asymptotic uncertainty-estimates accompanying free energy differences&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbar_results</span><span class="p">[</span><span class="n">env</span><span class="p">]</span><span class="o">.</span><span class="n">getFreeEnergyDifferences</span><span class="p">(</span><span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span>
                <span class="s2">&quot;dDelta_f&quot;</span>
            <span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Free energy uncertanties not obtained for : </span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">waterbox_free_energy_differences</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;matrix of free energy differences&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_energy_differences</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="s2">&quot;waterbox&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">complex_free_energy_differences</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;matrix of free energy differences&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_energy_differences</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="s2">&quot;complex&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vacuum_free_energy_differences</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;matrix of free energy differences&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_energy_differences</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="s2">&quot;vacuum&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">waterbox_free_energy_difference_uncertanties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;matrix of free energy differences&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_energy_difference_uncertainties</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="s2">&quot;waterbox&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">complex_free_energy_difference_uncertanties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;matrix of free energy differences&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_energy_difference_uncertainties</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="s2">&quot;complex&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vacuum_free_energy_difference_uncertanties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;matrix of free energy differences&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_energy_difference_uncertainties</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="s2">&quot;vacuum&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">waterbox_free_energy_difference_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;matrix of free energy differences&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_energy_overlap</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="s2">&quot;waterbox&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">complex_free_energy_difference_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;matrix of free energy differences&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_energy_overlap</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="s2">&quot;complex&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vacuum_free_energy_difference_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;matrix of free energy differences&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_energy_overlap</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="s2">&quot;vacuum&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_free_energy_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_free_energy_difference_overlap</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;0.2f&quot;</span><span class="p">,</span>
                <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="s2">&quot;small&quot;</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;waterbox&quot;</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">waterbox_free_energy_difference_overlap</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;0.2f&quot;</span><span class="p">,</span>
                <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="s2">&quot;small&quot;</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;complex&quot;</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">complex_free_energy_difference_overlap</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;0.2f&quot;</span><span class="p">,</span>
                <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="s2">&quot;small&quot;</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overlap of lambda states for ligand in </span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;lambda state (0 to 1)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;lambda state (0 to 1)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">save_results_to_path</span><span class="si">}</span><span class="s2">/ddG_to_common_core_overlap_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">_for_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">structure_name</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot_free_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">a</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vacuum_free_energy_differences</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_free_energy_differences</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_free_energy_difference_uncertanties</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;waterbox&quot;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">a</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waterbox_free_energy_differences</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waterbox_free_energy_differences</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waterbox_free_energy_difference_uncertanties</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;complex&quot;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">a</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complex_free_energy_differences</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complex_free_energy_differences</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complex_free_energy_difference_uncertanties</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">y_error</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ddG +- stddev [kT]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Free energy estimate for ligand in </span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Free energy estimate in kT&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;lambda state (0 to 1)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">save_results_to_path</span><span class="si">}</span><span class="s2">/ddG_to_common_core_line_plot_</span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">_for_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">structure_name</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot_vacuum_free_energy_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_free_energy_overlap</span><span class="p">(</span><span class="s2">&quot;vacuum&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_complex_free_energy_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_free_energy_overlap</span><span class="p">(</span><span class="s2">&quot;complex&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_waterbox_free_energy_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_free_energy_overlap</span><span class="p">(</span><span class="s2">&quot;waterbox&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_vacuum_free_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_free_energy</span><span class="p">(</span><span class="s2">&quot;vacuum&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_complex_free_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_free_energy</span><span class="p">(</span><span class="s2">&quot;complex&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_waterbox_free_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_free_energy</span><span class="p">(</span><span class="s2">&quot;waterbox&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">end_state_free_energy_difference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;DeltaF[lambda=1 --&gt; lambda=0]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;free-energy-type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rsfe&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">waterbox_free_energy_differences</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_free_energy_differences</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">waterbox_free_energy_difference_uncertanties</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_free_energy_difference_uncertanties</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;free-energy-type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rbfe&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">complex_free_energy_differences</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">waterbox_free_energy_differences</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">complex_free_energy_difference_uncertanties</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">waterbox_free_energy_difference_uncertanties</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">show_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">transformato.utils</span> <span class="kn">import</span> <span class="n">isnotebook</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;simulation&quot;</span><span class="p">][</span><span class="s2">&quot;free-energy-type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rsfe&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">isnotebook</span><span class="p">:</span>
                <span class="c1"># only show this if we are in a notebook</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_vacuum_free_energy_overlap</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_waterbox_free_energy_overlap</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_vacuum_free_energy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_waterbox_free_energy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">isnotebook</span><span class="p">:</span>
                <span class="c1"># only show this if we are in a notebook</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_complex_free_energy_overlap</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_waterbox_free_energy_overlap</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_complex_free_energy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_waterbox_free_energy</span><span class="p">()</span>

        <span class="n">energy_estimate</span><span class="p">,</span> <span class="n">uncertanty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_state_free_energy_difference</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Free energy to common core: </span><span class="si">{</span><span class="n">energy_estimate</span><span class="si">}</span><span class="s2"> [kT] with uncertanty: </span><span class="si">{</span><span class="n">uncertanty</span><span class="si">}</span><span class="s2"> [kT].&quot;</span>
        <span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Marcus Wieder, Johannes Karwounopoulos, Stefan Boresch. Project structure based on the Computational Molecular Science Python Cookiecutter version 1.1.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>