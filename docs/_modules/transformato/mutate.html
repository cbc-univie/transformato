<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>transformato.mutate &mdash; transformato  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/logo_transformato.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../whatistransformato.html">Theoretical background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../System_Setup.html">System Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Additional_Settings.html">Additional Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Running_Simulation.html">Running Simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Analysis.html">Trajectory Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">transformato</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>transformato.mutate</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for transformato.mutate</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">mmap</span> <span class="kn">import</span> <span class="n">MADV_UNMERGEABLE</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">parmed</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">AllChem</span><span class="p">,</span> <span class="n">Draw</span><span class="p">,</span> <span class="n">rdFMCS</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem.Draw</span> <span class="kn">import</span> <span class="n">rdMolDraw2D</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem.Draw</span> <span class="kn">import</span> <span class="n">IPythonConsole</span>

<span class="n">IPythonConsole</span><span class="o">.</span><span class="n">molSize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">900</span><span class="p">,</span> <span class="mi">900</span><span class="p">)</span>  <span class="c1"># Change image size</span>
<span class="n">IPythonConsole</span><span class="o">.</span><span class="n">ipython_useSVG</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Change output to SVG</span>

<span class="kn">from</span> <span class="nn">transformato.system</span> <span class="kn">import</span> <span class="n">SystemStructure</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_flattened</span><span class="p">(</span><span class="n">list_of_lists</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">list_of_lists</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_performe_linear_charge_scaling</span><span class="p">(</span>
    <span class="n">nr_of_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">intermediate_factory</span><span class="p">,</span>
    <span class="n">mutation</span><span class="p">,</span>
<span class="p">):</span>

    <span class="k">for</span> <span class="n">lambda_value</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_of_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Coulomb scaling in step: </span><span class="si">{</span><span class="n">intermediate_factory</span><span class="o">.</span><span class="n">current_step</span><span class="si">}</span><span class="s2"> with lamb: </span><span class="si">{</span><span class="n">lambda_value</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################&quot;</span><span class="p">)</span>
        <span class="n">intermediate_factory</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span>
            <span class="n">mutation_conf</span><span class="o">=</span><span class="n">mutation</span><span class="p">,</span>
            <span class="n">lambda_value_electrostatic</span><span class="o">=</span><span class="n">lambda_value</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_performe_linear_cc_scaling</span><span class="p">(</span>
    <span class="n">nr_of_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">intermediate_factory</span><span class="p">,</span>
    <span class="n">mutation</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>

    <span class="k">for</span> <span class="n">lambda_value</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_of_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Perform paramteter scaling on cc in step: </span><span class="si">{</span><span class="n">intermediate_factory</span><span class="o">.</span><span class="n">current_step</span><span class="si">}</span><span class="s2"> with lamb: </span><span class="si">{</span><span class="n">lambda_value</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################&quot;</span><span class="p">)</span>
        <span class="n">intermediate_factory</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span>
            <span class="n">mutation_conf</span><span class="o">=</span><span class="n">mutation</span><span class="p">,</span>
            <span class="n">common_core_transformation</span><span class="o">=</span><span class="n">lambda_value</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">perform_mutations</span><span class="p">(</span>
    <span class="n">configuration</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">i</span><span class="p">,</span>
    <span class="n">mutation_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">list_of_heavy_atoms_to_be_mutated</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">nr_of_mutation_steps_charge</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">nr_of_mutation_steps_lj_of_hydrogens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">nr_of_mutation_steps_lj_of_heavy_atoms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">nr_of_mutation_steps_cc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Performs the mutations necessary to mutate the physical endstate to the defined common core.</span>

<span class="sd">    Args:</span>
<span class="sd">        configuration (dict): A configuration dictionary.</span>
<span class="sd">        i ([type]): IntermediateState instance</span>
<span class="sd">        mutation_list (list): list of mutation objects</span>
<span class="sd">        list_of_heavy_atoms_to_be_mutated (list, optional): A list of atom indices that define the order in which the vdw parameters of the heavy atoms are turned off. Defaults to [].</span>
<span class="sd">        nr_of_mutation_steps_charge (int, optional): Nr of steps to turne of the charges. Defaults to 5.</span>
<span class="sd">        nr_of_mutation_steps_lj_of_hydrogens (int, optional): Nr of steps to turne of lj of hydrogens. Only needed for systems with many hydrogens in dummy region</span>
<span class="sd">        nr_of_mutation_steps_lj_of_heavy_atoms (int, optional): Nr of steps to turne of the lj of heavy atoms</span>
<span class="sd">        nr_of_mutation_steps_cc (int, optional): Nr of steps to interpolate between the common core parameters. Defaults to 5.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: list of directories with the parameter and topology files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">transformato.utils</span> <span class="kn">import</span> <span class="n">map_lj_mutations_to_atom_idx</span>

    <span class="c1">######################################</span>
    <span class="c1"># write endpoint mutation</span>
    <span class="c1">######################################</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Physical endstate in step: 1&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################&quot;</span><span class="p">)</span>

    <span class="n">i</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span><span class="n">mutation_conf</span><span class="o">=</span><span class="p">[])</span>

    <span class="c1">######################################</span>
    <span class="c1"># turn off electrostatics</span>
    <span class="c1">######################################</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">mutation_list</span><span class="p">[</span><span class="s2">&quot;charge&quot;</span><span class="p">]</span>
    <span class="c1"># turn off charges</span>
    <span class="c1"># if number of charge mutation steps are defined in config file overwrite default or passed value</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">nr_of_mutation_steps_charge</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="n">i</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">structure</span><span class="p">][</span>
            <span class="s2">&quot;mutation&quot;</span>
        <span class="p">][</span><span class="s2">&quot;steps_charge&quot;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using number of steps for charge mutattions as defined in config file&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">_performe_linear_charge_scaling</span><span class="p">(</span>
        <span class="n">nr_of_steps</span><span class="o">=</span><span class="n">nr_of_mutation_steps_charge</span><span class="p">,</span>
        <span class="n">intermediate_factory</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
        <span class="n">mutation</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1">######################################</span>
    <span class="c1"># turn off LJ</span>
    <span class="c1">######################################</span>

    <span class="c1">######################################</span>
    <span class="c1"># Turn off hydrogens</span>
    <span class="k">if</span> <span class="n">nr_of_mutation_steps_lj_of_hydrogens</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mutation_list</span><span class="p">[</span><span class="s2">&quot;hydrogen-lj&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hydrogen vdW scaling in step: </span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">current_step</span><span class="si">}</span><span class="s2"> with lamb: </span><span class="si">{</span><span class="mf">0.0</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################&quot;</span><span class="p">)</span>
            <span class="n">i</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span>
                <span class="n">mutation_conf</span><span class="o">=</span><span class="n">mutation_list</span><span class="p">[</span><span class="s2">&quot;hydrogen-lj&quot;</span><span class="p">],</span>
                <span class="n">lambda_value_vdw</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Scaling lj-parameters in multiple steps</span>
        <span class="k">if</span> <span class="n">mutation_list</span><span class="p">[</span><span class="s2">&quot;hydrogen-lj&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">lambda_value</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                <span class="mf">0.75</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_of_mutation_steps_lj_of_hydrogens</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Hydrogen vdW scaling in step: </span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">current_step</span><span class="si">}</span><span class="s2"> with lamb: </span><span class="si">{</span><span class="n">lambda_value</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################&quot;</span><span class="p">)</span>
                <span class="n">i</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span>
                    <span class="n">mutation_conf</span><span class="o">=</span><span class="n">mutation_list</span><span class="p">[</span><span class="s2">&quot;hydrogen-lj&quot;</span><span class="p">],</span>
                    <span class="n">lambda_value_vdw</span><span class="o">=</span><span class="n">lambda_value</span><span class="p">,</span>
                <span class="p">)</span>
    <span class="c1">######################################</span>
    <span class="c1"># turn off lj of heavy atoms</span>
    <span class="c1"># take the order from either config file, passed to this function or the default ordering</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">list_of_heavy_atoms_to_be_mutated</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="n">i</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">structure</span><span class="p">][</span>
            <span class="s2">&quot;mutation&quot;</span>
        <span class="p">][</span><span class="s2">&quot;heavy_atoms&quot;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using ordering of LJ mutations as defined in config file.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">list_of_heavy_atoms_to_be_mutated</span><span class="p">:</span>
            <span class="c1"># Use the ordering provided by _calculate_order_of_LJ_mutations</span>
            <span class="n">list_of_heavy_atoms_to_be_mutated</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">lj</span><span class="o">.</span><span class="n">vdw_atom_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">lj</span> <span class="ow">in</span> <span class="p">(</span><span class="n">mutation_list</span><span class="p">[</span><span class="s2">&quot;lj&quot;</span><span class="p">])</span>
            <span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using calculated ordering of LJ mutations.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using passed ordering of LJ mutations.&quot;</span><span class="p">)</span>

    <span class="n">mapping_of_atom_idx_to_mutation</span> <span class="o">=</span> <span class="n">map_lj_mutations_to_atom_idx</span><span class="p">(</span><span class="n">mutation_list</span><span class="p">[</span><span class="s2">&quot;lj&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">heavy_atoms_to_turn_off_in_a_single_step</span> <span class="ow">in</span> <span class="n">list_of_heavy_atoms_to_be_mutated</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;turning off lj of heavy atom: </span><span class="si">{</span><span class="n">heavy_atoms_to_turn_off_in_a_single_step</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># heavy_atoms_to_turn_off_in_a_single_step can be a tuple or an integer</span>
            <span class="n">mutations</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">mapping_of_atom_idx_to_mutation</span><span class="p">[</span><span class="n">heavy_atom_idx</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">heavy_atom_idx</span> <span class="ow">in</span> <span class="n">heavy_atoms_to_turn_off_in_a_single_step</span>
            <span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">mutations</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">mapping_of_atom_idx_to_mutation</span><span class="p">[</span>
                    <span class="n">heavy_atoms_to_turn_off_in_a_single_step</span>
                <span class="p">]</span>
            <span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Turn off Heavy atom vdW parameter in: </span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">current_step</span><span class="si">}</span><span class="s2"> on atoms: </span><span class="si">{</span><span class="n">heavy_atoms_to_turn_off_in_a_single_step</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nr_of_mutation_steps_lj_of_heavy_atoms</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span>
                <span class="n">mutation_conf</span><span class="o">=</span><span class="n">mutations</span><span class="p">,</span>
                <span class="n">lambda_value_vdw</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">lambda_value</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                <span class="mf">0.75</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_of_mutation_steps_lj_of_heavy_atoms</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">):</span>
                <span class="n">i</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span>
                    <span class="n">mutation_conf</span><span class="o">=</span><span class="n">mutations</span><span class="p">,</span>
                    <span class="n">lambda_value_vdw</span><span class="o">=</span><span class="n">lambda_value</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="c1">######################################</span>
    <span class="c1"># generate terminal LJ</span>
    <span class="c1">######################################</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Generate terminal LJ particle in step: </span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">current_step</span><span class="si">}</span><span class="s2"> on atoms: </span><span class="si">{</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">vdw_atom_idx</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mutation_list</span><span class="p">[</span><span class="s1">&#39;default-lj&#39;</span><span class="p">]]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################&quot;</span><span class="p">)</span>

    <span class="n">i</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span>
        <span class="n">mutation_conf</span><span class="o">=</span><span class="n">mutation_list</span><span class="p">[</span><span class="s2">&quot;default-lj&quot;</span><span class="p">],</span>
        <span class="n">lambda_value_vdw</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">######################################</span>
    <span class="c1"># mutate common core</span>
    <span class="c1">######################################</span>

    <span class="k">if</span> <span class="n">mutation_list</span><span class="p">[</span><span class="s2">&quot;transform&quot;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nr_of_mutation_steps_cc</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="n">i</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">structure</span><span class="p">][</span>
                <span class="s2">&quot;mutation&quot;</span>
            <span class="p">][</span><span class="s2">&quot;steps_common_core&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">nr_of_mutation_steps_cc</span> <span class="o">=</span> <span class="n">nr_of_mutation_steps_cc</span>

        <span class="c1"># change bonded parameters on common core</span>
        <span class="n">_performe_linear_cc_scaling</span><span class="p">(</span>
            <span class="n">nr_of_steps</span><span class="o">=</span><span class="n">nr_of_mutation_steps_cc</span><span class="p">,</span>
            <span class="n">intermediate_factory</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
            <span class="n">mutation</span><span class="o">=</span><span class="n">mutation_list</span><span class="p">[</span><span class="s2">&quot;transform&quot;</span><span class="p">],</span>
        <span class="p">)</span>


<div class="viewcode-block" id="DummyRegion"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.DummyRegion">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">DummyRegion</span><span class="p">:</span>
    <span class="n">mol_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">match_termin_real_and_dummy_atoms</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">connected_dummy_regions</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">tlc</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">lj_default</span><span class="p">:</span> <span class="nb">list</span>

    <span class="k">def</span> <span class="nf">return_connecting_real_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dummy_atoms</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">real_atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_termin_real_and_dummy_atoms</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dummy_atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_termin_real_and_dummy_atoms</span><span class="p">[</span><span class="n">real_atom</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">dummy_atom</span> <span class="ow">in</span> <span class="n">dummy_atoms</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connecting real atom: </span><span class="si">{</span><span class="n">real_atom</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">real_atom</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;No connecting real atom was found!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="MutationDefinition"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.MutationDefinition">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">MutationDefinition</span><span class="p">:</span>
    <span class="n">atoms_to_be_mutated</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">common_core</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">dummy_region</span><span class="p">:</span> <span class="n">DummyRegion</span>
    <span class="n">vdw_atom_idx</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">steric_mutation_to_default</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">print_details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atoms to be mutated: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_to_be_mutated</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mutated on common core: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">common_core</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdw_atom_idx</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VDW atoms to be decoupled: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">vdw_atom_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProposeMutationRoute"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute">[docs]</a><span class="k">class</span> <span class="nc">ProposeMutationRoute</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="ProposeMutationRoute.__init__"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">s1</span><span class="p">:</span> <span class="n">SystemStructure</span><span class="p">,</span>
        <span class="n">s2</span><span class="p">:</span> <span class="n">SystemStructure</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A class that proposes the mutation route between two molecules with a</span>
<span class="sd">        common core (same atom types) based on two mols and generates the mutation</span>
<span class="sd">        objects to perform the mutation on the psf objects.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mol1: Chem.Mol</span>
<span class="sd">        mol2: Chem.Mol</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mol1_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;m1&quot;</span>
        <span class="n">mol2_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;m2&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;system1&quot;</span><span class="p">:</span> <span class="n">s1</span><span class="p">,</span> <span class="s2">&quot;system2&quot;</span><span class="p">:</span> <span class="n">s2</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mols</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">mol1_name</span><span class="p">:</span> <span class="n">s1</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">mol2_name</span><span class="p">:</span> <span class="n">s2</span><span class="o">.</span><span class="n">mol</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">mol1_name</span><span class="p">:</span> <span class="n">s1</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">mol2_name</span><span class="p">:</span> <span class="n">s2</span><span class="o">.</span><span class="n">graph</span><span class="p">}</span>
        <span class="c1"># psfs for reference of only ligand</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psfs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">mol1_name</span><span class="p">:</span> <span class="n">s1</span><span class="o">.</span><span class="n">psfs</span><span class="p">[</span><span class="s2">&quot;waterbox&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">s1</span><span class="o">.</span><span class="n">tlc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="n">mol2_name</span><span class="p">:</span> <span class="n">s2</span><span class="o">.</span><span class="n">psfs</span><span class="p">[</span><span class="s2">&quot;waterbox&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">s2</span><span class="o">.</span><span class="n">tlc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf1</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">psfs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf2</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">psfs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_substructure_match</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">mol1_name</span><span class="p">:</span> <span class="p">[],</span> <span class="n">mol2_name</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_indeces</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">mol1_name</span><span class="p">:</span> <span class="p">[],</span> <span class="n">mol2_name</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">added_indeces</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">mol1_name</span><span class="p">:</span> <span class="p">[],</span> <span class="n">mol2_name</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s1_tlc</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">tlc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s2_tlc</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">tlc</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">terminal_real_atom_cc1</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminal_real_atom_cc2</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminal_dummy_atom_cc1</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminal_dummy_atom_cc2</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bondCompare</span> <span class="o">=</span> <span class="n">rdFMCS</span><span class="o">.</span><span class="n">BondCompare</span><span class="o">.</span><span class="n">CompareAny</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atomCompare</span> <span class="o">=</span> <span class="n">rdFMCS</span><span class="o">.</span><span class="n">AtomCompare</span><span class="o">.</span><span class="n">CompareElements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maximizeBonds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matchValences</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completeRingsOnly</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ringMatchesRingOnly</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dummy_region_cc1</span><span class="p">:</span> <span class="n">DummyRegion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dummy_region_cc2</span><span class="p">:</span> <span class="n">DummyRegion</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">manually_added_m1_idx</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manually_added_m2_idx</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span><span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_cgenff_versions</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_check_cgenff_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">cgenff_sys1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="s2">&quot;system1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cgenff_version</span>
        <span class="n">cgenff_sys2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="s2">&quot;system2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cgenff_version</span>
        <span class="k">if</span> <span class="n">cgenff_sys1</span> <span class="o">==</span> <span class="n">cgenff_sys2</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;CGenFF compatibility error. CGenFF: </span><span class="si">{</span><span class="n">cgenff_sys1</span><span class="si">}</span><span class="s2"> and CGenFF: </span><span class="si">{</span><span class="n">cgenff_sys2</span><span class="si">}</span><span class="s2"> are combined.&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="ProposeMutationRoute._match_terminal_real_and_dummy_atoms_for_mol1"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute._match_terminal_real_and_dummy_atoms_for_mol1">[docs]</a>    <span class="k">def</span> <span class="nf">_match_terminal_real_and_dummy_atoms_for_mol1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Matches the terminal real and dummy atoms and returns a dict with real atom idx as key and a set of dummy atoms that connect</span>
<span class="sd">        to this real atom as a set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_terminal_real_and_dummy_atoms</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mols</span><span class="p">[</span><span class="s2">&quot;m1&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_real_atom_cc1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_dummy_atom_cc1</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ProposeMutationRoute._match_terminal_real_and_dummy_atoms_for_mol2"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute._match_terminal_real_and_dummy_atoms_for_mol2">[docs]</a>    <span class="k">def</span> <span class="nf">_match_terminal_real_and_dummy_atoms_for_mol2</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Matches the terminal real and dummy atoms and returns a dict with real atom idx as key and a set of dummy atoms that connect</span>
<span class="sd">        to this real atom as a set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_terminal_real_and_dummy_atoms</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mols</span><span class="p">[</span><span class="s2">&quot;m2&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_real_atom_cc2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_dummy_atom_cc2</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ProposeMutationRoute._match_terminal_real_and_dummy_atoms"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute._match_terminal_real_and_dummy_atoms">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_match_terminal_real_and_dummy_atoms</span><span class="p">(</span>
        <span class="n">mol</span><span class="p">,</span> <span class="n">real_atoms_cc</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">dummy_atoms_cc</span><span class="p">:</span> <span class="nb">list</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Matches the terminal real and dummy atoms and returns a dict with real atom idx as key and a set of dummy atoms that connect</span>
<span class="sd">        to this real atom as a set</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mol : [Chem.Mol]</span>
<span class="sd">            The mol object with the real and dummy atoms</span>
<span class="sd">        real_atoms_cc : list</span>
<span class="sd">            list of real atom idx</span>
<span class="sd">        dummy_atoms_cc : list</span>
<span class="sd">            list of dummy atom idx</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        [type]</span>
<span class="sd">            [description]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

        <span class="n">real_atom_match_dummy_atom</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">real_atom_idx</span> <span class="ow">in</span> <span class="n">real_atoms_cc</span><span class="p">:</span>
            <span class="n">real_atom</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">real_atom_idx</span><span class="p">)</span>
            <span class="n">real_neighbors</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">real_atom</span><span class="o">.</span><span class="n">GetNeighbors</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">dummy_atoms_idx</span> <span class="ow">in</span> <span class="n">dummy_atoms_cc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dummy_atoms_idx</span> <span class="ow">in</span> <span class="n">real_neighbors</span><span class="p">:</span>
                    <span class="n">real_atom_match_dummy_atom</span><span class="p">[</span><span class="n">real_atom_idx</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dummy_atoms_idx</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">real_atom_match_dummy_atom</span></div>

    <span class="k">def</span> <span class="nf">_set_common_core_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># find terminal atoms</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminal_dummy_atom_cc1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminal_real_atom_cc1</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_terminal_atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_common_core_idx_mol1</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mols</span><span class="p">[</span><span class="s2">&quot;m1&quot;</span><span class="p">])</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminal_dummy_atom_cc2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminal_real_atom_cc2</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_terminal_atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_common_core_idx_mol2</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mols</span><span class="p">[</span><span class="s2">&quot;m2&quot;</span><span class="p">])</span>

        <span class="c1"># match terminal real atoms between cc1 and cc2 that connect dummy atoms</span>
        <span class="n">cc_idx_mol1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_common_core_idx_mol1</span><span class="p">()</span>
        <span class="n">cc_idx_mol2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_common_core_idx_mol2</span><span class="p">()</span>
        <span class="n">matching_terminal_atoms_between_cc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">cc1_idx</span><span class="p">,</span> <span class="n">cc2_idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cc_idx_mol1</span><span class="p">,</span> <span class="n">cc_idx_mol2</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">cc1_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_real_atom_cc1</span>
                <span class="ow">and</span> <span class="n">cc2_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_real_atom_cc2</span>
            <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Dummy regions connect on the same terminal atoms. cc1: </span><span class="si">{</span><span class="n">cc1_idx</span><span class="si">}</span><span class="s2"> : cc2: </span><span class="si">{</span><span class="n">cc2_idx</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">matching_terminal_atoms_between_cc</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cc1_idx</span><span class="p">,</span> <span class="n">cc2_idx</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">cc1_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_real_atom_cc1</span>
                <span class="ow">and</span> <span class="n">cc2_idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_real_atom_cc2</span>
            <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">cc1_idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_real_atom_cc1</span>
                <span class="ow">and</span> <span class="n">cc2_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_real_atom_cc2</span>
            <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Single dummy region connects on terminal atom. cc1: </span><span class="si">{</span><span class="n">cc1_idx</span><span class="si">}</span><span class="s2"> : cc2: </span><span class="si">{</span><span class="n">cc2_idx</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">matching_terminal_atoms_between_cc</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cc1_idx</span><span class="p">,</span> <span class="n">cc2_idx</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matching_terminal_atoms_between_cc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;No terminal real atoms were matched between the common cores. Aborting.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">matching_terminal_atoms_between_cc</span> <span class="o">=</span> <span class="n">matching_terminal_atoms_between_cc</span>

    <span class="k">def</span> <span class="nf">_match_terminal_dummy_atoms_between_common_cores</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">match_terminal_atoms_cc1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">match_terminal_atoms_cc2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>

        <span class="n">cc1_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_substructure_match</span><span class="p">[</span><span class="s2">&quot;m1&quot;</span><span class="p">]</span>
        <span class="n">cc2_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_substructure_match</span><span class="p">[</span><span class="s2">&quot;m2&quot;</span><span class="p">]</span>

        <span class="n">lj_default_cc1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lj_default_cc2</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># iterate through the common core substracter (the order represents the matched atoms)</span>
        <span class="k">for</span> <span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cc1_idx</span><span class="p">,</span> <span class="n">cc2_idx</span><span class="p">):</span>

            <span class="c1"># if both atoms are terminal atoms connected dummy regions can be identified</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">idx1</span> <span class="ow">in</span> <span class="n">match_terminal_atoms_cc1</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="ow">and</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="n">match_terminal_atoms_cc2</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">):</span>

                <span class="n">connected_dummy_cc1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">match_terminal_atoms_cc1</span><span class="p">[</span><span class="n">idx1</span><span class="p">])</span>
                <span class="n">connected_dummy_cc2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">match_terminal_atoms_cc2</span><span class="p">[</span><span class="n">idx2</span><span class="p">])</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">connected_dummy_cc1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">connected_dummy_cc2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># multiple, possible dummy regions</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">connected_dummy_cc1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">connected_dummy_cc2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;There is a dual junction. Be careful.&quot;</span><span class="p">)</span>
                    <span class="c1"># NOTE: For now we are just taking the non hydrogen atom</span>
                    <span class="k">for</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="n">connected_dummy_cc1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mols</span><span class="p">[</span><span class="s2">&quot;m1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">)</span><span class="o">.</span><span class="n">GetSymbol</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;H&quot;</span><span class="p">:</span>
                            <span class="n">connected_dummy_cc1</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom_idx</span><span class="p">]</span>
                            <span class="k">break</span>
                    <span class="k">for</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="n">connected_dummy_cc2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mols</span><span class="p">[</span><span class="s2">&quot;m2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">)</span><span class="o">.</span><span class="n">GetSymbol</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;H&quot;</span><span class="p">:</span>
                            <span class="n">connected_dummy_cc2</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom_idx</span><span class="p">]</span>
                            <span class="k">break</span>

                <span class="c1"># hydrogen mutates to dummy atom (but not a LJ particle)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">connected_dummy_cc1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">connected_dummy_cc2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Hydrogen to dummy mutation&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

                <span class="n">lj_default_cc1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">connected_dummy_cc1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">lj_default_cc2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">connected_dummy_cc2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">lj_default_cc1</span><span class="p">,</span> <span class="n">lj_default_cc2</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calculate_order_of_LJ_mutations</span><span class="p">(</span>
        <span class="n">connected_dummy_regions</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">match_terminal_atoms</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">G</span><span class="p">:</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>

        <span class="n">ordered_LJ_mutations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">real_atom</span> <span class="ow">in</span> <span class="n">match_terminal_atoms</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dummy_atom</span> <span class="ow">in</span> <span class="n">match_terminal_atoms</span><span class="p">[</span><span class="n">real_atom</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">connected_dummy_region</span> <span class="ow">in</span> <span class="n">connected_dummy_regions</span><span class="p">:</span>
                    <span class="c1"># stop at connected dummy region with specific dummy_atom in it</span>
                    <span class="k">if</span> <span class="n">dummy_atom</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">connected_dummy_region</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">G_dummy</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="c1"># delete all nodes not in dummy region</span>
                    <span class="n">remove_nodes</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">connected_dummy_region</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">remove_node</span> <span class="ow">in</span> <span class="n">remove_nodes</span><span class="p">:</span>
                        <span class="n">G_dummy</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">remove_node</span><span class="p">)</span>

                    <span class="c1"># root is the dummy atom that connects the real region with the dummy region</span>
                    <span class="n">root</span> <span class="o">=</span> <span class="n">dummy_atom</span>

                    <span class="n">edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">dfs_edges</span><span class="p">(</span><span class="n">G_dummy</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">root</span><span class="p">))</span>
                    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">root</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">]</span>
                    <span class="n">nodes</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>  <span class="c1"># NOTE: reverse the mutation</span>
                    <span class="n">ordered_LJ_mutations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ordered_LJ_mutations</span>

<div class="viewcode-block" id="ProposeMutationRoute._check_for_lp"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute._check_for_lp">[docs]</a>    <span class="k">def</span> <span class="nf">_check_for_lp</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">odered_connected_dummy_regions_cc_with_lp</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span><span class="p">,</span>
        <span class="n">tlc</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        With the help of parmed this function will look in the ordered_connected_dummy_regions list if</span>
<span class="sd">        there is a atom which has lonepairs. It will check wheather the lp belongs to the common core or</span>
<span class="sd">        to the dummy region and assign it into the sorted list accordingly.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">flat_ordered_connected_dummy_regions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">item</span>
            <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">odered_connected_dummy_regions_cc_with_lp</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span>
        <span class="p">]</span>
        <span class="n">lp_dict_dummy_region</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">lp_dict_common_core</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">psf</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">tlc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;LP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">flat_ordered_connected_dummy_regions</span><span class="p">:</span>
                    <span class="n">lp_dict_dummy_region</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lp_dict_common_core</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;m1&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding atom </span><span class="si">{</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2"> to the common core of mol1&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_idx_to_common_core_of_mol1</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>

                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lp_dict_common_core</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;m2&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding atom </span><span class="si">{</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2"> to the common core of mol1&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_idx_to_common_core_of_mol2</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">lp_dict_dummy_region</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">odered_connected_dummy_regions_cc_with_lp</span><span class="p">:</span>
                <span class="n">lp_to_insert</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">lp_dict_dummy_region</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">lp_to_insert</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lp_dict_dummy_region</span><span class="p">[</span><span class="n">atom</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">lp_num</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">lp_to_insert</span><span class="p">):</span>
                    <span class="n">i</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lp_num</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Orderd connected dummy atoms containing the lp </span><span class="si">{</span><span class="n">odered_connected_dummy_regions_cc_with_lp</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">odered_connected_dummy_regions_cc_with_lp</span></div>

    <span class="k">def</span> <span class="nf">propose_common_core</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_mcs</span><span class="p">(</span><span class="s2">&quot;m1&quot;</span><span class="p">,</span> <span class="s2">&quot;m2&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mcs</span>

    <span class="k">def</span> <span class="nf">finish_common_core</span><span class="p">(</span>

        
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">connected_dummy_regions_cc1</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">connected_dummy_regions_cc2</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">odered_connected_dummy_regions_cc1</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">odered_connected_dummy_regions_cc2</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="p">):</span>
        <span class="c1"># Add sorted manually added idxs to common core. Sorting prevents error looking up mutation parameters.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manually_added_m1_idx</span><span class="o">!=</span><span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manually_added_m1_idx</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding idx to common core: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_added_m1_idx</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">manually_added_m1_idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_common_core_atom</span><span class="p">(</span><span class="s2">&quot;m1&quot;</span><span class="p">,</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manually_added_m2_idx</span><span class="o">!=</span><span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manually_added_m2_idx</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding idx to common core: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_added_m2_idx</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">manually_added_m2_idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_common_core_atom</span><span class="p">(</span><span class="s2">&quot;m2&quot;</span><span class="p">,</span><span class="n">idx</span><span class="p">)</span>
                  
        <span class="c1"># set the teriminal real/dummy atom indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_common_core_parameters</span><span class="p">()</span>
        <span class="c1"># match the real/dummy atoms</span>
        <span class="n">match_terminal_atoms_cc1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_terminal_real_and_dummy_atoms_for_mol1</span><span class="p">()</span>
        <span class="n">match_terminal_atoms_cc2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_terminal_real_and_dummy_atoms_for_mol2</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Find connected dummy regions&quot;</span><span class="p">)</span>
        <span class="c1"># define connected dummy regions</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">connected_dummy_regions_cc1</span><span class="p">:</span>
            <span class="n">connected_dummy_regions_cc1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_connected_dummy_regions</span><span class="p">(</span>
                <span class="n">mol_name</span><span class="o">=</span><span class="s2">&quot;m1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">connected_dummy_regions_cc2</span><span class="p">:</span>
            <span class="n">connected_dummy_regions_cc2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_connected_dummy_regions</span><span class="p">(</span>
                <span class="n">mol_name</span><span class="o">=</span><span class="s2">&quot;m2&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connected dummy regions for mol1: </span><span class="si">{</span><span class="n">connected_dummy_regions_cc1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connected dummy regions for mol2: </span><span class="si">{</span><span class="n">connected_dummy_regions_cc2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># calculate the ordering or LJ mutations</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">odered_connected_dummy_regions_cc1</span><span class="p">:</span>
            <span class="n">odered_connected_dummy_regions_cc1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_order_of_LJ_mutations</span><span class="p">(</span>
                <span class="n">connected_dummy_regions_cc1</span><span class="p">,</span>
                <span class="n">match_terminal_atoms_cc1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">[</span><span class="s2">&quot;m1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">odered_connected_dummy_regions_cc2</span><span class="p">:</span>
            <span class="n">odered_connected_dummy_regions_cc2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_order_of_LJ_mutations</span><span class="p">(</span>
                <span class="n">connected_dummy_regions_cc2</span><span class="p">,</span>
                <span class="n">match_terminal_atoms_cc2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">[</span><span class="s2">&quot;m2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;sorted connected dummy regions for mol1: </span><span class="si">{</span><span class="n">odered_connected_dummy_regions_cc1</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;sorted connected dummy regions for mol2: </span><span class="si">{</span><span class="n">odered_connected_dummy_regions_cc2</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">odered_connected_dummy_regions_cc1</span><span class="p">:</span>
            <span class="n">odered_connected_dummy_regions_cc1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_lp</span><span class="p">(</span>
                <span class="n">odered_connected_dummy_regions_cc1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psf1</span><span class="p">[</span><span class="s2">&quot;waterbox&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">s1_tlc</span><span class="p">,</span>
                <span class="s2">&quot;m1&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">odered_connected_dummy_regions_cc2</span><span class="p">:</span>
            <span class="n">odered_connected_dummy_regions_cc2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_lp</span><span class="p">(</span>
                <span class="n">odered_connected_dummy_regions_cc2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psf2</span><span class="p">[</span><span class="s2">&quot;waterbox&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">s2_tlc</span><span class="p">,</span>
                <span class="s2">&quot;m2&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># find the atoms from dummy_region in s1 that needs to become lj default</span>
        <span class="p">(</span>
            <span class="n">lj_default_cc1</span><span class="p">,</span>
            <span class="n">lj_default_cc2</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_terminal_dummy_atoms_between_common_cores</span><span class="p">(</span>
            <span class="n">match_terminal_atoms_cc1</span><span class="p">,</span> <span class="n">match_terminal_atoms_cc2</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dummy_region_cc1</span> <span class="o">=</span> <span class="n">DummyRegion</span><span class="p">(</span>
            <span class="n">mol_name</span><span class="o">=</span><span class="s2">&quot;m1&quot;</span><span class="p">,</span>
            <span class="n">tlc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">s1_tlc</span><span class="p">,</span>
            <span class="n">match_termin_real_and_dummy_atoms</span><span class="o">=</span><span class="n">match_terminal_atoms_cc1</span><span class="p">,</span>
            <span class="n">connected_dummy_regions</span><span class="o">=</span><span class="n">odered_connected_dummy_regions_cc1</span><span class="p">,</span>
            <span class="n">lj_default</span><span class="o">=</span><span class="n">lj_default_cc1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dummy_region_cc2</span> <span class="o">=</span> <span class="n">DummyRegion</span><span class="p">(</span>
            <span class="n">mol_name</span><span class="o">=</span><span class="s2">&quot;m2&quot;</span><span class="p">,</span>
            <span class="n">tlc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">s2_tlc</span><span class="p">,</span>
            <span class="n">match_termin_real_and_dummy_atoms</span><span class="o">=</span><span class="n">match_terminal_atoms_cc2</span><span class="p">,</span>
            <span class="n">connected_dummy_regions</span><span class="o">=</span><span class="n">odered_connected_dummy_regions_cc2</span><span class="p">,</span>
            <span class="n">lj_default</span><span class="o">=</span><span class="n">lj_default_cc2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># generate charge compmensated psfs</span>
        <span class="n">psf1</span><span class="p">,</span> <span class="n">psf2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_cc_for_charge_transfer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge_compensated_ligand1_psf</span> <span class="o">=</span> <span class="n">psf1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge_compensated_ligand2_psf</span> <span class="o">=</span> <span class="n">psf2</span>

    <span class="k">def</span> <span class="nf">calculate_common_core</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">propose_common_core</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish_common_core</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_prepare_cc_for_charge_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># we have to run the same charge mutation that will be run on cc2 to get the</span>
        <span class="c1"># charge distribution AFTER the full mutation</span>

        <span class="c1"># make a copy of the full psf</span>
        <span class="n">m2_psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psfs</span><span class="p">[</span><span class="s2">&quot;m2&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">m1_psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psfs</span><span class="p">[</span><span class="s2">&quot;m1&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">charge_transformed_psfs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">psf</span><span class="p">,</span> <span class="n">tlc</span><span class="p">,</span> <span class="n">cc_idx</span><span class="p">,</span> <span class="n">dummy_region</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="p">[</span><span class="n">m1_psf</span><span class="p">,</span> <span class="n">m2_psf</span><span class="p">],</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s1_tlc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2_tlc</span><span class="p">],</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_common_core_idx_mol1</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_common_core_idx_mol2</span><span class="p">()],</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dummy_region_cc1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_region_cc2</span><span class="p">],</span>
        <span class="p">):</span>

            <span class="c1"># set `initial_charge` parameter for Mutation</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">psf</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">tlc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="c1"># charge, epsilon and rmin are directly modiefied</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">initial_charge</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">charge</span>

            <span class="n">offset</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">psf</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">tlc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>

            <span class="c1"># getting copy of the atoms</span>
            <span class="n">atoms_to_be_mutated</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">psf</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">tlc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">idx</span> <span class="o">-</span> <span class="n">offset</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cc_idx</span><span class="p">:</span>
                    <span class="n">atoms_to_be_mutated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;############################&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Preparing cc2 for charge transfer&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Atoms for which charge is set to zero: </span><span class="si">{</span><span class="n">atoms_to_be_mutated</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;############################&quot;</span><span class="p">)</span>

            <span class="n">m</span> <span class="o">=</span> <span class="n">Mutation</span><span class="p">(</span>
                <span class="n">atoms_to_be_mutated</span><span class="o">=</span><span class="n">atoms_to_be_mutated</span><span class="p">,</span> <span class="n">dummy_region</span><span class="o">=</span><span class="n">dummy_region</span>
            <span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">lambda_value_electrostatic</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">charge_transformed_psfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">charge_transformed_psfs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">charge_transformed_psfs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">remove_idx_from_common_core_of_mol1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_idx_from_common_core</span><span class="p">(</span><span class="s2">&quot;m1&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_idx_from_common_core_of_mol2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_idx_from_common_core</span><span class="p">(</span><span class="s2">&quot;m2&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_remove_idx_from_common_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">added_indeces</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">or</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_common_core</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">removed_indeces</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Idx: </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> already removed from common core.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">removed_indeces</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Idx: </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> not in common core.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_idx_to_common_core_of_mol1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manually_added_m1_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Staged IDX for addition to common core m1: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_added_m1_idx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_idx_to_common_core_of_mol2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manually_added_m2_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Staged IDX for addition to common core m2: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">manually_added_m2_idx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_common_core_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">added_indeces</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">or</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_common_core</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Idx: </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> already in common core.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">added_indeces</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_idx_not_in_common_core_for_mol1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_idx_not_in_common_core_for_mol</span><span class="p">(</span><span class="s2">&quot;m1&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_idx_not_in_common_core_for_mol2</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_idx_not_in_common_core_for_mol</span><span class="p">(</span><span class="s2">&quot;m2&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_idx_not_in_common_core_for_mol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>

        <span class="n">dummy_list_mol</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mols</span><span class="p">[</span><span class="n">mol_name</span><span class="p">]</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_common_core</span><span class="p">(</span><span class="n">mol_name</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">dummy_list_mol</span>

<div class="viewcode-block" id="ProposeMutationRoute.get_common_core_idx_mol1"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute.get_common_core_idx_mol1">[docs]</a>    <span class="k">def</span> <span class="nf">get_common_core_idx_mol1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the common core of mol1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_common_core</span><span class="p">(</span><span class="s2">&quot;m1&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProposeMutationRoute.get_common_core_idx_mol2"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute.get_common_core_idx_mol2">[docs]</a>    <span class="k">def</span> <span class="nf">get_common_core_idx_mol2</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the common core of mol2.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_common_core</span><span class="p">(</span><span class="s2">&quot;m2&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProposeMutationRoute._get_common_core"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute._get_common_core">[docs]</a>    <span class="k">def</span> <span class="nf">_get_common_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper Function - should not be called directly.</span>
<span class="sd">        Returns the common core.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keep_idx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># BEWARE: the ordering is important - don&#39;t cast set!</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_substructure_match</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">added_indeces</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">removed_indeces</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                <span class="n">keep_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">keep_idx</span></div>

<div class="viewcode-block" id="ProposeMutationRoute._find_mcs"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute._find_mcs">[docs]</a>    <span class="k">def</span> <span class="nf">_find_mcs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mol1_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mol2_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A class that proposes the mutation route between two molecules with a</span>
<span class="sd">        common core (same atom types) based on two mols and generates the mutation</span>
<span class="sd">        objects to perform the mutation on the psf objects.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mol1_name: str</span>
<span class="sd">        mol2_name: str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MCS starting ...&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bondCompare: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bondCompare</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;atomCompare: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">atomCompare</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;maximizeBonds: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maximizeBonds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;matchValences: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">matchValences</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ringMatchesRingOnly: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ringMatchesRingOnly</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;completeRingsOnly: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">completeRingsOnly</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>

        <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span> <span class="o">=</span> <span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mols</span><span class="p">[</span><span class="n">mol1_name</span><span class="p">]),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mols</span><span class="p">[</span><span class="n">mol2_name</span><span class="p">])]</span>

        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Mol in SMILES format: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="kc">True</span><span class="p">)))</span>

        <span class="c1"># make copy of mols</span>
        <span class="n">changed_mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">]]</span>

        <span class="c1"># find substructure match (ignore bond order but enforce element matching)</span>
        <span class="n">mcs</span> <span class="o">=</span> <span class="n">rdFMCS</span><span class="o">.</span><span class="n">FindMCS</span><span class="p">(</span>
            <span class="n">changed_mols</span><span class="p">,</span>
            <span class="n">bondCompare</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bondCompare</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
            <span class="n">atomCompare</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atomCompare</span><span class="p">,</span>
            <span class="n">maximizeBonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maximizeBonds</span><span class="p">,</span>
            <span class="n">matchValences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">matchValences</span><span class="p">,</span>
            <span class="n">completeRingsOnly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">completeRingsOnly</span><span class="p">,</span>
            <span class="n">ringMatchesRingOnly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ringMatchesRingOnly</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Substructure match: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mcs</span><span class="o">.</span><span class="n">smartsString</span><span class="p">))</span>
        <span class="c1"># convert from SMARTS</span>
        <span class="n">mcsp</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmarts</span><span class="p">(</span><span class="n">mcs</span><span class="o">.</span><span class="n">smartsString</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">s1</span> <span class="o">=</span> <span class="n">m1</span><span class="o">.</span><span class="n">GetSubstructMatch</span><span class="p">(</span><span class="n">mcsp</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Substructere match idx: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_mol</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">GetSubstructMatch</span><span class="p">(</span><span class="n">mcsp</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Substructere match idx: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_mol</span><span class="p">(</span><span class="n">m2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_substructure_match</span><span class="p">[</span><span class="n">mol1_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_substructure_match</span><span class="p">[</span><span class="n">mol2_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mcs</span></div>

    <span class="k">def</span> <span class="nf">_return_atom_idx_from_bond_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">:</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="n">bond_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">mol</span><span class="o">.</span><span class="n">GetBondWithIdx</span><span class="p">(</span><span class="n">bond_idx</span><span class="p">)</span><span class="o">.</span><span class="n">GetBeginAtomIdx</span><span class="p">(),</span>
            <span class="n">mol</span><span class="o">.</span><span class="n">GetBondWithIdx</span><span class="p">(</span><span class="n">bond_idx</span><span class="p">)</span><span class="o">.</span><span class="n">GetEndAtomIdx</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_find_connected_dummy_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">set</span><span class="p">]:</span>

        <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_common_core</span><span class="p">(</span><span class="n">mol_name</span><span class="p">)</span>
        <span class="c1">#############################</span>
        <span class="c1"># start</span>
        <span class="c1">#############################</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mols</span><span class="p">[</span><span class="n">mol_name</span><span class="p">]</span>
        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">[</span><span class="n">mol_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># find all dummy atoms</span>
        <span class="n">list_of_dummy_atoms_idx</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sub</span>
        <span class="p">]</span>
        <span class="n">nr_of_dummy_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_dummy_atoms_idx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">list_of_real_atoms_idx</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="ow">in</span> <span class="n">sub</span>
        <span class="p">]</span>
        <span class="c1"># remove real atoms from graph to obtain multiple connected compounds</span>
        <span class="k">for</span> <span class="n">real_atom_idx</span> <span class="ow">in</span> <span class="n">list_of_real_atoms_idx</span><span class="p">:</span>
            <span class="n">G</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">real_atom_idx</span><span class="p">)</span>

        <span class="c1"># find these connected compounds</span>
        <span class="kn">from</span> <span class="nn">networkx.algorithms.components</span> <span class="kn">import</span> <span class="n">connected_components</span>

        <span class="n">unique_subgraphs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">unique_subgraphs</span>

<div class="viewcode-block" id="ProposeMutationRoute._display_mol"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute._display_mol">[docs]</a>    <span class="k">def</span> <span class="nf">_display_mol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">:</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets mol as input and displays its 2D Structure using IPythonConsole.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mol: Chem.Mol</span>
<span class="sd">            a rdkit mol object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">mol_with_atom_index</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
            <span class="n">atoms</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">atoms</span><span class="p">):</span>
                <span class="n">mol</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span>
                    <span class="s2">&quot;molAtomMapNumber&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">())</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">mol</span>

        <span class="n">mol</span> <span class="o">=</span> <span class="n">mol_with_atom_index</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">AllChem</span><span class="o">.</span><span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProposeMutationRoute.show_common_core_on_mol1"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute.show_common_core_on_mol1">[docs]</a>    <span class="k">def</span> <span class="nf">show_common_core_on_mol1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shows common core on mol1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_common_core</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mols</span><span class="p">[</span><span class="s2">&quot;m1&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_common_core_idx_mol1</span><span class="p">())</span></div>

<div class="viewcode-block" id="ProposeMutationRoute.show_common_core_on_mol2"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute.show_common_core_on_mol2">[docs]</a>    <span class="k">def</span> <span class="nf">show_common_core_on_mol2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shows common core on mol2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_common_core</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mols</span><span class="p">[</span><span class="s2">&quot;m2&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_common_core_idx_mol2</span><span class="p">())</span></div>

<div class="viewcode-block" id="ProposeMutationRoute._show_common_core"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute._show_common_core">[docs]</a>    <span class="k">def</span> <span class="nf">_show_common_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">highlight</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function - do not call directly.</span>
<span class="sd">        Show common core.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># https://rdkit.blogspot.com/2015/02/new-drawing-code.html</span>

        <span class="n">mol</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">AllChem</span><span class="o">.</span><span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

        <span class="n">drawer</span> <span class="o">=</span> <span class="n">rdMolDraw2D</span><span class="o">.</span><span class="n">MolDraw2DSVG</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>
        <span class="n">drawer</span><span class="o">.</span><span class="n">SetFontSize</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">opts</span> <span class="o">=</span> <span class="n">drawer</span><span class="o">.</span><span class="n">drawOptions</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">atomLabels</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">GetProp</span><span class="p">(</span><span class="s2">&quot;atom_index&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">GetProp</span><span class="p">(</span><span class="s2">&quot;atom_type&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">drawer</span><span class="o">.</span><span class="n">DrawMolecule</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">highlightAtoms</span><span class="o">=</span><span class="n">highlight</span><span class="p">)</span>
        <span class="n">Draw</span><span class="o">.</span><span class="n">DrawingOptions</span><span class="o">.</span><span class="n">includeAtomNumbers</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">drawer</span><span class="o">.</span><span class="n">FinishDrawing</span><span class="p">()</span>
        <span class="n">svg</span> <span class="o">=</span> <span class="n">drawer</span><span class="o">.</span><span class="n">GetDrawingText</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;svg:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">svg</span></div>

<div class="viewcode-block" id="ProposeMutationRoute.generate_mutations_to_common_core_for_mol1"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute.generate_mutations_to_common_core_for_mol1">[docs]</a>    <span class="k">def</span> <span class="nf">generate_mutations_to_common_core_for_mol1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the mutation route to the common fore for mol1.</span>
<span class="sd">        ----------</span>
<span class="sd">        mutations: list</span>
<span class="sd">            list of mutations</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_real_atom_cc1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;First generate the MCS. Aborting.&quot;</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mutate_to_common_core</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dummy_region_cc1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_common_core_idx_mol1</span><span class="p">(),</span> <span class="n">mol_name</span><span class="o">=</span><span class="s2">&quot;m1&quot;</span>
        <span class="p">)</span>
        <span class="n">m</span><span class="p">[</span><span class="s2">&quot;transform&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_common_core</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">m</span></div>

<div class="viewcode-block" id="ProposeMutationRoute.generate_mutations_to_common_core_for_mol2"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute.generate_mutations_to_common_core_for_mol2">[docs]</a>    <span class="k">def</span> <span class="nf">generate_mutations_to_common_core_for_mol2</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the mutation route to the common fore for mol2.</span>
<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        mutations: list</span>
<span class="sd">            list of mutations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_real_atom_cc1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;First generate the MCS&quot;</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mutate_to_common_core</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dummy_region_cc2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_common_core_idx_mol2</span><span class="p">(),</span> <span class="n">mol_name</span><span class="o">=</span><span class="s2">&quot;m2&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span></div>

<div class="viewcode-block" id="ProposeMutationRoute._transform_common_core"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute._transform_common_core">[docs]</a>    <span class="k">def</span> <span class="nf">_transform_common_core</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Common Core 1 is transformed to Common core 2. Bonded parameters and charges are adjusted.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">transformations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;##############################&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;##############################&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Transform common core&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;##############################&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;##############################&quot;</span><span class="p">)</span>

        <span class="c1"># test if bonded mutations are necessary</span>
        <span class="n">bonded_terms_mutation</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">charge_mutation</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">cc1</span><span class="p">,</span> <span class="n">cc2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_common_core_idx_mol1</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_region_cc1</span><span class="o">.</span><span class="n">lj_default</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_common_core_idx_mol2</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_region_cc2</span><span class="o">.</span><span class="n">lj_default</span><span class="p">,</span>
        <span class="p">):</span>

            <span class="c1"># did atom type change? if not don&#39;t add BondedMutations</span>
            <span class="n">atom1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psfs</span><span class="p">[</span><span class="s2">&quot;m1&quot;</span><span class="p">][</span><span class="n">cc1</span><span class="p">]</span>
            <span class="n">atom2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psfs</span><span class="p">[</span><span class="s2">&quot;m2&quot;</span><span class="p">][</span><span class="n">cc2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;##############################&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Atom type transformation&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atom that needs to be transformed: </span><span class="si">{</span><span class="n">atom1</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atom type of atom in cc1: </span><span class="si">{</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Template atom: </span><span class="si">{</span><span class="n">atom2</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atom type of atom in cc2: </span><span class="si">{</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">bonded_terms_mutation</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">cc1</span><span class="p">,</span> <span class="n">cc2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_common_core_idx_mol1</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_common_core_idx_mol2</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="n">atom1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge_compensated_ligand1_psf</span><span class="p">[</span><span class="n">cc1</span><span class="p">]</span>
            <span class="n">atom2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge_compensated_ligand2_psf</span><span class="p">[</span><span class="n">cc2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">charge</span> <span class="o">!=</span> <span class="n">atom2</span><span class="o">.</span><span class="n">charge</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;##############################&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Charge transformation&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Charge needs to be transformed on common core&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atom that needs to be transformed: </span><span class="si">{</span><span class="n">atom1</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atom charge of atom in cc1: </span><span class="si">{</span><span class="n">atom1</span><span class="o">.</span><span class="n">charge</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Template atom: </span><span class="si">{</span><span class="n">atom2</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atom charge of atom in cc2: </span><span class="si">{</span><span class="n">atom2</span><span class="o">.</span><span class="n">charge</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">charge_mutation</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># if necessary transform bonded parameters</span>
        <span class="k">if</span> <span class="n">bonded_terms_mutation</span> <span class="ow">or</span> <span class="n">charge_mutation</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bonded parameters mutation: </span><span class="si">{</span><span class="n">bonded_terms_mutation</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Charge parameters mutation: </span><span class="si">{</span><span class="n">charge_mutation</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">CommonCoreTransformation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_common_core_idx_mol1</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_region_cc1</span><span class="o">.</span><span class="n">lj_default</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_common_core_idx_mol2</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_region_cc2</span><span class="o">.</span><span class="n">lj_default</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psfs</span><span class="p">[</span><span class="s2">&quot;m1&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psfs</span><span class="p">[</span><span class="s2">&quot;m2&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">s1_tlc</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">s2_tlc</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">charge_compensated_ligand2_psf</span><span class="p">,</span>
                <span class="n">charge_mutation</span><span class="o">=</span><span class="n">charge_mutation</span><span class="p">,</span>
                <span class="n">bonded_terms_mutation</span><span class="o">=</span><span class="n">bonded_terms_mutation</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">transformations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No transformations needed.&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;</span><span class="p">)</span>
            <span class="n">transformations</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">transformations</span></div>

<div class="viewcode-block" id="ProposeMutationRoute._find_terminal_atom"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute._find_terminal_atom">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_find_terminal_atom</span><span class="p">(</span><span class="n">cc_idx</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">mol</span><span class="p">:</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find atoms that connect the molecule to the common core.</span>

<span class="sd">        Args:</span>
<span class="sd">            cc_idx (list): common core index atoms</span>
<span class="sd">            mol ([type]): rdkit mol object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">terminal_dummy_atoms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">terminal_real_atoms</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cc_idx</span><span class="p">:</span>
                <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetNeighbors</span><span class="p">()]</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">n</span> <span class="ow">in</span> <span class="n">cc_idx</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">]):</span>
                    <span class="n">terminal_dummy_atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">cc_idx</span><span class="p">:</span>
                <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetNeighbors</span><span class="p">()]</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cc_idx</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">]):</span>
                    <span class="n">terminal_real_atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Terminal dummy atoms: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">terminal_dummy_atoms</span><span class="p">)))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Terminal real atoms: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">terminal_real_atoms</span><span class="p">)))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">terminal_dummy_atoms</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">terminal_real_atoms</span><span class="p">)))</span></div>

<div class="viewcode-block" id="ProposeMutationRoute._mutate_to_common_core"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.ProposeMutationRoute._mutate_to_common_core">[docs]</a>    <span class="k">def</span> <span class="nf">_mutate_to_common_core</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dummy_region</span><span class="p">:</span> <span class="n">DummyRegion</span><span class="p">,</span> <span class="n">cc_idx</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">mol_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function - do not call directly.</span>
<span class="sd">        Generates the mutation route to the common fore for mol.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

        <span class="c1"># copy of the currently used psf</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psfs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mol_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>

        <span class="n">mutations</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="c1"># get the atom that connects the common core to the dummy regiom</span>
        <span class="n">match_termin_real_and_dummy_atoms</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dummy_region</span><span class="o">.</span><span class="n">match_termin_real_and_dummy_atoms</span>
        <span class="p">)</span>
        <span class="c1"># get the terminal dummy atoms</span>
        <span class="n">list_termin_dummy_atoms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">match_termin_real_and_dummy_atoms</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">list_termin_dummy_atoms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Terminal dummy atoms: </span><span class="si">{</span><span class="n">list_termin_dummy_atoms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">tlc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s1_tlc</span>
        <span class="k">if</span> <span class="n">mol_name</span> <span class="o">==</span> <span class="s2">&quot;m2&quot;</span><span class="p">:</span>
            <span class="n">tlc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2_tlc</span>

        <span class="c1"># iterate through atoms and select atoms that need to be mutated</span>
        <span class="n">atoms_to_be_mutated</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hydrogens</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">psf</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">tlc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="c1"># idx = atom.idx - self.offset</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">idx</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cc_idx</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">list_termin_dummy_atoms</span><span class="p">:</span>
                    <span class="n">hydrogens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">atoms_to_be_mutated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Will be decoupled: Idx:</span><span class="si">{}</span><span class="s2"> Element:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">atoms_to_be_mutated</span><span class="p">:</span>
            <span class="c1">############################################</span>
            <span class="c1">############################################</span>
            <span class="c1"># charge mutation</span>
            <span class="c1">############################################</span>
            <span class="c1">############################################</span>

            <span class="n">m</span> <span class="o">=</span> <span class="n">MutationDefinition</span><span class="p">(</span>
                <span class="n">atoms_to_be_mutated</span><span class="o">=</span><span class="n">atoms_to_be_mutated</span><span class="p">,</span>
                <span class="n">common_core</span><span class="o">=</span><span class="n">cc_idx</span><span class="p">,</span>
                <span class="n">dummy_region</span><span class="o">=</span><span class="n">dummy_region</span><span class="p">,</span>
                <span class="n">vdw_atom_idx</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">steric_mutation_to_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">mutations</span><span class="p">[</span><span class="s2">&quot;charge&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

            <span class="c1">############################################</span>
            <span class="c1">############################################</span>
            <span class="c1"># LJ mutation</span>
            <span class="c1">############################################</span>
            <span class="c1">############################################</span>

            <span class="c1"># start with mutation of LJ of hydrogens</span>
            <span class="c1"># Only take hydrogens that are not terminal hydrogens</span>
            <span class="k">if</span> <span class="n">hydrogens</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">MutationDefinition</span><span class="p">(</span>
                    <span class="n">atoms_to_be_mutated</span><span class="o">=</span><span class="n">atoms_to_be_mutated</span><span class="p">,</span>
                    <span class="n">common_core</span><span class="o">=</span><span class="n">cc_idx</span><span class="p">,</span>
                    <span class="n">dummy_region</span><span class="o">=</span><span class="n">dummy_region</span><span class="p">,</span>
                    <span class="n">vdw_atom_idx</span><span class="o">=</span><span class="n">hydrogens</span><span class="p">,</span>
                    <span class="n">steric_mutation_to_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">mutations</span><span class="p">[</span><span class="s2">&quot;hydrogen-lj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">dummy_region</span><span class="o">.</span><span class="n">connected_dummy_regions</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="n">region</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">atom_idx</span> <span class="ow">in</span> <span class="n">list_termin_dummy_atoms</span>
                        <span class="ow">and</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="n">dummy_region</span><span class="o">.</span><span class="n">lj_default</span>
                    <span class="p">):</span>
                        <span class="c1"># test if atom is a terminal atom and there is a corresponding atom on the other cc</span>
                        <span class="c1"># in this case the atom needs to become a default lj particle</span>
                        <span class="n">m</span> <span class="o">=</span> <span class="n">MutationDefinition</span><span class="p">(</span>
                            <span class="n">atoms_to_be_mutated</span><span class="o">=</span><span class="n">atoms_to_be_mutated</span><span class="p">,</span>
                            <span class="n">common_core</span><span class="o">=</span><span class="n">cc_idx</span><span class="p">,</span>
                            <span class="n">dummy_region</span><span class="o">=</span><span class="n">dummy_region</span><span class="p">,</span>
                            <span class="n">vdw_atom_idx</span><span class="o">=</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">],</span>
                            <span class="n">steric_mutation_to_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">mutations</span><span class="p">[</span><span class="s2">&quot;default-lj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="n">hydrogens</span><span class="p">:</span>
                        <span class="c1"># already mutated</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># normal lj mutation</span>
                        <span class="n">m</span> <span class="o">=</span> <span class="n">MutationDefinition</span><span class="p">(</span>
                            <span class="n">atoms_to_be_mutated</span><span class="o">=</span><span class="n">atoms_to_be_mutated</span><span class="p">,</span>
                            <span class="n">common_core</span><span class="o">=</span><span class="n">cc_idx</span><span class="p">,</span>
                            <span class="n">dummy_region</span><span class="o">=</span><span class="n">dummy_region</span><span class="p">,</span>
                            <span class="n">vdw_atom_idx</span><span class="o">=</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">],</span>
                            <span class="n">steric_mutation_to_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">mutations</span><span class="p">[</span><span class="s2">&quot;lj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;No atoms will be decoupled.&quot;</span><span class="p">)</span>
            <span class="n">mutations</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">mutations</span></div></div>


<div class="viewcode-block" id="CommonCoreTransformation"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.CommonCoreTransformation">[docs]</a><span class="k">class</span> <span class="nc">CommonCoreTransformation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="CommonCoreTransformation.__init__"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.CommonCoreTransformation.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cc1_indicies</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">cc2_indicies</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">ligand1_psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span><span class="p">,</span>
        <span class="n">ligand2_psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span><span class="p">,</span>
        <span class="n">tlc_cc1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tlc_cc2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">charge_compensated_ligand2_psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span><span class="p">,</span>
        <span class="n">charge_mutation</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">bonded_terms_mutation</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scale the bonded parameters inside the common core.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cc1_indicies : list</span>
<span class="sd">            indices of cc1</span>
<span class="sd">        cc2_indicies : list</span>
<span class="sd">            indices of cc2 (in the same order as cc1)</span>
<span class="sd">        ligand1_psf : pm.charmm.CharmmPsfFile (copy of only ligand)</span>
<span class="sd">        ligand2_psf : pm.charmm.CharmmPsfFile (copy of only ligand)</span>
<span class="sd">            the target psf that is used to generate the new bonded parmaeters</span>
<span class="sd">        tlc_cc1 : str</span>
<span class="sd">            three letter code of ligand in cc1</span>
<span class="sd">        tlc_cc2 : str</span>
<span class="sd">            three letter code of ligand in cc2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cc1_indicies</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">cc1_indicies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cc2_indicies</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">cc2_indicies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ligand2_psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span> <span class="o">=</span> <span class="n">ligand2_psf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ligand1_psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span> <span class="o">=</span> <span class="n">ligand1_psf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tlc_cc1</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">tlc_cc1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tlc_cc2</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">tlc_cc2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom_names_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_atom_mapping</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge_mutation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">charge_mutation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonded_terms_mutation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">bonded_terms_mutation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge_compensated_ligand2_psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">charge_compensated_ligand2_psf</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bonded terms mutation: </span><span class="si">{</span><span class="n">bonded_terms_mutation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Charge mutation: </span><span class="si">{</span><span class="n">charge_mutation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CommonCoreTransformation._get_atom_mapping"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.CommonCoreTransformation._get_atom_mapping">[docs]</a>    <span class="k">def</span> <span class="nf">_get_atom_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _get_atom_mapping -- match the atom names of the common cores</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        [dict]</span>
<span class="sd">            matched common core atom names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Prepare Variables to use for restraint cc checks</span>
        <span class="k">global</span> <span class="n">cc_names_struc1</span><span class="p">,</span> <span class="n">cc_names_struc2</span>
        <span class="n">cc_names_struc1</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">cc_names_struc2</span><span class="o">=</span><span class="p">[]</span>


        <span class="c1"># match atomes in common cores</span>
        <span class="n">match_atom_names_cc1_to_cc2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cc1_idx</span><span class="p">,</span> <span class="n">cc2_idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc1_indicies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc2_indicies</span><span class="p">):</span>
            <span class="n">ligand1_atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ligand1_psf</span><span class="p">[</span><span class="n">cc1_idx</span><span class="p">]</span>
            <span class="n">ligand2_atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ligand2_psf</span><span class="p">[</span><span class="n">cc2_idx</span><span class="p">]</span>
            <span class="n">match_atom_names_cc1_to_cc2</span><span class="p">[</span><span class="n">ligand1_atom</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ligand2_atom</span><span class="o">.</span><span class="n">name</span>

            <span class="n">cc_names_struc1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ligand1_atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">cc_names_struc2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ligand2_atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CC Struc1: </span><span class="si">{</span><span class="n">cc_names_struc1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CC Struc2: </span><span class="si">{</span><span class="n">cc_names_struc2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">match_atom_names_cc1_to_cc2</span></div>

        
    <span class="k">def</span> <span class="nf">_mutate_charges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>

        <span class="c1"># common core of psf 1 is transformed to psf 2</span>
        <span class="k">for</span> <span class="n">ligand1_atom</span> <span class="ow">in</span> <span class="n">psf</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tlc_cc1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">ligand1_atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_names_mapping</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># compare to charge compenstated psf 2</span>
            <span class="k">for</span> <span class="n">ligand2_atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge_compensated_ligand2_psf</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_names_mapping</span><span class="p">[</span><span class="n">ligand1_atom</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="n">ligand2_atom</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># are the atoms different?</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Modifying atom: </span><span class="si">{</span><span class="n">ligand1_atom</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Template atom: </span><span class="si">{</span><span class="n">ligand2_atom</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># scale epsilon</span>
                    <span class="n">modified_charge</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">scale</span> <span class="o">*</span> <span class="n">ligand1_atom</span><span class="o">.</span><span class="n">charge</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">scale</span><span class="p">)</span> <span class="o">*</span> <span class="n">ligand2_atom</span><span class="o">.</span><span class="n">charge</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Current charge: </span><span class="si">{</span><span class="n">ligand1_atom</span><span class="o">.</span><span class="n">charge</span><span class="si">}</span><span class="s2">; target charge: </span><span class="si">{</span><span class="n">ligand2_atom</span><span class="o">.</span><span class="n">charge</span><span class="si">}</span><span class="s2">; modified charge: </span><span class="si">{</span><span class="n">modified_charge</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">ligand1_atom</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">modified_charge</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No corresponding atom in cc2 found&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CommonCoreTransformation._mutate_atoms"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.CommonCoreTransformation._mutate_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">_mutate_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span><span class="p">,</span> <span class="n">lambda_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        mutate atom types.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            if common core atoms can not be matched</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># what will be changed</span>
        <span class="n">mod_type</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Atom&quot;</span><span class="p">,</span> <span class="s2">&quot;epsilon, rmin&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;#######################&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;mutate_atoms&quot;</span><span class="p">)</span>

        <span class="c1"># iterate through the atoms of the ligand of system1</span>
        <span class="k">for</span> <span class="n">ligand1_atom</span> <span class="ow">in</span> <span class="n">psf</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tlc_cc1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]:</span>
            <span class="c1"># continue if not in atom_names_mapping</span>
            <span class="k">if</span> <span class="n">ligand1_atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_names_mapping</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># iterate through the atoms the ligand of system2</span>
            <span class="k">for</span> <span class="n">ligand2_atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ligand2_psf</span><span class="p">:</span>
                <span class="c1"># is there a match up?</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_names_mapping</span><span class="p">[</span><span class="n">ligand1_atom</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="n">ligand2_atom</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># are the atoms different?</span>
                    <span class="k">if</span> <span class="n">ligand1_atom</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ligand2_atom</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;DDX&quot;</span> <span class="ow">in</span> <span class="n">ligand1_atom</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s2">&quot;This is the terminal LJ atom. If everything went correct, this does not have to change atom types.&quot;</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_modify_type_in_cc</span><span class="p">(</span><span class="n">ligand1_atom</span><span class="p">,</span> <span class="n">psf</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Modifying atom: </span><span class="si">{</span><span class="n">ligand1_atom</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Template atom: </span><span class="si">{</span><span class="n">ligand2_atom</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                            <span class="c1"># scale epsilon</span>
                            <span class="n">modified_epsilon</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">lambda_value</span> <span class="o">*</span> <span class="n">ligand1_atom</span><span class="o">.</span><span class="n">epsilon</span>
                                <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">lambda_value</span><span class="p">)</span> <span class="o">*</span> <span class="n">ligand2_atom</span><span class="o">.</span><span class="n">epsilon</span>
                            <span class="p">)</span>

                            <span class="c1"># scale rmin</span>
                            <span class="n">modified_rmin</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">lambda_value</span> <span class="o">*</span> <span class="n">ligand1_atom</span><span class="o">.</span><span class="n">rmin</span>
                                <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">lambda_value</span><span class="p">)</span> <span class="o">*</span> <span class="n">ligand2_atom</span><span class="o">.</span><span class="n">rmin</span>
                            <span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Original LJ: eps: </span><span class="si">{</span><span class="n">ligand1_atom</span><span class="o">.</span><span class="n">epsilon</span><span class="si">}</span><span class="s2">; rmin: </span><span class="si">{</span><span class="n">ligand1_atom</span><span class="o">.</span><span class="n">rmin</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;New LJ: eps: </span><span class="si">{</span><span class="n">modified_epsilon</span><span class="si">}</span><span class="s2">; rmin: </span><span class="si">{</span><span class="n">modified_rmin</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="n">ligand1_atom</span><span class="o">.</span><span class="n">mod_type</span> <span class="o">=</span> <span class="n">mod_type</span><span class="p">(</span>
                                <span class="n">modified_epsilon</span><span class="p">,</span> <span class="n">modified_rmin</span>
                            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No corresponding atom in cc2 found&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_mutate_bonds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span><span class="p">,</span> <span class="n">lambda_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;#######################&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;mutate_bonds&quot;</span><span class="p">)</span>

        <span class="n">mod_type</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Bond&quot;</span><span class="p">,</span> <span class="s2">&quot;k, req&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ligand1_bond</span> <span class="ow">in</span> <span class="n">psf</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tlc_cc1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>

            <span class="n">ligand1_atom1_name</span> <span class="o">=</span> <span class="n">ligand1_bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">name</span>
            <span class="n">ligand1_atom2_name</span> <span class="o">=</span> <span class="n">ligand1_bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">name</span>
            <span class="c1"># all atoms of the bond must be in cc</span>
            <span class="c1"># everything outside the cc are bonded terms between dummies or</span>
            <span class="c1"># between real atoms and dummies and we can ignore them for now</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
                <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_names_mapping</span>
                <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ligand1_atom1_name</span><span class="p">,</span> <span class="n">ligand1_atom2_name</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">ligand2_bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ligand2_psf</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                <span class="n">ligand2_atom1_name</span> <span class="o">=</span> <span class="n">ligand2_bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">name</span>
                <span class="n">ligand2_atom2_name</span> <span class="o">=</span> <span class="n">ligand2_bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">name</span>
                <span class="c1"># all atoms of the bond must be in cc</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_names_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ligand2_atom1_name</span><span class="p">,</span> <span class="n">ligand2_atom2_name</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="k">continue</span>

                <span class="c1"># match the two bonds</span>
                <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">atom_names_mapping</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ligand1_atom1_name</span><span class="p">,</span> <span class="n">ligand1_atom2_name</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="p">)</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">ligand2_atom1_name</span><span class="p">,</span> <span class="n">ligand2_atom2_name</span><span class="p">]):</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># are the bonds different?</span>
                    <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">ligand1_bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">ligand1_bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">ligand2_bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">ligand2_bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">]):</span>
                        <span class="k">continue</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Modifying bond: </span><span class="si">{</span><span class="n">ligand1_bond</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Template bond: </span><span class="si">{</span><span class="n">ligand2_bond</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">modified_k</span> <span class="o">=</span> <span class="p">(</span><span class="n">lambda_value</span> <span class="o">*</span> <span class="n">ligand1_bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">lambda_value</span><span class="p">)</span> <span class="o">*</span> <span class="n">ligand2_bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span>
                    <span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Current k: </span><span class="si">{</span><span class="n">ligand1_bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="si">}</span><span class="s2">; target k: </span><span class="si">{</span><span class="n">ligand2_bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="si">}</span><span class="s2">; new k: </span><span class="si">{</span><span class="n">modified_k</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                    <span class="c1"># interpolating from ligand1 (original) to ligand2 (new) bond parameters</span>
                    <span class="n">modified_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">lambda_value</span> <span class="o">*</span> <span class="n">ligand1_bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">lambda_value</span><span class="p">)</span> <span class="o">*</span> <span class="n">ligand2_bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span>
                    <span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Current req: </span><span class="si">{</span><span class="n">ligand1_bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span><span class="si">}</span><span class="s2">; target req: </span><span class="si">{</span><span class="n">ligand2_bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span><span class="si">}</span><span class="s2">; new req: </span><span class="si">{</span><span class="n">modified_req</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                    <span class="n">ligand1_bond</span><span class="o">.</span><span class="n">mod_type</span> <span class="o">=</span> <span class="n">mod_type</span><span class="p">(</span><span class="n">modified_k</span><span class="p">,</span> <span class="n">modified_req</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ligand1_bond</span><span class="o">.</span><span class="n">mod_type</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">ligand1_bond</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;No corresponding bond in cc2 found: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ligand1_bond</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mutate_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span><span class="p">,</span> <span class="n">lambda_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>

        <span class="n">mod_type</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Angle&quot;</span><span class="p">,</span> <span class="s2">&quot;k, theteq&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cc1_angle</span> <span class="ow">in</span> <span class="n">psf</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tlc_cc1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
            <span class="n">ligand1_atom1_name</span> <span class="o">=</span> <span class="n">cc1_angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">name</span>
            <span class="n">ligand1_atom2_name</span> <span class="o">=</span> <span class="n">cc1_angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">name</span>
            <span class="n">cc1_a3</span> <span class="o">=</span> <span class="n">cc1_angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">name</span>

            <span class="c1"># only angles in cc</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
                <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_names_mapping</span>
                <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ligand1_atom1_name</span><span class="p">,</span> <span class="n">ligand1_atom2_name</span><span class="p">,</span> <span class="n">cc1_a3</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">cc2_angle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ligand2_psf</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
                <span class="n">ligand2_atom1_name</span> <span class="o">=</span> <span class="n">cc2_angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">name</span>
                <span class="n">ligand2_atom2_name</span> <span class="o">=</span> <span class="n">cc2_angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">name</span>
                <span class="n">cc2_a3</span> <span class="o">=</span> <span class="n">cc2_angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">name</span>
                <span class="c1"># only angles in cc</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_names_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ligand2_atom1_name</span><span class="p">,</span> <span class="n">ligand2_atom2_name</span><span class="p">,</span> <span class="n">cc2_a3</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">atom_names_mapping</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ligand1_atom1_name</span><span class="p">,</span> <span class="n">ligand1_atom2_name</span><span class="p">,</span> <span class="n">cc1_a3</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="p">)</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">ligand2_atom1_name</span><span class="p">,</span> <span class="n">ligand2_atom2_name</span><span class="p">,</span> <span class="n">cc2_a3</span><span class="p">]):</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">cc1_angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                            <span class="n">cc1_angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                            <span class="n">cc1_angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">)</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">cc2_angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                            <span class="n">cc2_angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                            <span class="n">cc2_angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Modifying angle: </span><span class="si">{</span><span class="n">cc1_angle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Template bond: </span><span class="si">{</span><span class="n">cc2_angle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Scaling k and theteq&quot;</span><span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Old k: </span><span class="si">{</span><span class="n">cc1_angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">modified_k</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">lambda_value</span> <span class="o">*</span> <span class="n">cc1_angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span>
                        <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">lambda_value</span><span class="p">)</span> <span class="o">*</span> <span class="n">cc2_angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New k: </span><span class="si">{</span><span class="n">modified_k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Old k: </span><span class="si">{</span><span class="n">cc1_angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">theteq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">modified_theteq</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">lambda_value</span> <span class="o">*</span> <span class="n">cc1_angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">theteq</span>
                        <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">lambda_value</span><span class="p">)</span> <span class="o">*</span> <span class="n">cc2_angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">theteq</span>
                    <span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New k: </span><span class="si">{</span><span class="n">modified_theteq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">cc1_angle</span><span class="o">.</span><span class="n">mod_type</span> <span class="o">=</span> <span class="n">mod_type</span><span class="p">(</span><span class="n">modified_k</span><span class="p">,</span> <span class="n">modified_theteq</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">cc1_angle</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No corresponding angle in cc2 found&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mutate_torsions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span><span class="p">,</span> <span class="n">lambda_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>

        <span class="n">mod_type</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Torsion&quot;</span><span class="p">,</span> <span class="s2">&quot;phi_k, per, phase, scee, scnb&quot;</span><span class="p">)</span>

        <span class="c1"># get all torsions present in initial topology</span>
        <span class="k">for</span> <span class="n">original_torsion</span> <span class="ow">in</span> <span class="n">psf</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tlc_cc1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>

            <span class="n">found</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">original_atom1_name</span> <span class="o">=</span> <span class="n">original_torsion</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">name</span>
            <span class="n">original_atom2_name</span> <span class="o">=</span> <span class="n">original_torsion</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">name</span>
            <span class="n">original_atom3_name</span> <span class="o">=</span> <span class="n">original_torsion</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">name</span>
            <span class="n">original_atom4_name</span> <span class="o">=</span> <span class="n">original_torsion</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">name</span>
            <span class="c1"># all atoms must be in the cc</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
                <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_names_mapping</span>
                <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="n">original_atom1_name</span><span class="p">,</span>
                    <span class="n">original_atom2_name</span><span class="p">,</span>
                    <span class="n">original_atom3_name</span><span class="p">,</span>
                    <span class="n">original_atom4_name</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># get corresponding torsion types in the new topology</span>
            <span class="k">for</span> <span class="n">new_torsion</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ligand2_psf</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
                <span class="n">new_atom1_name</span> <span class="o">=</span> <span class="n">new_torsion</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">name</span>
                <span class="n">new_atom2_name</span> <span class="o">=</span> <span class="n">new_torsion</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">name</span>
                <span class="n">new_atom3_name</span> <span class="o">=</span> <span class="n">new_torsion</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">name</span>
                <span class="n">new_atom4_name</span> <span class="o">=</span> <span class="n">new_torsion</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">name</span>
                <span class="c1"># only torsion in cc</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_names_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="n">new_atom1_name</span><span class="p">,</span>
                        <span class="n">new_atom2_name</span><span class="p">,</span>
                        <span class="n">new_atom3_name</span><span class="p">,</span>
                        <span class="n">new_atom4_name</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">):</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">atom_names_mapping</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="n">original_atom1_name</span><span class="p">,</span>
                            <span class="n">original_atom2_name</span><span class="p">,</span>
                            <span class="n">original_atom3_name</span><span class="p">,</span>
                            <span class="n">original_atom4_name</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">]</span>
                <span class="p">)</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">new_atom1_name</span><span class="p">,</span> <span class="n">new_atom2_name</span><span class="p">,</span> <span class="n">new_atom3_name</span><span class="p">,</span> <span class="n">new_atom4_name</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">original_torsion</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                            <span class="n">original_torsion</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                            <span class="n">original_torsion</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                            <span class="n">original_torsion</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">)</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">new_torsion</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                            <span class="n">new_torsion</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                            <span class="n">new_torsion</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                            <span class="n">new_torsion</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="n">mod_types</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># torsion present at cc1 needs to be turned fully off starting at lambda_vlaue == 1.</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lambda_value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span> <span class="mf">0.0</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">lambda_value</span> <span class="o">==</span> <span class="mf">0.5</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">torsion_t</span> <span class="ow">in</span> <span class="n">original_torsion</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                            <span class="n">modified_phi_k</span> <span class="o">=</span> <span class="n">torsion_t</span><span class="o">.</span><span class="n">phi_k</span> <span class="o">*</span> <span class="n">f</span>
                            <span class="n">mod_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">mod_type</span><span class="p">(</span>
                                    <span class="n">modified_phi_k</span><span class="p">,</span>
                                    <span class="n">torsion_t</span><span class="o">.</span><span class="n">per</span><span class="p">,</span>
                                    <span class="n">torsion_t</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span>
                                    <span class="n">torsion_t</span><span class="o">.</span><span class="n">scee</span><span class="p">,</span>
                                    <span class="n">torsion_t</span><span class="o">.</span><span class="n">scnb</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">)</span>

                    <span class="c1"># torsion present at cc2 needs to be fully turned on at lambda_value == 0.0</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">min</span><span class="p">((</span><span class="n">lambda_value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">torsion_t</span> <span class="ow">in</span> <span class="n">new_torsion</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                            <span class="n">modified_phi_k</span> <span class="o">=</span> <span class="n">torsion_t</span><span class="o">.</span><span class="n">phi_k</span> <span class="o">*</span> <span class="n">f</span>
                            <span class="k">if</span> <span class="n">modified_phi_k</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                                <span class="n">mod_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="n">mod_type</span><span class="p">(</span>
                                        <span class="n">modified_phi_k</span><span class="p">,</span>
                                        <span class="n">torsion_t</span><span class="o">.</span><span class="n">per</span><span class="p">,</span>
                                        <span class="n">torsion_t</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span>
                                        <span class="n">torsion_t</span><span class="o">.</span><span class="n">scee</span><span class="p">,</span>
                                        <span class="n">torsion_t</span><span class="o">.</span><span class="n">scnb</span><span class="p">,</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>

                    <span class="n">original_torsion</span><span class="o">.</span><span class="n">mod_type</span> <span class="o">=</span> <span class="n">mod_types</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">original_torsion</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No corresponding torsion in cc2 found&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CommonCoreTransformation.mutate"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.CommonCoreTransformation.mutate">[docs]</a>    <span class="k">def</span> <span class="nf">mutate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span><span class="p">,</span> <span class="n">lambda_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mutates the bonded parameters of cc1 to cc2.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        psf : pm.charmm.CharmmPsfFile</span>
<span class="sd">            psf that gets mutated</span>
<span class="sd">        lambda_value : float</span>
<span class="sd">            lambda_value</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span> <span class="o">==</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge_mutation</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; -- Charge parameters from cc1 are transformed to cc2.&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lambda value:</span><span class="si">{</span><span class="n">lambda_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># scale charge</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mutate_charges</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">lambda_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonded_terms_mutation</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot; -- Atom/Bond/Angle/Torsion parameters from cc1 are transformed to cc2.&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lambda value:</span><span class="si">{</span><span class="n">lambda_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># scale atoms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mutate_atoms</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">lambda_value</span><span class="p">)</span>
            <span class="c1"># scale bonds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mutate_bonds</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">lambda_value</span><span class="p">)</span>
            <span class="c1"># scale angles</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mutate_angles</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">lambda_value</span><span class="p">)</span>
            <span class="c1"># scale torsions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mutate_torsions</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">lambda_value</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_modify_type_in_cc</span><span class="p">(</span><span class="n">atom</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">Atom</span><span class="p">,</span> <span class="n">psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="s2">&quot;initial_type&quot;</span><span class="p">):</span>
            <span class="c1"># only change parameters</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting RRR atomtype for atom: </span><span class="si">{</span><span class="n">atom</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">initial_type</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">type</span>
            <span class="n">psf</span><span class="o">.</span><span class="n">number_of_dummys</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;RRR</span><span class="si">{</span><span class="n">psf</span><span class="o">.</span><span class="n">number_of_dummys</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="Mutation"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.Mutation">[docs]</a><span class="k">class</span> <span class="nc">Mutation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="Mutation.__init__"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.Mutation.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms_to_be_mutated</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">dummy_region</span><span class="p">:</span> <span class="n">DummyRegion</span><span class="p">):</span>

        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">atoms_to_be_mutated</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms_to_be_mutated</span> <span class="o">=</span> <span class="n">atoms_to_be_mutated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dummy_region</span> <span class="o">=</span> <span class="n">dummy_region</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tlc</span> <span class="o">=</span> <span class="n">dummy_region</span><span class="o">.</span><span class="n">tlc</span></div>

    <span class="k">def</span> <span class="nf">_mutate_charge</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span><span class="p">,</span> <span class="n">lambda_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">):</span>

        <span class="n">total_charge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="nb">round</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">initial_charge</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">psf</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tlc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">]))</span>
        <span class="p">)</span>
        <span class="c1"># scale the charge of all atoms</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scaling charge on: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_to_be_mutated</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_to_be_mutated</span><span class="p">:</span>
            <span class="n">odx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">offset</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="n">psf</span><span class="p">[</span><span class="n">odx</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scale charge on </span><span class="si">{</span><span class="n">atom</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scaling charge with: </span><span class="si">{</span><span class="n">lambda_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Old charge: </span><span class="si">{</span><span class="n">atom</span><span class="o">.</span><span class="n">charge</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">initial_charge</span> <span class="o">*</span> <span class="n">lambda_value</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New charge: </span><span class="si">{</span><span class="n">atom</span><span class="o">.</span><span class="n">charge</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lambda_value</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># compensate for the total change in charge the terminal atom</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compensate_charge</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">total_charge</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mutate_vdw</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span><span class="p">,</span>
        <span class="n">lambda_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">vdw_atom_idx</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">to_default</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">vdw_atom_idx</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_to_be_mutated</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Specified atom </span><span class="si">{</span><span class="n">vdw_atom_idx</span><span class="si">}</span><span class="s2"> is not in atom_idx list </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_to_be_mutated</span><span class="si">}</span><span class="s2">. Aborting.&quot;</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Acting on atoms: </span><span class="si">{</span><span class="n">vdw_atom_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">idx</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">psf</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vdw_atom_idx</span><span class="p">:</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="n">psf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">offset</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">to_default</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Mutate to default&quot;</span><span class="p">)</span>
                <span class="n">atom_type_suffix</span> <span class="o">=</span> <span class="s2">&quot;DDX&quot;</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">rmin</span> <span class="o">=</span> <span class="mf">1.5</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.15</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Mutate to dummy&quot;</span><span class="p">)</span>
                <span class="n">atom_type_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;DDD&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scale_epsilon</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">lambda_value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scale_rmin</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">lambda_value</span><span class="p">)</span>
            <span class="c1"># NOTEthere is always a type change</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_modify_type</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">atom_type_suffix</span><span class="p">)</span>

<div class="viewcode-block" id="Mutation.mutate"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.Mutation.mutate">[docs]</a>    <span class="k">def</span> <span class="nf">mutate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span><span class="p">,</span>
        <span class="n">lambda_value_electrostatic</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">lambda_value_vdw</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">vdw_atom_idx</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">steric_mutation_to_default</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs the mutation&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">lambda_value_electrostatic</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">lambda_value_electrostatic</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Lambda value for LJ needs to be between 0.0 and 1.0.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lambda_value_vdw</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">lambda_value_vdw</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Lambda value for vdw needs to be between 0.0 and 1.0.&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LJ scaling factor: </span><span class="si">{</span><span class="n">lambda_value_electrostatic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VDW scaling factor: </span><span class="si">{</span><span class="n">lambda_value_vdw</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">offset</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">idx</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">psf</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">lambda_value_electrostatic</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mutate_charge</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">lambda_value_electrostatic</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lambda_value_vdw</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mutate_vdw</span><span class="p">(</span>
                <span class="n">psf</span><span class="p">,</span> <span class="n">lambda_value_vdw</span><span class="p">,</span> <span class="n">vdw_atom_idx</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">steric_mutation_to_default</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Mutation._compensate_charge"><a class="viewcode-back" href="../../autosummary/transformato.mutate.html#transformato.mutate.Mutation._compensate_charge">[docs]</a>    <span class="k">def</span> <span class="nf">_compensate_charge</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">psf</span><span class="p">:</span> <span class="n">pm</span><span class="o">.</span><span class="n">charmm</span><span class="o">.</span><span class="n">CharmmPsfFile</span><span class="p">,</span> <span class="n">total_charge</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _compensate_charge This function compensates the charge changes of a dummy region on the terminal real atom</span>
<span class="sd">        that connects the specific dummy group to the real region.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        psf : pm.charmm.CharmmPsfFile</span>
<span class="sd">            [description]</span>
<span class="sd">        total_charge : int</span>
<span class="sd">            [description]</span>
<span class="sd">        offset : int</span>
<span class="sd">            [description]</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            [description]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get dummy retions</span>
        <span class="n">connected_dummy_regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_region</span><span class="o">.</span><span class="n">connected_dummy_regions</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compensating charge ...&quot;</span><span class="p">)</span>
        <span class="c1"># save the atoms that are used for charge compenstation. This is done because if two regions</span>
        <span class="c1"># use the same atom, a special handling needs to be invoced</span>
        <span class="n">compensating_on_this_real_atom</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># check for each dummy region how much charge has changed and compensate on atom that connects</span>
        <span class="c1"># the real region with specific dummy regions</span>
        <span class="k">for</span> <span class="n">dummy_idx</span> <span class="ow">in</span> <span class="n">connected_dummy_regions</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dummy idx region: </span><span class="si">{</span><span class="n">dummy_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">connecting_real_atom_for_this_dummy_region</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dummy_region</span><span class="o">.</span><span class="n">return_connecting_real_atom</span><span class="p">(</span><span class="n">dummy_idx</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Connecting atom: </span><span class="si">{</span><span class="n">connecting_real_atom_for_this_dummy_region</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">connecting_real_atom_for_this_dummy_region</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Something went wrong with the charge compensation. Aborting.&quot;</span>
                <span class="p">)</span>

            <span class="n">charge_acceptor</span> <span class="o">=</span> <span class="n">psf</span><span class="p">[</span><span class="n">connecting_real_atom_for_this_dummy_region</span> <span class="o">+</span> <span class="n">offset</span><span class="p">]</span>

            <span class="n">charge_to_compenstate_for_region</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="n">dummy_idx</span><span class="p">:</span>
                <span class="n">charge_to_compenstate_for_region</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">psf</span><span class="p">[</span><span class="n">atom_idx</span> <span class="o">+</span> <span class="n">offset</span><span class="p">]</span><span class="o">.</span><span class="n">initial_charge</span>
                    <span class="o">-</span> <span class="n">psf</span><span class="p">[</span><span class="n">atom_idx</span> <span class="o">+</span> <span class="n">offset</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span>
                <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Charge to compensate: </span><span class="si">{</span><span class="n">charge_to_compenstate_for_region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># adding charge difference to initial charge on real terminal atom</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">connecting_real_atom_for_this_dummy_region</span>
                <span class="ow">in</span> <span class="n">compensating_on_this_real_atom</span>
            <span class="p">):</span>
                <span class="n">charge_acceptor</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">charge_acceptor</span><span class="o">.</span><span class="n">charge</span> <span class="o">+</span> <span class="n">charge_to_compenstate_for_region</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">charge_acceptor</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">charge_acceptor</span><span class="o">.</span><span class="n">initial_charge</span> <span class="o">+</span> <span class="n">charge_to_compenstate_for_region</span>
                <span class="p">)</span>

            <span class="n">compensating_on_this_real_atom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">connecting_real_atom_for_this_dummy_region</span>
            <span class="p">)</span>

        <span class="c1"># check if rest charge is missing</span>
        <span class="n">new_charge</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">charge</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">psf</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tlc</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">new_charge</span><span class="p">,</span> <span class="n">total_charge</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Charge compensation failed. Introducing non integer total charge: </span><span class="si">{</span><span class="n">new_charge</span><span class="si">}</span><span class="s2">. Target total charge: </span><span class="si">{</span><span class="n">total_charge</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_scale_epsilon</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">lambda_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">initial_epsilon</span><span class="p">)</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">initial_epsilon</span> <span class="o">*</span> <span class="n">lambda_value</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_scale_rmin</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">lambda_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">initial_rmin</span><span class="p">)</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">rmin</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">initial_rmin</span> <span class="o">*</span> <span class="n">lambda_value</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_modify_type</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">atom_type_suffix</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="s2">&quot;initial_type&quot;</span><span class="p">):</span>
            <span class="c1"># only change parameters</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">initial_type</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">type</span>
            <span class="k">if</span> <span class="n">atom_type_suffix</span> <span class="o">==</span> <span class="s2">&quot;DDD&quot;</span><span class="p">:</span>
                <span class="n">psf</span><span class="o">.</span><span class="n">number_of_dummys</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">new_type</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atom_type_suffix</span><span class="si">}{</span><span class="n">psf</span><span class="o">.</span><span class="n">number_of_dummys</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">atom_type_suffix</span> <span class="o">==</span> <span class="s2">&quot;DDX&quot;</span><span class="p">:</span>
                <span class="n">psf</span><span class="o">.</span><span class="n">mutations_to_default</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">new_type</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atom_type_suffix</span><span class="si">}{</span><span class="n">psf</span><span class="o">.</span><span class="n">mutations_to_default</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">atom</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">new_type</span></div>


<span class="k">def</span> <span class="nf">mutate_pure_tautomers</span><span class="p">(</span>
    <span class="n">s1_to_s2</span><span class="p">:</span> <span class="n">ProposeMutationRoute</span><span class="p">,</span>
    <span class="n">system1</span><span class="p">:</span> <span class="n">SystemStructure</span><span class="p">,</span>
    <span class="n">system2</span><span class="p">:</span> <span class="n">SystemStructure</span><span class="p">,</span>
    <span class="n">configuration</span><span class="p">,</span>
    <span class="n">single_state</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">nr_of_bonded_windows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">):</span>

    <span class="kn">from</span> <span class="nn">transformato</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">IntermediateStateFactory</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># setup mutation and StateFactory</span>
    <span class="n">mutation_list</span> <span class="o">=</span> <span class="n">s1_to_s2</span><span class="o">.</span><span class="n">generate_mutations_to_common_core_for_mol1</span><span class="p">()</span>
    <span class="n">i_tautomer1</span> <span class="o">=</span> <span class="n">IntermediateStateFactory</span><span class="p">(</span>
        <span class="n">system</span><span class="o">=</span><span class="n">system1</span><span class="p">,</span>
        <span class="n">configuration</span><span class="o">=</span><span class="n">configuration</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># write out states</span>
    <span class="c1"># start with charge</span>
    <span class="n">charges</span> <span class="o">=</span> <span class="n">mutation_list</span><span class="p">[</span><span class="s2">&quot;charge&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">lambda_value</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="c1"># turn off charges</span>
        <span class="n">i_tautomer1</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span>
            <span class="n">mutation_conf</span><span class="o">=</span><span class="n">charges</span><span class="p">,</span>
            <span class="n">lambda_value_electrostatic</span><span class="o">=</span><span class="n">lambda_value</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">single_state</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">i_tautomer1</span><span class="o">.</span><span class="n">output_files</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># turn off the lj of the hydrogen</span>
    <span class="n">lj</span> <span class="o">=</span> <span class="n">mutation_list</span><span class="p">[</span><span class="s2">&quot;lj&quot;</span><span class="p">]</span>
    <span class="n">i_tautomer1</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span>
        <span class="n">mutation_conf</span><span class="o">=</span><span class="n">lj</span><span class="p">,</span>
        <span class="n">lambda_value_vdw</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># transform common core</span>
    <span class="k">for</span> <span class="n">lambda_value</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_of_bonded_windows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="c1"># turn off charges</span>
        <span class="n">i_tautomer1</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span>
            <span class="n">mutation_conf</span><span class="o">=</span><span class="n">mutation_list</span><span class="p">[</span><span class="s2">&quot;transform&quot;</span><span class="p">],</span>
            <span class="n">common_core_transformation</span><span class="o">=</span><span class="n">lambda_value</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># setup other tautomer</span>
    <span class="n">mutation_list</span> <span class="o">=</span> <span class="n">s1_to_s2</span><span class="o">.</span><span class="n">generate_mutations_to_common_core_for_mol2</span><span class="p">()</span>
    <span class="n">i_tautomer2</span> <span class="o">=</span> <span class="n">IntermediateStateFactory</span><span class="p">(</span>
        <span class="n">system</span><span class="o">=</span><span class="n">system2</span><span class="p">,</span>
        <span class="n">configuration</span><span class="o">=</span><span class="n">configuration</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># write out states</span>
    <span class="c1"># start with charge</span>
    <span class="n">charges</span> <span class="o">=</span> <span class="n">mutation_list</span><span class="p">[</span><span class="s2">&quot;charge&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">lambda_value</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="c1"># turn off charges</span>
        <span class="n">i_tautomer2</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span>
            <span class="n">mutation_conf</span><span class="o">=</span><span class="n">charges</span><span class="p">,</span>
            <span class="n">lambda_value_electrostatic</span><span class="o">=</span><span class="n">lambda_value</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># turn off the lj of the hydrogen</span>
    <span class="n">lj</span> <span class="o">=</span> <span class="n">mutation_list</span><span class="p">[</span><span class="s2">&quot;lj&quot;</span><span class="p">]</span>
    <span class="n">i_tautomer2</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span>
        <span class="n">mutation_conf</span><span class="o">=</span><span class="n">lj</span><span class="p">,</span>
        <span class="n">lambda_value_vdw</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">i_tautomer1</span><span class="o">.</span><span class="n">output_files</span><span class="p">,</span> <span class="n">i_tautomer2</span><span class="o">.</span><span class="n">output_files</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Marcus Wieder, Johannes Karwounopoulos, Stefan Boresch. Project structure based on the Computational Molecular Science Python Cookiecutter version 1.1.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>